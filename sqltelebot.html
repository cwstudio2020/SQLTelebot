<!--
SQLTelebot Manager
- This file is part of the SQLTelebot plugin and runs on SQLMessenger.
- SQLMessenger requires that all plugin code be combined into a single HTML file.
- Version: 1.0
- Release Date: May 10, 2025
-->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
  <script type="text/javascript" src="js/jquery/jquery-1.11.3.min.js?ver=2.0.0001"></script> 
  <script type="text/javascript" src="js/jquery/jquery.json-2.4.min.js?ver=2.0.0001"></script> 
  
  <script type="text/javascript" src="plugin/js/common.js?ver=2"></script>
  
  <link rel="stylesheet" type="text/css" href="js/easyui/themes/default/easyui.css?ver=2.0.0001"> 
  <link rel="stylesheet" type="text/css" href="images/easyui-patch.css"> 
  <script type="text/javascript" src="js/easyui/jquery.easyui.o.js?ver=2.0.0001"></script> 
  <script charset="utf-8" type="text/javascript" src="js/easyui/locale/easyui-lang-en.js?ver=2.0.0001"></script> 
  <link rel="stylesheet" type="text/css" href="images/t2e.css">
    <title>Telebot Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #333;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #777;
            font-size: 14px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background-color: #0088cc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo svg {
            width: 50px;
            height: 50px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            max-width: 80%;
            margin: 0 auto;
            flex: 1;
        }
        
        .card {
            background-color: #fff;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 5px 5px rgba(0, 0, 0, 0.06);
        }
        
        .icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #f8f9fa;
        }
        
        .icon svg {
            width: 30px;
            height: 30px;
        }
        
        .card h3 {
            color: #333;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .card p {
            color: #777;
            font-size: 12px;
        }
        
        .footer-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        
        .footer-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .footer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .help-button {
            background-color: #e0f7fa;
        }
        
        /* Icon colors */
        .global-options .icon {
            background-color: #e3f7ff;
        }
        
        .global-options svg path {
            fill: #0088cc;
        }
        
        .bot-config .icon {
            background-color: #e3f2fd;
        }
        
        .bot-config svg path {
            fill: #2196F3;
        }
        
        .send-msg .icon {
            background-color: #e8f5e9;
        }
        
        .send-msg svg path {
            fill: #4CAF50;
        }
        
        .receive-msg .icon {
            background-color: #fff8e1;
        }
        
        .receive-msg svg path {
            fill: #FFC107;
        }
        
        .chat-manage .icon {
            background-color: #f3e5f5;
        }
        
        .chat-manage svg path {
            fill: #9C27B0;
        }
        
        .email-to-telegram .icon {
            background-color: #e8eaf6;
        }
        
        .email-to-telegram svg path {
            fill: #5C6BC0;
        }
        
        .db-config .icon {
            background-color: #e3f2fd;
        }
        
        .db-config svg path {
            fill: #2196F3;
        }
        
        .batch-send .icon {
            background-color: #e8f5e9;
        }
        
        .batch-send svg path {
            fill: #676c98;
        }
        /* UI */
		.help-panel {
			background-color: #fdffdf;
			border-style: none none none solid;
			padding: 5px;
		}
				
		.help-panel .list-item {
			display: list-item;
			list-style: disc;
			margin-left: 17px;
		}
				
		.help-panel .keywords {
			font-weight: 600;
		}
		.footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
        }
        
        .help-link {
            color: #0088cc;
            text-decoration: none;
            font-size: 14px;
        }
        
        .help-link:hover {
            text-decoration: underline;
        }	
		
		
		
		.link {
			color: blue;
			cursor: pointer !important;
		}		
		.status-icon{
			height:25px;
		}
		table {
			font-size: 14px;
		}
		.grid-autowrap .datagrid-cell {
			white-space:normal;
		}
		.help-head{
			margin-left:0px;
		}
		/*BatchSendMessages*/
	    .new-message .icon {
	        background-color: #e8f5e9;
	    }
	        
	    .new-message svg path {
	        fill: #4CAF50;
	    }
	        
	    .history .icon {
	        background-color: #fff8e1;
	    }
	        
	        .history svg path {
	            fill: #FFC107;
	        }
	        
	        .help .icon {
	            background-color: #e0f7fa;
	        }
	        
	        .help svg path {
	            fill: #00BCD4;
	        }
	        
	        .exit .icon {
	            background-color: #ffebee;
	        }
	        
	        .exit svg path {
	            fill: #F44336;
	        }
	        .icon-pause{
	        	background-image:url(images/2.0/pause-icon-size_64.png);
	        }
	        .icon-play{
	        	background-image:url(images/2.0/play-icon-size_64.png);
	        }
    </style>
<script type="text/javascript">
let bulkMessageTipShowed = false;
const createHelpButton20 = function (dialog,target){
	let button = $("<span style='float:left;'></span>");
	dialog.parent().children(".dialog-button").append(button);
	button.linkbutton({
		text: "Help",
		iconCls: "icon-help",
		width: 80,
		id: "btnHelp",
		onClick: typeof(target) == "function"?target:function(){
			window.open(target);
		}
	});
	return button;
}
const HelpStr = {
	"BotConfigEditor.txtBotToken":`
	<p class="help-head"><span class="keywords">Bot Token</span>: Enter your bot's Token here. The system will use this Bot Token to call the Telegram API.</p>
	<p>&nbsp;</p>
	<p class="list-item">Your Bot Token will be encrypted and stored in the PostgreSQL database on your computer (this database is automatically installed by the SQLMessenger installer).</p>
	<p>&nbsp;</p>
	<p class="list-item">The Bot Token will only be displayed once during input and will not be visible afterward.</p>
	<p>&nbsp;</p>
	<p class="list-item"><span class="keywords">After entering the Bot Token</span>, click the <span class="keywords">"Load Bot Info"</span> button. The system will use the provided Token to fetch your bot’s details from Telegram.</p>
	<p>&nbsp;</p>
	<p class="list-item">For more details about Bot Token, visit <a href="https://core.telegram.org/bots/tutorial#obtain-your-bot-token" target="_blank">https://core.telegram.org/bots/tutorial#obtain-your-bot-token</a></p>`,
	"BotConfigEditor.chkFetchMessages":`
	<p class="help-head"><span class="keywords">Automatically fetch messages and save to local database</span>: When this option is enabled, the system will automatically call Telegram's "getUpdates" API to retrieve messages received by this bot.</p>
	<p>&nbsp;</p>
	<p class="list-item">The fetched messages will be stored in a PostgreSQL database on your computer. You can process these messages using other tasks or configure Telebot to forward them to a specified email address.</p>
	<p>&nbsp;</p>
	<p class="list-item">The bot can only retrieve messages sent directly to it. To receive messages from a group or channel, the bot must be added as an administrator in that group or channel.</p>
	<p>&nbsp;</p>
	<p class="list-item">Telebot automatically updates the bot's <span class="keywords">update_id</span> to prevent fetching duplicate messages from Telegram's platform.If other applications are using the same Bot Token to fetch messages, they may fail to retrieve new updates. For details, visit: <a href="https://core.telegram.org/bots/api#getupdates" target="_blank">https://core.telegram.org/bots/api#getupdates</a></p>
	<p>&nbsp;</p>
	`,
	"BotConfigEditor.txtPollingTimeout":`
	<p class="help-head"><span class="keywords">Polling Timeout</span>: Set the timeout duration for each polling attempt to fetch new messages. Default: 30 seconds.</p>
	`,
	"BotConfigEditor.txtTaskNameOnReceive":`
	<p class="help-head"><span class="keywords">Trigger Task on Receive Message</span>: You can specify the name of a task to be executed when new messages are received. Telebot will run the specified task each time new messages are polled.</p>
	`,
	"BotConfigEditor.txtForwardMessage":`
	<p class="help-head"><span class="keywords">Forward Received Messages to Email</span>: If email addresses are set in "Forward Received Messages to Email", Telebot will forward the newly received messages to the email addresses you specified.</p>
	<p>&nbsp;</p>
	<p class="list-item">You can set multiple email addresses, separating them with ";".</p>
	<p>&nbsp;</p>
	<p class="list-item"><span class="keywords">Note</span>: This feature requires you to configure the email account for sending emails in <span class="keywords">"Email Accounts Manager"</span> before it can be used.</p>
	`,
	"BotConfigEditor.chkSendMessages":`
	<p class="help-head"><span class="keywords">Enable send messages via this bot</span>: When this option is checked, you can use this bot to send Telegram messages to designated individuals or groups.</p>
	`,

	"EmailForwardRuleConfigDialog.lstEmailAcct":`
	<p class="help-head"><span class="keywords">Apply to Emails Received By</span>: Select which email accounts this rule applies to. Telebot will process incoming emails for these accounts according to this rule.</p>
	<p>&nbsp;</p>
	<p class="help-head"><span class="keywords">Note</span>: This feature requires configuration of recipient email accounts in <span class="keywords">"Email Accounts Manager"</span>.</p>
	`,
	"EmailForwardRuleConfigDialog.txtKeywordInSubject":`
	<p class="help-head"><span class="keywords">Keyword in Subject</span>: Enter the keyword for the email subject. The system will apply this rule when the keyword is detected in received email subject.</p>
	<p class="help-head">The format of "Keyword in Subject" adheres to the wildcard syntax of PostgreSQL’s "LIKE" operator (e.g., '%' for any string, '_' for a single character) and is case-insensitive.</p>
	<p>&nbsp;</p>
	<p class="help-head">For example:</p>
	<p class="list-item">If the keyword is "%abc%" and the email subject contains "abc", it will be classified as this type of email.</p>
	<p>&nbsp;</p>
	<p class="list-item">If the keyword is "abc%" and  the email subject starts with "abc", it will be classified as this type of email.</p>
	<p>&nbsp;</p>
	<p class="help-head">Visit <a style="word-break:break-all;" href="https://www.sqlmessenger.com/manual/plugin-2-keyword-format.htm" target="_blank">https://www.sqlmessenger.com/manual/plugin-1-keyword-format.htm</a> for detailed specifications of the keyword format.</p>
	`,
	"EmailForwardRuleConfigDialog.txtSenderEmail":`
	<p class="help-head"><span class="keywords">Sender Email Addresses</span>: Enter email addresses whose messages should be processed by this rule, separate multiple addresses with a semicolon (";").</p>
	<p>&nbsp;</p>
	<p class="help-head">You can also click the button to the right of the text box to input email addresses.</p>
	`,
	"EmailForwardRuleConfigDialog.chkSkipSenderAddrChk":`
	<p class="help-head"><span class="keywords">Skip Sender Address Check for Forwarding</span>: After checking this option, "Sender Email Addresses" will become invalid. The system will skip the step of verifying the sender's email address.</p>
	`,
	"EmailForwardRuleConfigDialog.lstBot":`
	<p class="help-head"><span class="keywords">Forward Emails via Bot</span>: Select a bot, and the system will forward emails that meet this rule to the designated chat or group via this bot.</p>
	`,
	"EmailForwardRuleConfigDialog.lstChat":`
	<p class="help-head"><span class="keywords">Forward Emails to Chat</span>: Select a chat or a group. The system will forward emails that meet this rule to this selected chat or group.</p>
	`
	,
	"EmailForwardRuleConfigDialog.lstForwardPart":`
	<p class="help-head"><span class="keywords">Forward Selected Parts of the Email	</span>: Select which parts of the emails you want to forward to Telegram. You can choose from the following options:</p>
	<p class="list-item"><span class="keywords">Email header (includes subject)</span>: Forward the sender, subject, and timestamp to Telegram.</span></p>
	<p class="list-item"><span class="keywords">Email body</span>: The email contents can be converted to plain text, PNG image, or PDF file and forward to Telegram.</span></p>
	<p class="list-item"><span class="keywords">Attachments</span>: Forward the email's attachments to Telegram.</span></p>
	`,
	"EmailForwardRuleConfigDialog.lstTransformBody":`
	<p class="help-head"><span class="keywords">Convert Email Body to </span>: Select the conversion method for the body of the emails. </p>
	<p>Telebot can convert the body of the emails into plain text, PNG images, or PDF files and forward them to Telegram. By default, they are converted to plain text.</p>
	`
};
const addHelp = function(ctrl,helpPanelId,helpStrId){
	let ctrlObj = $(ctrl);
	if(ctrlObj.prop("tagName") == "TEXTAREA"){
		ctrlObj.attr("helpid",helpStrId).attr("helppanelid",helpPanelId).on("click",showHelp);
	}
	if(ctrlObj.prop("tagName") == "INPUT"){
		switch(ctrlObj.prop("type") == "checkbox"){
		case "checkbox":
			ctrlObj.attr("helpid",helpStrId).attr("helppanelid",helpPanelId).on("click",showHelp);
			break;
		default:
			ctrlObj.attr("helpid",helpStrId).attr("helppanelid",helpPanelId).on("focus",showHelp);
			break;
		}
	}
}
const showHelp = function(){
	let ctrlObj = $(this);	
	let helpId = ctrlObj.attr("helpid");
	let helpPanelId = ctrlObj.attr("helppanelid");
	if(!helpId || !helpPanelId){
		return;
	}
	$("#" + helpPanelId).html(HelpStr[helpId]?HelpStr[helpId]:"");
}
let oriPwd = "●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●●";

const BotConfigEditor = function(){
	let helpPanelId = generateUUID();
	let dialog = $(`<div>
		<div id="panel1">
			<div data-options="region:'west',border:false" style="width:820px;padding:5px;">
			<table class='dialog_ctrl_list'>
				<tr id='trLocalBotId'><td class="ctrlLabel">Local Bot ID</td><td><span id='localBotId'></span></td></tr>
				<tr><td class="ctrlLabel">Bot Token</td><td><span id='txtBotToken' style='width:500px;'></span></td></tr>
				<tr><td></td><td><span id="btnLoadBotInfo"></span></td></tr>
				<tr><td class="ctrlLabel">Bot ID</td><td><span id='txtBotId' style='width:500px;'></span></td></tr>
				<tr><td class="ctrlLabel">Username</td><td><span id='txtUserName' style='width:500px;'></span></td></tr>
				<tr><td class="ctrlLabel">Bot Name</td><td><span id='txtFirstName' style='width:500px;'></span></td></tr>
				<tr>
					<td></td>
					<td style='padding-left:0px;padding-right:0px;'>
						<table><tr><td style='padding-left:1px;'><input type='checkbox' id='chkFetchMessages'></td><td style='padding-left:0px;'><label for='chkFetchMessages' style='margin-top:-4px;'>Automatically fetch messages and save to local database</label></td></tr></table>
					</td>
				</tr>
				<tr><td class="ctrlLabel" id="labPollingTimeout">Polling Timeout</td><td><span id='txtPollingTimeout' style='width:500px;'></span></td></tr>
				<tr><td class="ctrlLabel"><span id="labTaskNameOnReceive">Trigger Task on Receive Message</span></td><td><span id='txtTaskNameOnReceive' style='width:500px;'></span></td></tr>
				<tr><td class="ctrlLabel"><span id="labForwardMessage">Forward Received Messages to Email</span></td><td><span id='txtForwardMessage' style='width:500px;'></span></td></tr>
				<tr>
					<td></td>
					<td style='padding-left:0px;padding-right:0px;'>
						<table><tr><td style='padding-left:1px;'><input type='checkbox' id='chkSendMessages'></td><td style='padding-left:0px;'><label for='chkSendMessages' style='margin-top:-4px;'>Enable send messages via this bot</label></td></tr></table>
					</td>
				</tr>
				<tr><td style='vertical-align:top;' class="ctrlLabel">Remark</td><td><span id='txtComments' style='width:500px;'></span></td></tr>
			</table>
			</div>
			<div data-options="region:'center'" id="${helpPanelId}" class="help-panel">
			</div>
		</div>
</div>`);
	let closed;
	function close(){
		closed = true;
		if(dialog){
			dialog.dialog("destroy");
			dialog = null;
		}
	}
	this.close = close;
	
	let txtBotToken, txtComments, txtBotId, txtUserName, txtFirstName, txtPollingTimeout, txtTaskNameOnReceive, txtForwardMessage;
	let btnLoadBotInfo, chkFetchMessages, chkSendMessages;
	(function(){
		dialog.dialog({
			title:"Edit Bot Config",
			width:document.body.clientWidth * 0.85,
			height:document.body.clientHeight * 0.95,
			maxWidth:1200,
			maxHeight:600,
			closed:true,
			modal:true,
			buttons:[{
				text:"OK",
				width:80,
				handler:onOK
			},{
				id:"btnCancel",
				text:"Cancel",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		createHelpButton20(dialog,"https://www.sqlmessenger.com/manual/plugin-2-bot-config.htm#part3");
		dialog.find("#panel1").layout({
			fit:true
		});
		txtBotToken = dialog.find("#txtBotToken");
		txtBotToken.textbox({});
		addHelp(txtBotToken.textbox("textbox"),helpPanelId,"BotConfigEditor.txtBotToken");
		
		btnLoadBotInfo = dialog.find("#btnLoadBotInfo");
		btnLoadBotInfo.linkbutton({
			text:"Load Bot Info",
			width:150,
			onClick:loadBotInfo
		});
		
		txtComments = dialog.find("#txtComments");
		txtComments.textbox({
			multiline:true,
			height:100
		});
		addHelp(txtComments.textbox("textbox"),helpPanelId,"BotConfigEditor.txtComments");

		txtBotId = dialog.find("#txtBotId");
		txtBotId.textbox({
			disabled:true
		});
		addHelp(txtBotId.textbox("textbox"),helpPanelId,"BotConfigEditor.txtBotId");
		//txtBotId.textbox("textbox").prop("readonly",true).css("background-color","#c0c0c0");
		txtUserName = dialog.find("#txtUserName");
		txtUserName.textbox({
			disabled:true
		});
		addHelp(txtUserName.textbox("textbox"),helpPanelId,"BotConfigEditor.txtUserName");

		txtFirstName = dialog.find("#txtFirstName");
		txtFirstName.textbox({
			disabled:true
		});
		addHelp(txtFirstName.textbox("textbox"),helpPanelId,"BotConfigEditor.txtFirstName");

		chkFetchMessages = dialog.find("#chkFetchMessages");
		addHelp(chkFetchMessages,helpPanelId,"BotConfigEditor.chkFetchMessages");
		chkFetchMessages.click(updateControlState);
		
		txtPollingTimeout = dialog.find("#txtPollingTimeout");
		txtPollingTimeout.textbox({});
		addHelp(txtPollingTimeout.textbox("textbox"),helpPanelId,"BotConfigEditor.txtPollingTimeout");

		chkSendMessages = dialog.find("#chkSendMessages");
		addHelp(chkSendMessages,helpPanelId,"BotConfigEditor.chkSendMessages");

		txtTaskNameOnReceive = dialog.find("#txtTaskNameOnReceive");
		txtTaskNameOnReceive.textbox({});
		addHelp(txtTaskNameOnReceive.textbox("textbox"),helpPanelId,"BotConfigEditor.txtTaskNameOnReceive");

		txtForwardMessage = dialog.find("#txtForwardMessage");
		txtForwardMessage.textbox({});
		addHelp(txtForwardMessage.textbox("textbox"),helpPanelId,"BotConfigEditor.txtForwardMessage");
	})();

	function updateControlState(){
		let fetchMessages = chkFetchMessages.prop("checked");
		if(fetchMessages){
			dialog.find("#labPollingTimeout,#labTaskNameOnReceive,#labForwardMessage").css("color","");
			txtPollingTimeout.textbox("enable");
			txtTaskNameOnReceive.textbox("enable");
			txtForwardMessage.textbox("enable");
		}
		else{
			dialog.find("#labPollingTimeout,#labTaskNameOnReceive,#labForwardMessage").css("color","#c0c0c0");
			txtPollingTimeout.textbox("disable");
			txtTaskNameOnReceive.textbox("disable");
			txtForwardMessage.textbox("disable");
		}
	}

	let statusFrame, taskInstId;
	let checkedToken;
	function loadBotInfo(){
		let token = txtBotToken.textbox("getValue").trim();
		if(!token){
			showAlert("Bot Token cannot be empty");
			txtBotToken.textbox("textbox").focus();
			return;
		}
		if(token != oriPwd){
			let newPwdSN = window.top.putCustEncValForHTTP(pwdSN,token,"api.telegram.org");
			if(typeof(newPwdSN) == "object"){
				$.messager.alert({
					msg:HTMLEncode(JSON.stringify(newPwdSN)),
					icon:"error",
					title:"Error",
					width:450
				});
				return;
			}
			else{
				pwdSN = newPwdSN;
				checkedToken = token;
			}
		}
		callService({
			commandName: "QueryTaskInfo_Telebot_CallBotAPI",
			onSuccess: function(data){
				if(data.records.length == 0){
					$.messager.alert({
						msg:`Task 'Telebot-CallBotAPI' not found. It may have been deleted.`,
						title:`Error`,
						icon:`error`,
						width:450
					});
					return;
				}
				let taskInfo = data.records[0];
				if(taskInfo.state == "D"){
					$.messager.alert({
						msg:`Task "Telebot-CallBotAPI" is disabled. Please enable it first.`,
						title:`Error`,
						icon:`error`,
						width:450
					});
					return;
				}
				let opts = [{
					k:115,
					v:true
				},{
			        "k": 644,
			        "v": {}
			    },
			    {
			        "k": 900,
			        "v": [
			          {
			            "varType": 2,
			            "varValue": "",
			            "taskVarId": taskInfo.task_var_id,
			            "varName": "PwdSN",
			            "newVal": pwdSN
			          }
			        ]
			    }];
				let callParams = {
				   	"ids": [parseInt(taskInfo.task_id)],
				   	"opts":opts
				};
				window.top.startTask({
					"dialogId":$(window.frameElement).attr("dialogid"),
			    	callParams:callParams,
			    	callback:function(taskInsts){
			    		if(taskInsts.length == 0){
				    		$.messager.alert({
					    		msg:"No task instance generated",
					    		icon:"error",
					    		title:"Error"
				    		});
				    		return;
			    		}
			    		let taskInstInfo = taskInsts[0];
			    		if(taskInstInfo.errorCode != 0){
				    		$.messager.alert({
					    		msg:taskInstInfo.resultText,
					    		icon:"error",
					    		width:450,
					    		title:"Error"
				    		});
				    		return;
			    		}
			    		let rst = JSON.parse(taskInstInfo.resultText);			    		
			    		taskInstId = rst.taskInstId;
			    		statusFrame = showStatusFrame(`Fetching bot details, please wait...`);
			    		queryTaskInstsState();
			    	}
				});
			}
		});
	}
	let timerId;
	let locked;
	function queryTaskInstsState(){
		if(locked){
			return;
		}
		locked = true;
		timerId = 0;
		sqlmessenger.helper.runSqlCommand({
			commandName: "QueryTaskInstState",
			parameters: {
				task_inst_id:taskInstId
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					statusFrame.remove();
					locked = false;
					return;
				}
				let rst = data.records[0];
				switch(rst.state){
				case "C":
					statusFrame.remove();					
					callService({
						commandName: "QueryTaskResult_Telebot_CallBotAPI",
						parameters:{
							task_inst_id:taskInstId
						},
						onSuccess: function(data){
							let info = data.records[0];
							if(info.http_code == "200"){
								botInfo = JSON.parse(info.result_data).result;								
								txtBotId.textbox("setValue",botInfo.id);
								txtUserName.textbox("setValue",botInfo.username);
								txtFirstName.textbox("setValue",botInfo.first_name);
								if(onLoadBotInfoSuccess){
									window.setTimeout(function(){
										onLoadBotInfoSuccess.apply(this,[]);
									},10);									
								}
							}
							else{
								let errorMessage;
								try{
									let resultData = JSON.parse(info.result_data);
									errorMessage = resultData.description;
								}
								catch(e){
									errorMessage = info.result_data;
								}
								$.messager.alert({
									width:500,
									msg: `<div>Failed to fetch bot information. Please verify your Bot Token is correct.</div>
										  <div>Error message: ${HTMLEncode(errorMessage)}</div>`,
									icon:"error",
									title:"Error"
								});
								locked = false;
								return;
							}
						}
					});
					locked = false;
					return;
				case "E":
				case "X":
					statusFrame.remove();
					$.messager.alert({
						width:500,
						msg:`<div>Failed to fetching bot information.</div>
						<div style="color:red;">${HTMLEncode(rst.result_comments)}</div>
						<div>Please try again.</div>`,
						icon:"error",
						title:"Error"
					});
					locked = false;
					return;
				}				            			
				if(!closed && taskInstId && !timerId){
					timerId = window.setTimeout(function(){
						queryTaskInstsState();
					},300);
				}
				locked = false;
			},
			onError: function(error){
				if(!closed && taskInstId && !timerId){
					timerId = window.setTimeout(function(){
						queryTaskInstsState();
					},300);
				}
				locked = false;
			}
		});
	}
	
	let botInfo,pwdSN;
	let oldBotCfg;
	let onLoadBotInfoSuccess;
	let callback;
	this.show = function(params){
		closed = false;
		callback = params.callback;
		onLoadBotInfoSuccess = null;
		taskInstId = null;
		oldBotCfg = null;
		
		let localBotId = params.localBotId?params.localBotId:null;
		if(localBotId){
			callService({
				commandName: "QueryBotConfig",
				parameters:{
					local_bot_id:localBotId
				},
				onSuccess: function(data){
					if(data.records.length == 0){
						showAlert(`The specified Bot ID was not found`);
						return;
					}
					dialog.find("#localBotId").text(localBotId);
					oldBotCfg = data.records[0];
					botInfo = JSON.parse(oldBotCfg.bot_info);
					pwdSN = oldBotCfg.pwd_sn;
					txtBotToken.textbox("setValue",oriPwd);
					checkedToken = oriPwd;
					txtBotId.textbox("setValue",oldBotCfg.bot_id);
					txtUserName.textbox("setValue",oldBotCfg.bot_user_name);
					txtFirstName.textbox("setValue",oldBotCfg.bot_first_name);
					chkFetchMessages.prop("checked",oldBotCfg.fetch_message == "1");
					txtPollingTimeout.textbox("setValue",oldBotCfg.timeout);
					chkSendMessages.prop("checked",oldBotCfg.send_message == "1");
					txtComments.textbox("setValue",oldBotCfg.comments);
					txtTaskNameOnReceive.textbox("setValue",oldBotCfg.trigger_task_on_receive);
					txtForwardMessage.textbox("setValue",oldBotCfg.forward_received_msg_to_email);
					
					dialog.find("#trLocalBotId").show();
					updateControlState();
					dialog.dialog("open");
					txtBotToken.textbox("textbox").focus();
				}
			});
		}
		else{
			pwdSN = "";
			checkedToken = "";
			botInfo = null;
			txtBotToken.textbox("setValue","");
			txtBotId.textbox("setValue","");
			txtUserName.textbox("setValue","");
			txtFirstName.textbox("setValue","");
			chkFetchMessages.prop("checked",true);
			txtPollingTimeout.textbox("setValue",30);
			chkSendMessages.prop("checked",true);
			txtComments.textbox("setValue","");
			txtTaskNameOnReceive.textbox("setValue","");
			txtForwardMessage.textbox("setValue","");
			
			dialog.find("#trLocalBotId").hide();
			updateControlState();
			dialog.dialog("open");
			txtBotToken.textbox("textbox").focus();
		}
	}
	
	function onOK(){
		let token = txtBotToken.textbox("getValue").trim();
		if(!token){
			txtBotToken.textbox("textbox").focus();
			showAlert(`Bot Token cannot be empty`);
			return;
		}
		if(!botInfo || (oldBotCfg && token != checkedToken)){
			onLoadBotInfoSuccess = onOK;
			loadBotInfo();
			return;
		}
		let fetchMessages = chkFetchMessages.prop("checked");
		let sendMessages = chkSendMessages.prop("checked");
		
		let pollingTimeout = txtPollingTimeout.textbox("getValue");
		if(!pollingTimeout){
			pollingTimeout = 30;
		}
		else{
			pollingTimeout = parseInt(pollingTimeout);
			if(isNaN(pollingTimeout) || pollingTimeout < 10 || pollingTimeout > 60){
				if(fetchMessages){
					$.messager.alert({
						msg:`Polling Timeout must be a number between 10 and 60`,
						title:`Note`,
						icon:`info`,
						width:450,
						fn:function(){
							txtPollingTimeout.textbox("textbox").focus().select();
						}
					});
					return;
				}
				else{
					pollingTimeout = 30;
				}
			}
		}
		function __f1(){
			if(oldBotCfg){
				callService({
					commandName: "UpdateBotConfig",
					parameters:{
						"local_bot_id":oldBotCfg.local_bot_id,
						"pwd_sn":pwdSN,
						"bot_info":JSON.stringify(botInfo),
						"fetch_message":fetchMessages?"1":"0",
						"polling_timeout":pollingTimeout,
						"send_message":sendMessages?"1":"0",
						"comments":txtComments.textbox("getValue").trim(),
						"trigger_task_on_receive":txtTaskNameOnReceive.textbox("getValue"),
						"forward_received_msg_to_email":txtForwardMessage.textbox("getValue").trim()
					},
					onSuccess: function(data){
						callback.call(this,data.records[0]);
						dialog.dialog("close");
						UpdateTaskStateForBotConfig(data);
						
									
					}
				});
			}
			else{
				//Add a new bot
				callService({
					commandName: "AddBotConfig",
					parameters:{
						"pwd_sn":pwdSN,
						"bot_info":JSON.stringify(botInfo),
						"fetch_message":fetchMessages?"1":"0",
						"polling_timeout":pollingTimeout,
						"send_message":sendMessages?"1":"0",
						"comments":txtComments.textbox("getValue").trim(),
						"trigger_task_on_receive":txtTaskNameOnReceive.textbox("getValue"),
						"forward_received_msg_to_email":txtForwardMessage.textbox("getValue").trim()
					},
					onSuccess: function(data){
						callback.call(this,data.records[0]);
						dialog.dialog("close");
						UpdateTaskStateForBotConfig(data);
					}
				});
			}
		}
		if(chkFetchMessages){
			if(!oldBotCfg || (oldBotCfg && oldBotCfg.fetch_message != "1")){
				$.messager.confirm({
					msg:`<div>You have enabled the 'Automatically fetch messages and save to local database' option for this bot. If other applications are also using this bot to retrieve messages through polling, they might not receive complete message lists. </div>
<div>For more details, visit <a href="https://core.telegram.org/bots/api#getupdates">https://core.telegram.org/bots/api#getupdates</a></div>
<div>&nbsp;</div>
<div>Do you want to continue?</div>`,
					width:500,
					icon:"warn",
					title:"Question",
					fn:function(r){
						if(r){
							__f1();
						}
					}
				});
				return;
			}
		}
		__f1();
	}
}
const UpdateTaskStateForBotConfig = function(data){
	let activeBotForFetch = parseInt(data.tempVarsForClient["active_bot_for_fetch"]);
	let activeBotForSend = parseInt(data.tempVarsForClient["active_bot_for_send"]);	
	function __f2(error){
		frame.remove();
		showAlert("Bot configuration saved");
	}
	function __f1(error){
		UpdateTaskState("Telebot_Controller_SendMessages",activeBotForSend > 0?"A":"D",__f2);
	}
	let frame = showStatusFrame("Saving bot configuration, please wait...");
	UpdateTaskState("Telebot_Controller_GetMessageUpdates",activeBotForFetch > 0?"A":"D",__f1);	
}

const UpdateTaskStateForDataSourceMonitor = function(data){
	let activeDataSource = parseInt(data.tempVarsForClient["active_data_source"]);
	function __f1(error){
		frame.remove();
		showAlert("Datasource monitor configuration saved");
	}
	let frame = showStatusFrame("Saving datasource monitor configuration, please wait...");
	UpdateTaskState("Telebot_Controller_SyncMessageList",activeDataSource > 0?"A":"D",__f1);	
}

const UpdateTaskState = function(taskName,newState,callback){
	callService({
		commandName: "QueryTaskIdByName",
		parameters:{
			task_name:taskName
		},
		onSuccess: function(data){
			if(data.records.length == 0 || data.records[0].state == newState){
				callback.apply(this,[]);
			}
			else{
				window.top.updateTaskState(data.records[0].task_id,newState,callback);
			}
		}
	});
}
const BotConfigManager = function(){
	let gridBotList = $("#panelBotConfigManager");
	let botConfigEditor;
	this.close = function(){
		if(botConfigEditor){
			botConfigEditor.close();
			botConfigEditor = null;
		}
	};
	let girdStatusMgr;
	(function(){
		gridBotList.datagrid({
			border: false,
			fit: true,
			singleSelect: true,
			loadMsg: false,
			pagination:false,
			toolbar: [{
				text:"Add Bot Config",
				handler:function(){
					addBot();
				}
			},"-",{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					query();
				}	
			},{
				text:"Help",
				iconCls:"toolbar-button-icon icon-help-20",
				handler:function(){
					window.open("https://www.sqlmessenger.com/manual/plugin-2-bot-config.htm#part1");
				}
			},{
				text:"Exit",
				iconCls:"toolbar-button-icon icon-exit-20",
				handler:function(){
					mainTabs.tabs("close",botConfigManagerPanel.title);
				}
			}],
			rownumbers:true,
			rowStyler:rowStyler,
			columns:[[{
				field:"local_bot_id",
				title:"LocalBotID",
				width:100,
				halign:"center"
			},{
				field:"bot_id",
				title:"BotID",
				width:100,
				halign:"center"
			},{
				field:"bot_user_name",
				title:"UserName",
				width:150,
				halign:"center",
				formatter: function(value, row, index){
					let name = HTMLEncode(value); 
					if(row.state == "X"){
						return name;
					}
					else{
						return `<span class="link btnEdit" localbotid="${row.local_bot_id}">${name}</span>`;
					}
				}
			},{
				field:"bot_first_name",
				title:"BotName",
				width:150,
				halign:"center"
			},{
				field:"fetch_message",
				title:"FetchMessage",
				width:110,
				align:"center",
				formatter: function(value, row, index){
					if(value == "1"){
						return "Allowed";
					}
					else{
						return "Not Allowed";
					}
				}
			},{
				field:"send_message",
				title:"SendMessage",
				width:110,
				align:"center",
				formatter: function(value, row, index){
					if(value == "1"){
						return "Allowed";
					}
					else{
						return "Not Allowed";
					}
				}
			},{
				field:"create_time",
				title:"CreatedTime",
				width:140,
				align:"center"
			},{
				field:"state",
				title:"State",
				width:80,
				align:"center",
				formatter: function(value, row, index){
					let rst = "";
					switch(value){
					case "A":
						rst = "<span class='status-icon icon-useable' title='Enabled'></span>";
						break;
					case "D":
						rst = "<span class='status-icon icon-disabled' title='Disabled'></span>";
						break;
					case "X":
						rst = "<span class='status-icon icon-deleted' title='Deleted'></span>";
						break;
					default:
						rst = value;
						break;
					}
					return rst;
				}
			},{
				field:"state_time",
				title:"StateTime",
				width:140,
				align:"center"
			},{
				field:"actions",
				title:"Actions",
				width:130,
				align:"center",
				formatter: function(value, row, index){
					if(row.state == "X"){
						return "";
					}
					else{
						let rst;
						rst = `<span class='grid-menu-icon btnEdit' title='Edit' localbotid='${row.local_bot_id}'><span class='menu-button-icon btn-edit'></span></span>`;
						if(row.state == "A"){
							rst += `<span class='grid-menu-icon btnDisable' title='Disable this bot' localbotid='${row.local_bot_id}'><span class='menu-button-icon btn-stop'></span></span>`;
						}
						else{
							rst += `<span class='grid-menu-icon btnEnable' title='Enable this bot' localbotid='${row.local_bot_id}'><span class='menu-button-icon btn-enable'></span></span>`;
						}
						rst += `<span class='btnDelete grid-menu-icon' title='Delete this bot' localbotid='${row.local_bot_id}'><span class='menu-button-icon btn-delete'></span></span>`;
						return rst;
					}
				}
			}]],
			onLoadSuccess:onLoadSuccess
		});
		girdStatusMgr = GridStatusMgr({
			grid:gridBotList,
			idField:"local_bot_id"
		});
	})();

	function addBot(){
		if(!botConfigEditor){
			botConfigEditor = new BotConfigEditor();
		}
		botConfigEditor.show({
			callback:function(botInfo){
				gridBotList.datagrid("appendRow",botInfo);
				onLoadSuccess();
				gridBotList.datagrid("selectRow",gridBotList.datagrid("getRows").length - 1);
			}
		});
	}
	
	function onLoadSuccess(){
		let parent = gridBotList.parent();
		let objs = parent.find(".btnEdit").not(".bound");
		objs.click(editBot);
		objs.addClass("bound");

		objs = parent.find(".btnDisable").not(".bound");
		objs.click(disableBot);
		objs.addClass("bound");

		objs = parent.find(".btnEnable").not(".bound");
		objs.click(enableBot);
		objs.addClass("bound");

		objs = parent.find(".btnDelete").not(".bound");
		objs.click(deleteBot);
		objs.addClass("bound");
	}

	function deleteBot(){
		let localBotId = $(this).attr("localbotid");
		let rows = gridBotList.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"local_bot_id",localBotId);
		if(rowIndex < 0){
			return;
		}
		if(rows[rowIndex] == "X"){
			return;
		}
		$.messager.confirm({
			msg:`You are about to delete the bot from the Telebot configuration table. Once deleted, the system will no longer be able to read messages received by this bot or send messages using it. This action cannot be undone. Do you want to continue?`,
			title:"Warning",
			width:450,
			fn:function(r){
				if(r){
					callService({
						commandName: "DeleteBot",
						parameters:{
							"local_bot_id":localBotId
						},
						onSuccess: function(data){
							gridBotList.datagrid("deleteRow",rowIndex);
							UpdateTaskStateForBotConfig(data);
						}
					});
				}
			}
		});
	}

	function disableBot(){
		let localBotId = $(this).attr("localbotid");
		updateBotState(localBotId,"D");
	}

	function enableBot(){
		let localBotId = $(this).attr("localbotid");
		updateBotState(localBotId,"A");
	}

	function updateBotState(localBotId,newState){
		let rows = gridBotList.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"local_bot_id",localBotId);
		if(rowIndex < 0){
			return;
		}
		if(rows[rowIndex] == newState){
			return;
		}
		callService({
			commandName: "UpdateBotState",
			parameters:{
				"local_bot_id":localBotId,
				"new_state":newState
			},
			onSuccess: function(data){
				gridBotList.datagrid("updateRow",{
					index:rowIndex,
					row:data.records[0]
				});
				onLoadSuccess();
				UpdateTaskStateForBotConfig(data);
			}
		});
	}

	function editBot(){
		let localBotId = $(this).attr("localbotid");
		let rows = gridBotList.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"local_bot_id",localBotId);
		if(rowIndex < 0){
			return;
		}
		if(!botConfigEditor){
			botConfigEditor = new BotConfigEditor();
		}
		botConfigEditor.show({
			localBotId:localBotId,
			callback:function(botInfo){
				gridBotList.datagrid("updateRow",{
					index:rowIndex,
					row:botInfo
				});
				onLoadSuccess();
			}
		});
	}

	function query(){
		girdStatusMgr.beforeQuery();
		callService({
			commandName: "QueryBotList",
			onSuccess: function(data){
				gridBotList.datagrid("loadData",data.records);
				girdStatusMgr.afterQuery();
			}
		});
	}

	this.doAction = function(action){
		if(action == "config"){
			addBot();
		}
	};

	(function(){
		query();
	})();
}

const messageStatusDefine = {
	"W":"Pending",
	"C":"Sent Successfully",
	"E":"Error",
	"F":"Failed",
	"P":"Expired",
	"X":"Canceled"
};

const MessageInfoDialog = function(){	
	let dialog = $(`<div>
	<div id="tabs1">
		<div title="Message Details">
			<div id="panel1">
				<div data-options="region:'north'" style="height:40px;border-style:none none solid none;border-color:#dddddd;background-color:#F4F4F4;padding:3px;overflow:hidden;">
					<span id="btnRefresh"></span>
				</div>
				<div data-options="region:'center',border:false" style="padding:5px;">
					<table class="dialog_ctrl_list list-table" id="msgInfoTable" style="width:100%;">
						<tbody id="msgInfoBody"></tbody>
					</table>
				</div>
			</div>
		</div>
		<div title="Sending Logs">
			<div id="gridLog"></div>
		</div>
	</div>`);
	function close(){
		if(logDetailsDialog){
			logDetailsDialog.dialog("destroy");
			logDetailsDialog = null;
		}
		dialog.dialog("destroy");
	}
	this.close = close;
	let tabs1, gridLog, pager;
	let recCount = -1;
	let page = 1;
	let pageSize = 50;
	let sendingLogQueried;
	(function(){
		dialog.dialog({
			title:"Message Details",
			width:document.body.clientWidth * 0.8,
			height:document.body.clientHeight * 0.95,
			closed:true,
			modal:true,
			maximizable: true,
            resizable: true,
			buttons:[{
				text:"Close",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		tabs1 = dialog.find("#tabs1");
		tabs1.tabs({
			fit:true,
			border:false,
			onSelect:function(title,index){
				if(index == 1 && !sendingLogQueried){
					window.setTimeout(function(){
						querySendingLog();
						sendingLogQueried = true;
					},10);
				}
			}
		});
		dialog.find("#panel1").layout({
			fit:true
		});
		dialog.find("#btnRefresh").linkbutton({
			text:"Refresh",
			iconCls:"toolbar-button-icon icon-refresh",
			plain:true,
			onClick:queryMessageInfo
		});
		gridLog = dialog.find("#gridLog");
		gridLog.datagrid({
			border: false,
			fit: true,
			singleSelect: true,
			loadMsg: false,
			pagination:true,
			toolbar: [{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					recCount = -1;
					page = 1;
					querySendingLog();
				}	
			}],
			rownumbers:true,
			rowStyler: function(index,row){
				if(row.log_type != "0" && row.log_type != "4"){
					return "color:red;";
				}
			},
			columns:[[{
				field:"log_type",
				title:"",
				width:30,
				align:"center",
				formatter: function(value, row, index){
					let rst;
					switch(value){
					case "1":
						rst = `<span class="status-icon error-icon-20"></span>`;
						break;
					case "3":
						rst = `<span class="status-icon icon-warn-20"></span>`;
						break;
					case "4":
						rst = `<span class="status-icon tick-20"></span>`;
						break;
					default:
						rst = `<span class="status-icon info-icon"></span>`;
						break;
					}
					return rst;
				}
			},{
				field:"log_msg",
				title:"Log",
				width:800,
				halign:"center",
				formatter: function(value, row, index){
					return `<span class="link btnLogDetails" logid="${row.log_id}">${HTMLEncode(value)}</span>`;
				}
			},{
				field:"log_time",
				title:"LogTime",
				width:140,
				align:"center"
			}]],
			onLoadSuccess:onLoadSuccess
		});
		pager = gridLog.datagrid("getPager");
		pager.pagination({
			total: 0,
			pageSize: pageSize,
			pageList: [10, 50, 100, 300, 500],
			onChangePageSize: function(newPageSize){
				pageSize = newPageSize;
				recCount = -1;
				querySendingLog();
			},
			onSelectPage: function(pageNumber, pageSize){			
				page = pageNumber < 1 ? 1 : pageNumber;				
				querySendingLog();
			}
		});
		girdStatusMgr = GridStatusMgr({
			grid:gridLog,
			idField:"log_id"
		});
	})();
	function onLoadSuccess(){
		let parent = gridLog.parent();
		let objs = parent.find(".btnLogDetails").not(".bound");
		objs.click(viewLogDetails);
		objs.addClass("bound");
	}
	let logDetailsDialog;
	function viewLogDetails(){
		let logId = $(this).attr("logid");
		if(!logDetailsDialog){
			logDetailsDialog = $(`
<div style="padding:5px;">
	<table class="dialog_ctrl_list list-table" style="width:100%;">
		<tr>
			<td class="label">LogID</td><td class="cell"><span id="log_id"></span></td>
			<td class="label">LogType</td><td  class="cell"><span id="log_type"></span></td>
			<td class="label">LogTime</td><td  class="cell"><span id="log_time"></span></td>
			<td class="label">LocalMessageID</td><td class="cell"><span id="local_message_id"></span></td>
		</tr>
		<tr>
			<td class="label">ResultData</td><td  class="cell" colspan=7><span id="result_data"></span></td>
		</tr>
	</table>
</div>`);
			logDetailsDialog.dialog({
				title:"Log Details",
				width:document.body.clientWidth * 0.7,
				height:document.body.clientHeight * 0.9,
				closed:true,
				modal:true,
				maximizable: true,
	            resizable: true,
				buttons:[{
					text:"Close",
					width:80,
					handler:function(){
						logDetailsDialog.dialog("close");
					}	
				}]
			});
			logDetailsDialog.find("#result_data").click(function(){
				let text = $(this).text();
				showChildData("ResultData",JSON.parse(text));
			});
		}
		callService({
			commandName: "QueryLogDetails",
			parameters:{
				log_id:logId
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					showAlert("Specified log record does not exist");
					return;
				}
				let logInfo = data.records[0];
				$.each(logInfo,function(key,value){
					logDetailsDialog.find("#" + key).text(value);
				});
				let obj = logDetailsDialog.find("#result_data");
				let text = obj.text();
				let isJSON = false;
				if(text){
					try{
						let data = JSON.parse(text);
						isJSON = true;
					}
					catch(e){
					}
				}
				if(isJSON){
					obj.addClass("link");
				}
				else{
					obj.removeClass("link");
				}
				logDetailsDialog.dialog("open");
			}
		});
	}

	function querySendingLog(){
		girdStatusMgr.beforeQuery();
		if(recCount < 0){
			page = 1;
		}
		callService({
			commandName: "QueryMessageSendingLog",
			parameters:{
				recCount:recCount,
				page:page,
				pageSize:pageSize,
				local_message_id:localMessageId
			},
			onSuccess: function(data){
				gridLog.datagrid("loadData",data.records);
				if(data.tempVarsForClient && data.tempVarsForClient["record_count"]){
					recCount = parseInt(data.tempVarsForClient["record_count"]);
				}				
				pager.pagination("refresh", {
					pageSize: pageSize,
					total: recCount,
					pageNumber: page
				});
				girdStatusMgr.afterQuery();		
			}
		});
	}
	let localMessageId;
	let showed;
	this.show = function(params){
		sendingLogQueried = false;
		showed = false;		
		localMessageId = params.localMessageId;
		queryMessageInfo();
	}

	function queryMessageInfo(){
		callService({
			commandName: "QueryMessageDetails",
			parameters:{
				local_message_id:localMessageId
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					$.messager.alert({
						msg:"Specified local_message_id not found",
						title:"Note",
						icon:"info",
						width:450
					});
					return;
				}
				let msgInfo = data.records[0];
				let msgInfoBody = dialog.find("#msgInfoBody");
				msgInfoBody.remove();
				msgInfoBody = $("<tbody id='msgInfoBody'></tbody>");
				dialog.find("#msgInfoTable").append(msgInfoBody);
				$.each(msgInfo,function(key,value){
					let tr = $(`<tr></tr>`);
					let td = $(`<td class="label"></td>`);
					td.text(key);
					tr.append(td);
					
					td = $(`<td class="cell"></td>`);
					td.prop(`id`,key);					
					switch(key){
					case `state`:
						switch(value){
						case "E":
						case "F":
						case "P":
							td.css("color","red");
							break;
						case "C":
							td.css("color","blue");
							break;							
						}
						td.text(messageStatusDefine[value]);
						break;
					case `message_content`:
						if(value){
							td.css("white-space","break-spaces");
						}
						td.text(value === null?``:value);
						break;
					default:
						td.text(value === null?``:value);
						break;
					}
					 
					tr.append(td);
					msgInfoBody.append(tr);
				});
				if(!showed){
					dialog.dialog("open");
					tabs1.tabs("select",0);
					showed = true;
				}
			}
		});
	}
}

let objectDetailsDialog;
const showObjectDetails = function(params){
	if(!objectDetailsDialog){
		objectDetailsDialog = new ObjectDetailsDialog();
	}
	objectDetailsDialog.show(params);
}
const ObjectDetailsDialog = function(opts){	
	let dialog = $(`
<div>
	<div id="panel1">
		<div data-options="region:'north'" style="padding:3px;height:40px;border-style:none none solid none;border-color:#dddddd;background-color:#F4F4F4;overflow:hidden;">
			<span id="btnClose"></span>
		</div>
		<div data-options="region:'center',border:false" style="padding:3px;">
			<table class="dialog_ctrl_list list-table" id="objectDetailsTable" style="width:100%;">	
			</table>
		</div>
	</div>
</div>
`);
	(function(){
		dialog.dialog({
			width:document.body.clientWidth * 0.8,
			height:document.body.clientHeight * 0.95,
			closed:true,
			modal:true,
			maximizable: true,
            resizable: true,
            onClose:function(){
            	if(opts && opts.destroyOnClose){
                	window.setTimeout(function(){
	            		dialog.dialog("destroy");
                	},10);
            	}
			},
			buttons:[{
				text:"Close",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		dialog.find("#panel1").layout({
			fit:true
		});
		dialog.find("#btnClose").linkbutton({
			text:"Back",
			plain:true,
			iconCls:"toolbar-button-icon back-icon",
			width:80,
			onClick:function(){
				dialog.dialog("close");
			}
		});
	})();
	let callback;
	this.show = function(params){
		let detailsBody = dialog.find("#detailsBody");
		if(detailsBody.length > 0){
			detailsBody.remove();
		}
		detailsBody = $(`<tbody id="detailsBody"></tbody>`);
		dialog.find("#objectDetailsTable").append(detailsBody);
		$.each(params.data,function(key,value){
			let tr = $(`<tr></tr>`);
			let td = $(`<td class="label"></td>`);
			td.text(key);
			tr.append(td);
			
			td = $(`<td class="cell"></td>`);
			td.prop(`id`,key);					
			td.text(value === null?"[NULL]":value);
			tr.append(td);
			detailsBody.append(tr);
		});
		if(params.callback){
			params.callback.call(this,dialog.find("#objectDetailsTable"));
		}
		dialog.dialog("setTitle",params.title);
		dialog.dialog("open");
	}
}

const MessageQueueManager = function(env){
	let parentDialog = env.parentDialog;
	let gridMessageQueue = env.container;
	let inDialog = env.inDialog === true;	
	let messageInfoDialog;
	let findMessageDialog;
	let closed = false;
	this.close = function(){
		closed = true;
		if(messageInfoDialog){
			messageInfoDialog.close();
			messageInfoDialog = null;
		}
		if(findMessageDialog){
			findMessageDialog.close();
			findMessageDialog = null;
		}
	};
	function updatePauseButtonState(newValue){
		sendingPaused = newValue == "1";
		if(sendingPaused){
			btnPause.find(".l-btn-text").text("Resume Sending");
			btnPause.linkbutton("select");
			btnPause.find(".l-btn-icon").removeClass("icon-pause").addClass("icon-play");
		}
		else{
			btnPause.find(".l-btn-text").text("Pause Sending");
			btnPause.find(".l-btn-icon").removeClass("icon-play").addClass("icon-pause");
			btnPause.linkbutton("unselect");
		}
	}
	function showPausedAlert(){
		$.messager.alert({
			msg:"Message sending is currently paused in Telebot. To resume, click the 'Resume Sending'.",
			title:"Note",
			icon:"warning",
			width:450
		});
	}
	let toolbar = [{
		text:"Refresh",
		iconCls:"toolbar-button-icon icon-refresh",
		handler:function(){
			recCount = -1;
			page = 1;
			query();
		}	
	},"-",{
		id:"btnPause",
		text:"Pause Sending",
		iconCls:"toolbar-button-icon icon-pause",
		handler:function(){
			let msg;
			if(!sendingPaused){
				msg = `Are you sure you want to pause message sending? (All pending messages will be paused until you resume.)`;
						
			}
			else{
				msg = `Are you sure you want to resume message sending? (Telebot will continue sending all pending messages once resumed.)`;
			}
			let wnd = $.messager.confirm({
				msg:msg,
				title:"Note",
				width:450,
				fn:function(r){
					if(r){
						callService({
							commandName: "UpdateMessageSendingThreadStatus",
							parameters:{
								new_value:sendingPaused?"0":"1"
							},
							onSuccess: function(data){
								updatePauseButtonState(data.records[0].config_value);
								if(sendingPaused){
									showPausedAlert();
								}
								else{
									showAlert("Message sending has been resumed in Telebot.");
								}
							}
						});
					}
				}
			});
			wnd.window("window").find(".messager-icon").removeClass("messager-question").addClass("messager-question");
		}	
	},"-",{
		text:"Cancel Sending",
		iconCls:"toolbar-button-icon disable-icon",
		handler:function(){
			let rows = gridMessageQueue.datagrid("getSelections");
			if(rows.length == 0){
				showAlert("Please select the record(s) to operate");
				return;
			}
			let ids = "";
			let cnt = 0;
			$.each(rows,function(index,item){
				switch(item.state){
				case "W":
				case "E":
					ids += item.local_message_id + ",";
					++cnt;
					break;
				}
			});
			if(!ids){
				showAlert("No pending messages found in selected records");
				return;
			}
			ids = ids.substring(0,ids.length - 1);
			$.messager.confirm({
				msg:`Cancel sending the selected ${cnt} message(s)?`,
				title:"Question",
				width:400,
				fn:function(r){
					if(r){
						cancelSendingMessages(ids);
					}
				}
			});
		}	
	},{
		text:"Resend Selected",
		iconCls:"toolbar-button-icon btn-undelete",
		handler:function(){
			let rows = gridMessageQueue.datagrid("getSelections");
			if(rows.length == 0){
				showAlert("Please select the record(s) to operate");
				return;
			}
			let ids = "";
			let cnt = 0;
			$.each(rows,function(index,item){
				switch(item.state){
				case "W":
				case "E":
				case "R":
					break;
				default:
					ids += item.local_message_id + ",";
					++cnt;
					break;
				}
			});
			if(!ids){
				showAlert("No resendable messages found in selected records");
				return;
			}
			ids = ids.substring(0,ids.length - 1);
			$.messager.confirm({
				msg:`Resend the selected ${cnt} message(s)?`,
				title:"Question",
				width:400,
				fn:function(r){
					if(r){
						resendMessages(ids);
					}
				}
			});
		}	
	},"-",{
		text:"Delete",
		iconCls:"toolbar-button-icon delete-message",
		handler:function(){
			deleteSelectedMessages();
		}	
	},"-",{
		text:"Help",
		iconCls:"toolbar-button-icon icon-help-20",
		handler:function(){
			window.open("https://www.sqlmessenger.com/manual/plugin-2-message-queue.htm");
		}
	}];
	if(env && env.showFindBtn === true){
		toolbar.splice(1,0,{
			text:"Find",
			id:"btnFind",
			iconCls:"toolbar-button-icon icon-query",
			handler:function(){
				if(!findMessageDialog){
					findMessageDialog = new FindMessageDialog({
						btnFind:gridMessageQueue.parent().parent().find("#btnFind")
					});
				}
				findMessageDialog.show({
					callback:function(newOpts){
						queryOpts.bots = newOpts.bots;
						queryOpts.start_date = newOpts.start_date;
						queryOpts.end_date = newOpts.end_date;
						queryOpts.state = newOpts.state;
						recCount = -1;
						page = 1;
						query();
					}
				});
			}
		});
	}
	if(!inDialog || parentDialog){
		toolbar.push({
			text:"Exit",
			iconCls:"toolbar-button-icon icon-exit-20",
			handler:function(){
				if(parentDialog)
					parentDialog.dialog("close");
				else
					mainTabs.tabs("close",messageQueueManagerPanel.title);
			}	
		});
	}
	let girdStatusMgr;
	let pager;
	let page = 1,pageSize = 50,recCount = -1;
	let btnPause;	
	(function(){
		gridMessageQueue.datagrid({
			border: false,
			fit: true,
			singleSelect: false,
			ctrlSelect:true,
			loadMsg: false,
			pagination:true,
			toolbar: toolbar,
			rownumbers:true,
			rowStyler:rowStyler,
			columns:[[{
				field:"x",
				checkbox:true
			},{
				field:"local_message_id",
				title:"LocalMessageID",
				width:110,
				halign:"center"
			},{
				field:"ext_message_id",
				title:"ExtMessageID",
				width:110,
				halign:"center"
			},{
				field:"bot_id",
				title:"BotID",
				width:100,
				halign:"center"
			},{
				field:"bot_user_name",
				title:"BotUserName",
				width:150,
				halign:"center"
			},{
				field:"message_type",
				title:"MessageType",
				width:100,
				halign:"center"
			},{
				field:"chat_id",
				title:"SendTo",
				width:140,
				halign:"center",
				formatter: function(value, row, index){
					let chatName = row.chat_title?row.chat_title:row.chat_user_name;
					chatName = chatName?HTMLEncode(chatName):value; 
					if(row.state == "X"){
						return HTMLEncode(chatName);
					}
					else{
						return `<span class="link btnChatInfo" chatid="${row.chat_id}">${chatName}</span>`;
					}
				}
			},{
				field:"message_source",
				title:"MessageSource",
				width:110,
				halign:"center",
				formatter: function(value, row, index){
					let rst;
					switch(value){
					case "0":
						rst = "Unspecified";
						break;
					case "1":
						rst = "BulkJob";
						break;
					case "2":
						rst = "EmailForwarding";
						break;
					case "3":
						rst = "InterfaceTable";
						break;
					default:
						rst = value;
						break;
					}
					return rst;
				}
			},{
				field:"message",
				title:"Message",
				width:130,
				halign:"center",
				formatter: function(value, row, index){
					if(value && value.length > 100){
						value = value.substring(0,100) + "...";
					}
					return `<span class="link btnDetail" localmessageid='${row.local_message_id}'>${HTMLEncode(value)}</span>`;
				}
			},{
				field:"create_time",
				title:"CreatedTime",
				width:140,
				align:"center"
			},{
				field:"state",
				title:"Status",
				width:70,
				align:"center",
				formatter: function(value, row, index){
					let rst = "";
					if(row.state != "C" && row.record_state == "X"){
						rst = `<span style='color:red;'>Cancelled</span>`;
					}
					else{
						switch(value){
						case "W":
							rst = `<span>${messageStatusDefine[value]}</span>`;
							break;
						case "C":
							rst = `<span class='status-icon tick-20' title='${messageStatusDefine[value]}'></span>`;
							break;
						case "E":
							rst = `<span style='color:red;'>${messageStatusDefine[value]}</span>`;
							break;
						case "F":
							rst = `<span style='color:red;'>${messageStatusDefine[value]}</span>`;
							break;
						case "X":
							rst = `<span>${messageStatusDefine[value]}</span>`;
							break;
						case "P":
							rst = `<span style='color:red;'>${messageStatusDefine[value]}</span>`;
							break;
						case "R":
							rst = `<span title="Sending"><img src="images/waiting.gif"></span>`;
							break;
						default:
							rst = value;
							break;
						}
					}
					return rst;
				}
			},{
				field:"state_time",
				title:"StatusTime",
				width:140,
				align:"center"
			},{
				field:"retry_count",
				title:"RetryCount",
				width:80,
				halign:"center",
				align:"right",
				formatter: function(value, row, index){
					if((row.state == "E" || row.state == "F") && parseInt(value) > 0){
						return `<span style="color:red;">${value}</span>`;
					}
					else{
						return value;
					}
				}
			},{
				field:"actions",
				title:"Actions",
				width:60,
				align:"center",
				formatter: function(value, row, index){
					return `<span class='grid-menu-icon btnDetail' title='View Message Details' localmessageid='${row.local_message_id}'><span class='menu-button-icon info-information-icon'></span></span>`;
				}
			}]],
			onLoadSuccess:onLoadSuccess
		});
		girdStatusMgr = GridStatusMgr({
			grid:gridMessageQueue,
			idField:"local_message_id"
		});
		pager = gridMessageQueue.datagrid("getPager");
		pager.pagination({
			total: 0,
			pageSize: pageSize,
			pageList: [10, 50, 100, 300, 500],
			onChangePageSize: function(newPageSize){
				pageSize = newPageSize;
				recCount = -1;
				query();
			},
			onSelectPage: function(pageNumber, pageSize){			
				page = pageNumber < 1 ? 1 : pageNumber;				
				query();
			}
		});
		if(inDialog)
			gridMessageQueue.prev().find(".datagrid-body").addClass("grid-autowrap");
		btnPause = gridMessageQueue.datagrid("getPanel").find("#btnPause");
	})();
	
	function onLoadSuccess(){
		let parent = gridMessageQueue.parent();
		let objs = parent.find(".btnDetail").not(".bound");
		objs.click(viewMessageDetails);
		objs.addClass("bound");

		objs = parent.find(".btnChatInfo").not(".bound");
		objs.click(queryChatInfo);
		objs.addClass("bound");
	}
	function deleteSelectedMessages(){
		let rows = gridMessageQueue.datagrid("getSelections");
		if(rows.length == 0){
			showAlert("Please select the record(s) to operate");
			return;
		}
		let ids = "";
		$.each(rows,function(index,item){
			ids += item.local_message_id + ",";
		});
		ids = ids.substring(0,ids.length - 1);
		$.messager.confirm({
			msg:`Are you sure you want to delete the selected ${rows.length} message(s)?`,
			width:400,
			title:"Question",
			fn:function(r){
				if(r){
					callService({
						commandName: "deleteSendingMessages",
						parameters:{
							local_message_ids:ids
						},
						onSuccess: function(data){
							if(data.records.length == 0){
								$.messager.alert({
									msg:`No message ID(s) found`,
									title:"Note",
									width:450,
									icon:"warn"
								});
								return;
							}
							window.setTimeout(function(){
								query();
							},10);
						}
					});
				}
			}
		});
	}
	
	function cancelSendingMessages(messageIds){
		callService({
			commandName: "CancelSendingMessages",
			parameters:{
				local_message_ids:messageIds
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					$.messager.alert({
						msg:`No message ID(s) found`,
						title:"Note",
						width:450,
						icon:"warn"
					});
					return;
				}
				let rows = gridMessageQueue.datagrid("getRows");
				$.each(data.records,function(index,item){
					let rowIndex = findItemIndexInArray(rows,"local_message_id",item.local_message_id);
					if(rowIndex > -1){
						gridMessageQueue.datagrid("updateRow",{
							index:rowIndex,
							row:item
						});
					}
				});
				onLoadSuccess();
			}
		});
	}
	function cancelMessage(){
		let localMessageId = parseInt($(this).attr("localmessageid"));
		$.messager.confirm({
			msg:"Cancel sending the selected message(s)?",
			title:"Question",
			width:400,
			fn:function(r){
				if(r){
					cancelSendingMessages(localMessageId);
				}
			}
		});		
	}
	function queryChatInfo(){
		let chatId = $(this).attr("chatid");
		callService({
			commandName: "QueryChatInfo",
			parameters:{
				chat_id:chatId
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					showAlert("The specified chat_id was not found");
					return;
				}
				let chatInfo = JSON.parse(data.records[0].chat_info);
				showObjectDetails({
					title:"Chat Info",
					data:chatInfo
				});
			}
		});
	}

	function resendMessages(messageIds){
		callService({
			commandName: "ResendMessages",
			parameters:{
				local_message_ids:messageIds
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					$.messager.alert({
						msg:`No message ID(s) found`,
						title:"Note",
						width:450,
						icon:"warn"
					});
					return;
				}
				let rows = gridMessageQueue.datagrid("getRows");
				$.each(data.records,function(index,item){
					let rowIndex = findItemIndexInArray(rows,"local_message_id",item.local_message_id);
					if(rowIndex > -1){
						gridMessageQueue.datagrid("updateRow",{
							index:rowIndex,
							row:item
						});
					}
				});
				onLoadSuccess();
			}
		});
	}
	
	function resendSingleMessage(){
		let localMessageId = $(this).attr("localmessageid");
		$.messager.confirm({
			title:'Confirm',
			msg:'Resend selected message(s)?',			
			width:400,
			fn:function(r){
				if(r){
					resendMessages(localMessageId);
				}
			}
		});
	}
	
	function viewMessageDetails(){
		let localMessageId = $(this).attr("localmessageid");
		if(!messageInfoDialog){
			messageInfoDialog = new MessageInfoDialog();			
		}
		messageInfoDialog.show({
			localMessageId:localMessageId
		});
	}

	let queryOpts = {
	};	
	this.setChatId = function(value){		
		queryOpts.chat_id = value;
	}
	this.setIds = function(value){
		queryOpts.ids = value;
	}
	this.setRequestId = function(value){
		queryOpts.request_id = value;
	}
	this.setStatusType = function(value){
		queryOpts.state = value;
	}
	this.setShowDeleted = function(value){
		queryOpts.showDeleted = value;
	}
	this.setOrder = function(value){
		queryOpts.order = value;
	}
	this.requery = function(){
		recCount = -1;
		page = 1;
		gridMessageQueue.datagrid("loadData",[]);
		query();
	}	
	let sendingPaused = false;
	function query(){
		girdStatusMgr.beforeQuery();
		if(recCount < 0){
			page = 1;
		}		
		callService({
			commandName: "QueryMessageQueue",
			parameters:{
				recCount:recCount,
				page:page,
				pageSize:pageSize,
				queryOpts:JSON.stringify(queryOpts)
			},
			onSuccess: function(data){
				gridMessageQueue.datagrid("loadData",data.records);
				if(data.tempVarsForClient){
					if(data.tempVarsForClient["record_count"]){
						recCount = parseInt(data.tempVarsForClient["record_count"]);
					}
					if(data.tempVarsForClient["message_sending_paused"]){
						updatePauseButtonState(data.tempVarsForClient["message_sending_paused"]); 
					}
				}
				pager.pagination("refresh", {
					pageSize: pageSize,
					total: recCount,
					pageNumber: page
				});
				girdStatusMgr.afterQuery();
				queryMessagesStatus();				
			}
		});
	}	

	let locked;
	let timerId;
	function queryMessagesStatus(){
		if(closed || locked){
			return;
		}
		locked = true;
		timerId = 0;
		let rows = gridMessageQueue.datagrid("getRows");
		let messageIds = [];
		$.each(rows,function(index,item){
			switch(item.state){
			case "W":
			case "E":
			case "R":
				messageIds.push(item.local_message_id);
				break;
			} 
		});
		if(messageIds.length == 0){
			if(!timerId)
				timerId = window.setTimeout(queryMessagesStatus,300);
			locked = false;
			return;
		}		
		sqlmessenger.helper.runSqlCommand({
			commandName: "QueryMessagesStatus",
			parameters: {
				message_ids:JSON.stringify(messageIds)
			},
			onSuccess: function(data){
				let rows = gridMessageQueue.datagrid("getRows");
				let records = data.records;
				$.each(records,function(index,item){					
					let rowIndex = findItemIndexInArray(rows,"local_message_id",item.local_message_id);
					if(rowIndex > -1){
						gridMessageQueue.datagrid("updateRow",{
							index:rowIndex,
							row:item
						});
					}
				});
				onLoadSuccess();
				if(!closed && !timerId){
					timerId = window.setTimeout(queryMessagesStatus,300);
				}
				locked = false;
			},
			onError: function(error){
				if(!closed && !timerId){
					timerId = window.setTimeout(queryMessagesStatus,300);
				}
				locked = false;
			}
		});
	}

	if(!inDialog){		
		query();
	}
	else{
		this.query = query;
	}
}

const showChildData = function(title,data){
	let detailsDialog = new ObjectDetailsDialog({
		destroyOnClose:true
	});
	let objectItemNames = [];
	$.each(data,function(key,value){
		if(typeof(value) == "object"){
			data[key] = JSON.stringify(value);
			objectItemNames.push(key);
		}
	});
	detailsDialog.show({
		title:title,
		data:data,
		callback:function(table){
			$.each(objectItemNames,function(index,item){
				let td = table.find("#" + item);
				if(td.length == 0){
					return;
				}
				td.addClass("link").attr("data-title",item).click(function(){
					let obj = $(this);
					let data = JSON.parse(obj.text());
					showChildData(obj.attr("data-title"),data);
				});
			});
		}
	});
}

const FetchedMessagesManager = function(env){
	let gridFetchedMessages = env.container;
	this.close = function(){
		
	};
	let girdStatusMgr;
	let pager;
	let page = 1,pageSize = 50,recCount = -1;
	let toolbar = [{
		text:"Refresh",
		iconCls:"toolbar-button-icon icon-refresh",
		handler:function(){
			recCount = -1;
			page = 1;
			query();
		}	
	},"-",{
		text:"Delete",
		iconCls:"toolbar-button-icon delete-message",
		handler:function(){
			deleteMessages();
		}	
	},"-",{
		text:"Help",
		iconCls:"toolbar-button-icon icon-help-20",
		handler:function(){
			window.open("https://www.sqlmessenger.com/manual/plugin-2-received-messages.htm");
		}
	}];
	let inDialog = env.inDialog === true;
	if(!inDialog){
		toolbar.push({
			text:"Exit",
			iconCls:"toolbar-button-icon icon-exit-20",
			handler:function(){
				mainTabs.tabs("close",fetchedMessagesManagerPanel.title);
			}	
		});
	}
	(function(){
		gridFetchedMessages.datagrid({
			border: false,
			fit: true,
			singleSelect: false,
			ctrlSelect:true,
			loadMsg: false,
			pagination:true,
			toolbar: toolbar,
			rownumbers:true,
			rowStyler:rowStyler,
			columns:[[{
				field:"x",
				checkbox:true
			},{
				field:"bot_id",
				title:"BotID",
				width:80,
				halign:"center"
			},{
				field:"update_id",
				title:"UpdateID",
				width:80,
				halign:"center"
			},{
				field:"bot_user_name",
				title:"BotUserName",
				width:130,
				halign:"center"
			},{
				field:"message_type",
				title:"MessageType",
				width:120,
				halign:"center"
			},{
				field:"detail_message_type",
				title:"MessageContentType",
				width:160,
				halign:"center"
			},{
				field:"chat_id",
				title:"Chat",
				width:130,
				halign:"center",
				formatter: function(value, row, index){
					let chatName = row.chat_title?row.chat_title:row.chat_user_name;
					chatName = chatName?HTMLEncode(chatName):value; 
					return `<span class="link btnChatInfo" localmessageid="${row.local_message_id}" chattype="chat">${chatName}</span>`;
				}
			},{
				field:"from_chat_id",
				title:"Sender",
				width:130,
				halign:"center",
				formatter: function(value, row, index){
					let chatName = row.from_chat_title;
					chatName = chatName?HTMLEncode(chatName):value; 
					return `<span class="link btnChatInfo" localmessageid="${row.local_message_id}" chattype="from">${chatName}</span>`;
				}
			},{
				field:"message_content",
				title:"Message",
				width:200,
				halign:"center",
				formatter: function(value, row, index){
					if(value && value.length > 500){
						value = value.substring(0,500) + "...";
					}
					return `<span class="link btnDetail" localmessageid='${row.local_message_id}'>${HTMLEncode(value)}</span>`;
				}
			},{
				field:"sent_time",
				title:"Sent Time",
				width:140,
				align:"center"
			},{
				field:"create_time",
				title:"FetchedTime",
				width:140,
				align:"center"
			},{
				field:"actions",
				title:"Actions",
				width:60,
				align:"center",
				formatter: function(value, row, index){
					return `<span class='grid-menu-icon btnDetail' title='View Message Details' localmessageid='${row.local_message_id}'><span class='menu-button-icon info-information-icon'></span></span>`;
				}
			}]],
			onLoadSuccess:onLoadSuccess
		});
		girdStatusMgr = GridStatusMgr({
			grid:gridFetchedMessages,
			idField:"local_message_id"
		});
		pager = gridFetchedMessages.datagrid("getPager");
		pager.pagination({
			total: 0,
			pageSize: pageSize,
			pageList: [10, 50, 100, 300, 500],
			onChangePageSize: function(newPageSize){
				pageSize = newPageSize;
				recCount = -1;
				query();
			},
			onSelectPage: function(pageNumber, pageSize){			
				page = pageNumber < 1 ? 1 : pageNumber;				
				query();
			}
		});
	})();

	function deleteMessages(){
		let rows = gridFetchedMessages.datagrid("getSelections");
		if(rows.length == 0){
			showAlert("Please select the record(s) to operate");
			return;
		}
		let ids = "";
		$.each(rows,function(index,item){
			ids += item.local_message_id + ",";
		});
		ids = ids.substring(0,ids.length - 1);
		$.messager.confirm({
			msg:`<div>Are you sure you want to delete the selected message(s)?</div>
<div><span style="font-weight:600;">Note: This action cannot be undone.</span></div>
`,
			width:400,
			title:"Question",
			fn:function(r){
				if(r){
					callService({
						commandName: "DeleteFetechedMessages",
						parameters:{
							local_message_ids:ids
						},
						onSuccess: function(data){
							window.setTimeout(function(){
								query();
							},10);
						}
					});
				}
			}
		});
	}
	
	function onLoadSuccess(){
		let parent = gridFetchedMessages.parent();
		let objs = parent.find(".btnChatInfo").not(".bound");
		objs.click(viewChatInfo);
		objs.addClass("bound");

		objs = parent.find(".btnDetail").not(".bound");
		objs.click(queryMessageDetails);
		objs.addClass("bound");
	}

	function queryMessageDetails(){
		let localMessageId = $(this).attr("localmessageid");
		callService({
			commandName: "QueryFetchedMessageDetails",
			parameters:{
				local_message_id:localMessageId
			},
			onSuccess: function(data){				
				if(data.records.length == 0){
					showAlert("No data found");
					return;
				}
				showObjectDetails({
					title:"Received Message Details",
					data:data.records[0],
					callback:function(table){
						table.find("#message_data").addClass("link").click(function(){
							let messageData = JSON.parse($(this).text());
							showChildData("Message Content",messageData);
						});
					}
				});
			}
		});
	}

	function viewChatInfo(){
		let localMessageId = $(this).attr("localmessageid");
		let chatType = $(this).attr("chattype");
		callService({
			commandName: "QueryFetchedMessageChatInfo",
			parameters:{
				local_message_id:localMessageId,
				type:chatType
			},
			onSuccess: function(data){				
				if(data.records.length == 0){
					showAlert("No data found");
					return;
				}
				showObjectDetails({
					title:"Chat Info",
					data:JSON.parse(data.records[0].chat_info)
				});
			}
		});
	}
	
	let queryOpts = {};
	queryOpts.chatId = "0";
	this.setChatId = function(value){
		queryOpts.chatId = value;
	}
	this.requery = function(){
		recCount = -1;
		page = 1;
		query();
	}
	function query(){
		girdStatusMgr.beforeQuery();
		if(recCount < 0){
			page = 1;
		}
		callService({
			commandName: "QueryFetchedMessageList",
			parameters:{
				recCount:recCount,
				page:page,
				pageSize:pageSize,
				queryOpts:JSON.stringify(queryOpts)
			},
			onSuccess: function(data){
				gridFetchedMessages.datagrid("loadData",data.records);
				if(data.tempVarsForClient && data.tempVarsForClient["record_count"]){
					recCount = parseInt(data.tempVarsForClient["record_count"]);
				}				
				pager.pagination("refresh", {
					pageSize: pageSize,
					total: recCount,
					pageNumber: page
				});
				girdStatusMgr.afterQuery();	
			}
		});
	}
	
	
	if(!inDialog){
		query();
	}
	else{
		this.query = query;
	}
}

const ChatInfoDialog = function(){	
	let dialog = $(`<div>
	<div id="tabs1">
		<div title="Chat Details">
			<div id="panel1">
				<div data-options="region:'north'" style="overflow:hidden;height:40px;border-style:none none solid none;border-color:#dddddd;background-color:#F4F4F4;padding:3px;">
					<span id="btnRefresh"></span>
				</div>
				<div data-options="region:'center',border:false" style="padding:5px;">
					<table class="dialog_ctrl_list list-table" id="infoTable" style="width:100%;">
						<tbody id="infoBody"></tbody>
					</table>
				</div>
			</div>
		</div>
		<div title="Received Messages">
			<div id="panelReceivedMessages"></div>
		</div>
		<div title="Sent Messages">
			<div id="panelSentMessages"></div>
		</div>		
	</div>`);
	function close(){
		if(fetchedMsgManager){
			fetchedMsgManager.close();
			fetchedMsgManager = null;
		}
		if(sentMessagesMgr){
			sentMessagesMgr.close();
			sentMessagesMgr = null;
		}
		dialog.dialog("destroy");
	}
	this.close = close;
	let tabs1;
	let fetchedMsgManager,fetchedMsgQueried;
	let sentMessagesMgr,sentMsgQueried;
	(function(){
		dialog.dialog({
			title:"Chat Details",
			width:document.body.clientWidth * 0.98,
			height:document.body.clientHeight * 0.98,
			closed:true,
			modal:true,
			maximizable: true,
			resizable: true,
			buttons:[{
				text:"Close",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		tabs1 = dialog.find("#tabs1");
		tabs1.tabs({
			fit:true,
			border:false,
			onSelect:function(title,index){
				switch(index){
				case 1:
					if(!fetchedMsgQueried){
						window.setTimeout(function(){
							fetchedMsgManager.requery();
							fetchedMsgQueried = true;
						},10);
					}
					break;
				case 2:
					if(!sentMsgQueried){
						window.setTimeout(function(){
							sentMessagesMgr.requery();
							sentMsgQueried = true;
						},10);
					}
					break;
				}
			}
		});
		dialog.find("#panel1").layout({
			fit:true
		});
		dialog.find("#btnRefresh").linkbutton({
			text:"Refresh",
			iconCls:"toolbar-button-icon icon-refresh",
			plain:true,
			onClick:queryChatInfo
		});
		fetchedMsgManager = new FetchedMessagesManager({
			container:dialog.find("#panelReceivedMessages"),
			inDialog:true
		});

		sentMessagesMgr = new MessageQueueManager({
			container:dialog.find("#panelSentMessages"),
			showFindBtn:true,
			inDialog:true
		});
	})();
	
	let logDetailsDialog;
	function viewLogDetails(){
		let logId = $(this).attr("logid");
		if(!logDetailsDialog){
			logDetailsDialog = $(`
<div style="padding:5px;">
	<table class="dialog_ctrl_list list-table" style="width:100%;">
		<tr>
			<td class="label">LogID</td><td class="cell"><span id="log_id"></span></td>
			<td class="label">LogType</td><td  class="cell"><span id="log_type"></span></td>
			<td class="label">LogTime</td><td  class="cell"><span id="log_time"></span></td>
			<td class="label">LocalMessageID</td><td class="cell"><span id="local_message_id"></span></td>
		</tr>
		<tr>
			<td class="label">ResultData</td><td  class="cell" colspan=7><span id="result_data"></span></td>
		</tr>
	</table>
</div>`);
			logDetailsDialog.dialog({
				title:"Log Details",
				width:document.body.clientWidth * 0.7,
				height:document.body.clientHeight * 0.9,
				closed:true,
				modal:true,
				maximizable: true,
	            resizable: true,
				buttons:[{
					text:"Close",
					width:80,
					handler:function(){
					logDetailsDialog.dialog("close");
					}	
				}]
			});
		}
		callService({
			commandName: "QueryLogDetails",
			parameters:{
				log_id:logId
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					showAlert("Specified log record does not exist");
					return;
				}
				let logInfo = data.records[0];
				$.each(logInfo,function(key,value){
					logDetailsDialog.find("#" + key).text(value);
				});
				logDetailsDialog.dialog("open");
			}
		});
	}
	
	let localChatId;
	let showed;
	this.show = function(params){
		fetchedMsgQueried = false;
		sentMsgQueried = false;
		showed = false;		
		localChatId = params.localChatId;		
		queryChatInfo();
	}
	

	function queryChatInfo(){
		callService({
			commandName: "QueryChatDetails",
			parameters:{
				local_chat_id:localChatId
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					$.messager.alert({
						msg:"Specified local_chat_id not found",
						title:"Note",
						icon:"info",
						width:450
					});
					return;
				}
				let chatInfo = data.records[0];
				let infoBody = dialog.find("#infoBody");
				infoBody.remove();
				infoBody = $("<tbody id='infoBody'></tbody>");
				dialog.find("#infoTable").append(infoBody);
				fetchedMsgManager.setChatId(chatInfo.chat_id);
				sentMessagesMgr.setChatId(chatInfo.chat_id);
				$.each(chatInfo,function(key,value){
					let tr = $(`<tr></tr>`);
					let td = $(`<td class="label"></td>`);
					td.text(key);
					tr.append(td);
					
					td = $(`<td class="cell"></td>`);
					td.prop(`id`,key);
					td.text(value === null?`[NULL]`:value);					
					switch(key){
					case "chat_info":
					case "first_message":
						if(value){
							td.addClass("link").attr("data-title",key).click(function(){
								let obj = $(this);
								let data = JSON.parse(obj.text());
								showChildData(obj.attr("data-title"),data);
							});
						}
						break;
					}
					 
					tr.append(td);
					infoBody.append(tr);
				});
				if(!showed){
					dialog.dialog("open");
					tabs1.tabs("select",0);
					showed = true;
				}
			}
		});
	}
}

const ChatListMessagesManager = function(){
	let gridChatList = $("#panelChatListManager");
	this.close = function(){
		if(chatInfoDialog){
			chatInfoDialog.close();
			chatInfoDialog = null;
		}
		if(exportChatsDialog){
			exportChatsDialog.dialog("destroy");
			exportChatsDialog = null;
		}
	};
	let girdStatusMgr;
	let pager;
	let page = 1,pageSize = 50,recCount = -1;
	(function(){
		gridChatList.datagrid({
			border: false,
			fit: true,
			singleSelect: false,
			ctrlSelect:true,
			loadMsg: false,
			pagination:true,
			toolbar: [{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					query();
				}	
			},{
				text:"Export",
				iconCls:"toolbar-button-icon export-icon",
				handler:function(){
					exportChats();
				}	
			},"-",{
				text:"Delete",
				iconCls:"toolbar-button-icon delete-message",
				handler:function(){
					deleteChats();
				}	
			},"-",{
				text:"Help",
				iconCls:"toolbar-button-icon icon-help-20",
				handler:function(){
					window.open("https://www.sqlmessenger.com/manual/plugin-2-chat-list-manager.htm");
				}
			},{
				text:"Exit",
				iconCls:"toolbar-button-icon icon-exit-20",
				handler:function(){
					mainTabs.tabs("close",chatListMessagesManagerPanel.title);
				}	
			}],
			rownumbers:true,
			rowStyler:rowStyler,
			columns:[[{
				field:"x",
				checkbox:true
			},{
				field:"chat_id",
				title:"ChatID",
				width:130,
				halign:"center"
			},{
				field:"chat_type",
				title:"ChatType",
				width:120,
				align:"center"
			},{
				field:"chat_title",
				title:"ChatTitle",
				width:200,
				halign:"center",
				formatter: function(value, row, index){
					return `<span class="link btnDetail" localchatid="${row.local_chat_id}">${HTMLEncode(value)}</span>`;
				}
			},{
				field:"chat_user_name",
				title:"UserName",
				width:200,
				halign:"center",
				formatter: function(value, row, index){
					return `<span class="link btnDetail" localchatid="${row.local_chat_id}">${HTMLEncode(value)}</span>`;
				}
			},{
				field:"first_name",
				title:"FirstName",
				width:80,
				halign:"center"
			},{
				field:"last_name",
				title:"LastName",
				width:80,
				halign:"center"
			},{
				field:"bot_id",
				title:"FoundByBotID",
				width:150,
				halign:"center"
			},{
				field:"bot_user_name",
				title:"FoundByBot",
				width:150,
				halign:"center"
			},{
				field:"create_time",
				title:"ImportedTime",
				width:140,
				align:"center"
			},{
				field:"actions",
				title:"Actions",
				width:60,
				align:"center",
				formatter: function(value, row, index){
					return `<span class='grid-menu-icon btnDetail' title='View Chat Details' localchatid='${row.local_chat_id}'><span class='menu-button-icon info-information-icon'></span></span>`;
				}
			}]],
			onLoadSuccess:onLoadSuccess
		});
		girdStatusMgr = GridStatusMgr({
			grid:gridChatList,
			idField:"local_chat_id"
		});
		pager = gridChatList.datagrid("getPager");
		pager.pagination({
			total: 0,
			pageSize: pageSize,
			pageList: [10, 50, 100, 300, 500],
			onChangePageSize: function(newPageSize){
				pageSize = newPageSize;
				recCount = -1;
				query();
			},
			onSelectPage: function(pageNumber, pageSize){			
				page = pageNumber < 1 ? 1 : pageNumber;				
				query();
			}
		});
	})();

	let exportChatsDialog;
	function exportChats(){
		if(!exportChatsDialog){
			exportChatsDialog = $(`<div style="padding:5px;">
	<table class='dialog_ctrl_list'>
		<tr><td colspan="2">Select chat scope for export:</td></tr>
		<tr><td style="width:1%;"><input type="radio" name="chkScope" id="chkAllChats" checked="1"></td><td><label for="chkAllChats">Export all chats</label></td></tr>
		<tr><td style="width:1%;"><input type="radio" name="chkScope" id="chkSelectedChats"></td><td><label for="chkSelectedChats">Export selected chats</label></td></tr>
	</table>
</div>`);
			exportChatsDialog.dialog({
				title:"Export Chat List",
				width:400,
				height:200,
				closed:true,
				modal:true,
				buttons:[{
					text:"OK",
					width:80,
					handler:function(){
						let scope = exportChatsDialog.find("#chkSelectedChats").prop("checked")?"selected":"all";
						let ids;
						if(scope == "selected"){
							let rows = gridChatList.datagrid("getSelections");
							if(rows.length == 0){
								showAlert("Please select the record(s) to operate");
								return;
							}
							ids = "";
							$.each(rows,function(index,item){
								ids += item.local_chat_id + ",";
							});
							ids = ids.substring(0,ids.length - 1);
						}
						else{
							ids = "0";
						}
						let message = {
							"command":"runTask",
							"taskName":"Telebot_ExportChatList",
							"dialogId":$(window.frameElement).attr("dialogid"),
							"values":`ChatIds:"${ids}"`,
							"options":`autoStartQuery:true,showInputPanel:false,downloadAttach:true`
						};
						window.parent.postMessage("command:" + JSON.stringify(message));
						exportChatsDialog.dialog("close");	
					}
				},{
					id:"btnCancel",
					text:"Cancel",
					width:80,
					handler:function(){
						exportChatsDialog.dialog("close");
					}	
				}]
			});
		}
		exportChatsDialog.dialog("open");
	}

	function deleteChats(){
		let rows = gridChatList.datagrid("getSelections");
		if(rows.length == 0){
			showAlert("Please select the record(s) to operate");
			return;
		}
		let ids = "";
		$.each(rows,function(index,item){
			ids += item.local_chat_id + ",";
		});
		ids = ids.substring(0,ids.length - 1);
		$.messager.confirm({
			msg:`<div>Are you sure you want to delete the selected chat(s)?</div>
<div>
<p style="font-weight:600;">Note: </p>
<p style="display:list-item;">This action cannot be undone.</p>
<p style="display:list-item;">If Telebot receives a new message from any of these chats, it will automatically add the chat back to your "Chat List".</p>
</div>
`,
			width:500,
			title:"Question",
			fn:function(r){
				if(r){
					callService({
						commandName: "DeleteChat",
						parameters:{
							local_chat_ids:ids
						},
						onSuccess: function(data){
							window.setTimeout(function(){
								query();
							},10);
						}
					});
				}
			}
		});
	}
	
	function onLoadSuccess(){
		let parent = gridChatList.parent();
		let objs = parent.find(".btnDetail").not(".bound");
		objs.click(viewChatDetails);
		objs.addClass("bound");
	}
	function queryMessageDetails(){
		let localMessageId = $(this).attr("localmessageid");
		callService({
			commandName: "QueryFetchedMessageDetails",
			parameters:{
				local_message_id:localMessageId
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					showAlert("No data found");
					return;
				}
				showObjectDetails({
					title:"Received Message Details",
					data:data.records[0],
					callback:function(table){
						table.find("#message_data").addClass("link").click(function(){
							let messageData = JSON.parse($(this).text());
							showChildData("Message Content",messageData);
						});
					}
				});
			}
		});
	}

	let chatInfoDialog;
	function viewChatDetails(){
		let localChatId = $(this).attr("localchatid");
		if(!chatInfoDialog){
			chatInfoDialog = new ChatInfoDialog();
		}
		chatInfoDialog.show({
			localChatId:localChatId
		});
	}
	
	let queryOpts = {};	
	function query(){
		girdStatusMgr.beforeQuery();
		if(recCount < 0){
			page = 1;
		}
		callService({
			commandName: "QueryChatList",
			parameters:{
				recCount:recCount,
				page:page,
				pageSize:pageSize,
				queryOpts:JSON.stringify(queryOpts)
			},
			onSuccess: function(data){
				gridChatList.datagrid("loadData",data.records);
				if(data.tempVarsForClient && data.tempVarsForClient["record_count"]){
					recCount = parseInt(data.tempVarsForClient["record_count"]);
				}				
				pager.pagination("refresh", {
					pageSize: pageSize,
					total: recCount,
					pageNumber: page
				});
				girdStatusMgr.afterQuery();	
			}
		});
	}

	(function(){
		query();
	})();
}


const KeywordsEditor = function(){
	let dialog = $(`
<div style="padding:5px;overflow-x:hidden;">
	<table class='dialog_ctrl_list' style="width:100%;">
		<tr><td class="ctrlLabel">Keyword</td><td><span id="txtKeywords" style="width:500px;"></span></td></tr>		
		<tr><td colspan="2"><span id="txtSubject" style="width:563px;"></td></tr>
		<tr><td colspan="2" style="white-space:normal;"><span id="labResult"></td></tr>
	</table>			
</div>`);
	this.close = function(){
		dialog.dialog("destroy");
	}
	let txtSubject,txtKeywords, focusedBox;
	(function(){
		dialog.dialog({
			title:"Keyword Editor",
			width:600,
			height:300,
			closed:true,
			modal:true,
			buttons:[{
				text:"Test",
				width:80,
				handler:test
			},{
				id:"btnOK",
				text:"OK",
				width:80,
				handler:onOK
			},{
				id:"btnClose",
				text:"Cancel",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		txtSubject = dialog.find("#txtSubject");
		txtSubject.textbox({
			multiline:true,
			height:100
		});
		txtSubject.textbox("textbox").on("focus",onTextboxFocus);
		txtKeywords = dialog.find("#txtKeywords");
		txtKeywords.textbox({});
		txtKeywords.textbox("textbox").on("focus",onTextboxFocus);	
	})();
	createHelpButton20(dialog,"https://www.sqlmessenger.com/manual/plugin-1-keyword-format.htm");
	function onTextboxFocus(){
		focusedBox = $(this);
	}

	let typeName;
	let callback;
	this.show = function(params){
		if(params.testOnly === true){
			let wnd = dialog.dialog("window");
			wnd.find("#btnOK").hide();
			wnd.find("btnCancel").find(".l-btn-text").text("Close");
		}
		else{
			let wnd = dialog.dialog("window");
			wnd.find("#btnOK").show();
			wnd.find("btnCancel").find(".l-btn-text").text("Cancel");
		}
		if(params.type == 2){
			typeName = `Attachment Name`;
			txtSubject.textbox("textbox").prop("placeholder",`Enter a attachment name and click "Test" to verify keyword matching.`);
		}
		else{
			typeName = `Email Subject`;
			txtSubject.textbox("textbox").prop("placeholder",`Enter an email subject and click "Test" to verify keyword matching.`);
		}
		callback = params.callback;
		
		txtKeywords.textbox("setValue",params.keywords);
		dialog.dialog("open");
		txtKeywords.textbox("textbox").focus();
	}
	
	function test(){
		let subject = txtSubject.textbox("getValue");
		if(!subject){
			showAlert(`"${typeName}" cannot be empty`);
			txtSubject.textbox("textbox").focus();
			return;
		}
		let keywords = txtKeywords.textbox("getValue");
		if(!keywords){
			showAlert(`"Keyword" cannot be empty`);
			txtKeywords.textbox("textbox").focus();
			return;
		}
		callService({
			commandName: "KeywordsTestForEditor",
			parameters: {
				"subject": subject,
				"keywords":keywords
			},
			onSuccess: function(data){
				if(data.records.length > 0){
					dialog.find("#labResult").html(`<p style="font-weight:600;color:#4e4e90;">Success! The keyword "${HTMLEncode(keywords)}" was successfully matched in ${typeName.toLowerCase()} "${HTMLEncode(subject)}"</p>`);
				}
				else{
					dialog.find("#labResult").html(`<p style="font-weight:600;color:red;">Failed. No match found for keyword "${HTMLEncode(keywords)}' in ${typeName.toLowerCase()} "${HTMLEncode(subject)}".</p>`);
				}
				focusedBox.focus();
			}
		});	
	}
	function onOK(){		
		let keywords = txtKeywords.textbox("getValue");
		if(!keywords){
			showAlert(`"Keyword" cannot be empty`);
			txtKeywords.textbox("textbox").focus();
			return;
		}
		callback.call(this,keywords);
		dialog.dialog("close");
	}
}

const FindMessageDialog = function(env){
	let dialog = $(`<div style="padding:5px;">
	<table class="dialog_ctrl_list">
		<tr>
			<td class="ctrlLabel">Send By Bot</td><td><span id="lstBot" style="width:400px;"></span></td>
		</tr>
		<tr>
			<td class="ctrlLabel">Sending State</td><td><span id="lstState" style="width:400px;"></span></td>
		</tr>
		<tr>
			<td class="ctrlLabel">Created Time, From</td><td><span id="txtStartDate" style="width:188px;"></span> To <span id="txtEndDate" style="width:189px;"></span></td>
		</tr>
	</table>
</div>`);
	dialog.dialog({
		title:"Find Message",
		width:700,
		height:400,
		closed:true,
		modal:true,
		buttons:[{
			text:"Clear",
			width:80,
			handler:function(){
				lstBot.combobox("setValues",[]);
				lstState.combobox("setValues",[]);
				txtStartDate.datebox("setValue","");
				txtEndDate.datebox("setValue","");
			}
		},{
			text:"Find",
			width:80,
			handler:function(){
				queryOpts = {};
				let value = lstBot.combobox("getValues");
				if(value && value.length > 0)
					queryOpts.bots = JSON.stringify(value);
				
				value = lstState.combobox("getValues");
				if(value && value.length > 0)
					queryOpts.state = JSON.stringify(value);
				value = txtStartDate.datebox("getValue");
				if(value)
					queryOpts.start_date = value;
				value = txtEndDate.datebox("getValue");
				if(value)
					queryOpts.end_date = value;
				if(JSON.stringify(queryOpts) != "{}"){
					btnFind.linkbutton("select");
				}
				else{
					btnFind.linkbutton("unselect");
				}
				callback.apply(this,[queryOpts]);
				dialog.dialog("close");
			}
		},{
			text:"Cancel",
			width:80,
			handler:function(){
				dialog.dialog("close");
			}	
		}]
	});
	function close(){
		dialog.dialog("destroy");
	}
	this.close = close;

	let btnFind = env.btnFind;
	let lstBot,lstState,txtStartDate,txtEndDate;
	(function(){
		lstBot = dialog.find("#lstBot");
		lstBot.combobox(buildCheckboxComboboxOpts({
			valueField:"bot_id",
			textField:"bot_user_name",
			editable:false,
            multiple:true,
            prompt:"Any"
		},"FindMessageDialog"));
		lstState = dialog.find("#lstState");
		lstState.combobox(buildCheckboxComboboxOpts({
			valueField:"id",
			textField:"name",
			editable:false,
            multiple:true,
            prompt:"Any",
            data:[{
                id:"W",
                name:"Pending"
            },{
                id:"R",
                name:"Sending"
            },{
                id:"C",
                name:"Sent Successfully"
            },{
                id:"E",
                name:"Send Error(Retry Later)"
            },{
                id:"F",
                name:"Send Failed"
            },{
                id:"P",
                name:"Expired"
            }]			
		},"FindMessageDialog"));
		txtStartDate = dialog.find("#txtStartDate");
		txtStartDate.datebox({});
		txtEndDate = dialog.find("#txtEndDate");
		txtEndDate.datebox({});
	})();
	
	let botListLoaded = false;
	let showed;
	let callback;
	this.show = function(params){
		callback = params.callback;
		showed = false;
		if(!botListLoaded){
			quertBotList();
		}
		else{
			dialog.dialog("open");
			showed = true;
		}
	}
	function quertBotList(){
		callService({
			commandName: "QueryBotList",
			onSuccess: function(data){
				lstBot.combobox("loadData",data.records);
				if(!showed){
					dialog.dialog("open");
					showed = true;
				}
			}
		});
	}
}

const EmailForwardRuleConfigDialog = function(){
	let helpPanelId = generateUUID();
	let dialog = $(`
<div>
	<div id="panel1">
		<div data-options="region:'west',border:false" style="width:740px;padding:5px;">
			<table class='dialog_ctrl_list'>
				<tr id='trRuleId'><td class="ctrlLabel">Rule ID</td><td><span id='labRuleId'></span></td></tr>
				<tr><td class="ctrlLabel">Apply to Emails Received By</td><td><span id='lstEmailAcct' style='width:400px;'></span>&nbsp;<span id="btnRefreshEmailAcct" title="Refresh email account list"></span>&nbsp;<span id="btnClearEmailAcct" title="Clear selected value"></span></td></tr>
				<tr><td></td><td><span id="btnAddMailAcct"></span></td></tr>
				<tr><td class="ctrlLabel">Keyword in Subject</td><td><span id='txtKeywordInSubject' style='width:400px;'></span></td></tr>
				<tr><td class="ctrlLabel" id="labSenderEmail">Sender Email Addresses</td><td><span id='txtSenderEmail' style='width:400px;'></span></td></tr>
				<tr>
					<td></td>
					<td style='padding-left:0px;padding-right:0px;'>
						<table>
							<tr>
								<td style='padding-left:1px;'><input type='checkbox' id='chkSkipSenderAddrChk'></td>
								<td style='padding-left:0px;'><label for='chkSkipSenderAddrChk' style='margin-top:-4px;' class="method1">Skip Sender Address Check for Forwarding</label></td>
							</tr>
						</table>
					</td>
				</tr>
				<tr><td class="ctrlLabel">Forward Emails via Bot</td><td><span id='lstBot' style='width:400px;'></span></td></tr>
				<tr><td class="ctrlLabel">Forward Emails to Chat</td><td><span id='lstChat' style='width:400px;'></span>&nbsp;<span id="btnRefreshChatList" title="Refresh chat list"></span>&nbsp;<span id="btnClearChatList" title="Clear selected value"></span></td></tr>
				<tr><td class="ctrlLabel">Forward Selected Parts of the Emails</td><td><span id='lstForwardPart' style='width:400px;'></span></td></tr>
				<tr><td class="ctrlLabel">Convert Email Body to</td><td><span id='lstTransformBody' style='width:400px;'></span></td></tr>
				<tr><td style='vertical-align:top;' class="ctrlLabel">Remark</td><td><span id='txtComments' style='width:400px;'></span></td></tr>
				<tr id="trWarn" style="dispaly:none;"><td colspan=2 style="white-space:normal;"><span style="color:red;">Note: Here is the rule configuration at the time the email was forwarded. It may differ from the current configuration of this rule.</span></td></tr>
			</table>
		</div>
		<div data-options="region:'center'" id="${helpPanelId}" class="help-panel">
		</div>
	</div>
</div>`);
	function close(){
		if(inputDialog){
			inputDialog.dialog("destroy");
			inputDialog = null;
		}
		dialog.dialog("destroy");
	}
	this.close = close;
	
	let txtSenderEmail, lstEmailAcct, txtKeywordInSubject, txtBotId;
	let chkSkipSenderAddrChk, lstChat, lstTransformBody, lstForwardPart;
	let selectChatDialog;
	let pager;
	let page = 1,pageSize = 50,recCount = -1;	
	let keywordsEditor;
	(function(){
		dialog.dialog({
			title:"Telebot - Email Forward Rule Config",
			width:1050,
			height:550,
			closed:true,
			modal:true,
			buttons:[{
				id:"btnOK",
				text:"OK",
				width:80,
				handler:onOK
			},{
				text:"Cancel",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		createHelpButton20(dialog,"https://www.sqlmessenger.com/manual/plugin-2-email-forwarding-config.htm#configdialog");
		dialog.find("#panel1").layout({
			fit:true
		});
		txtSenderEmail = dialog.find("#txtSenderEmail");
		txtSenderEmail.textbox({
			buttonText:"...",
			onClickButton:editSenderEmail
		});
		addHelp(txtSenderEmail.textbox("textbox"),helpPanelId,"EmailForwardRuleConfigDialog.txtSenderEmail");

		
		lstEmailAcct = dialog.find("#lstEmailAcct");
		lstEmailAcct.combobox(buildCheckboxComboboxOpts({
			valueField:"mail_addr",
			textField:"mail_addr",
			editable:false,
            multiple:true
		},"EmailForwardRuleConfigDialog"));
		addHelp(lstEmailAcct.combobox("textbox"),helpPanelId,"EmailForwardRuleConfigDialog.lstEmailAcct");

		txtKeywordInSubject = dialog.find("#txtKeywordInSubject");
		txtKeywordInSubject.textbox({
			buttonText : "...",
			onClickButton:function(){
				let keywords = txtKeywordInSubject.textbox("getValue");
				if(!keywordsEditor){
					keywordsEditor = new KeywordsEditor();
				}
				keywordsEditor.show({
					type:1,
					keywords:keywords,
					callback:function(newKeywords){
						txtKeywordInSubject.textbox("setValue",newKeywords);
						txtKeywordInSubject.textbox("textbox").focus();
					}
				});
			}
		});
		addHelp(txtKeywordInSubject.textbox("textbox"),helpPanelId,"EmailForwardRuleConfigDialog.txtKeywordInSubject");

		lstBot = dialog.find("#lstBot");
		lstBot.combobox({
			valueField:"bot_id",
			textField:"bot_user_name",
			editable:false
		});
		addHelp(lstBot.combobox("textbox"),helpPanelId,"EmailForwardRuleConfigDialog.lstBot");

		chkSkipSenderAddrChk = dialog.find("#chkSkipSenderAddrChk");
		chkSkipSenderAddrChk.click(updateCtrlState);
		addHelp(chkSkipSenderAddrChk,helpPanelId,"EmailForwardRuleConfigDialog.chkSkipSenderAddrChk");

		lstChat = dialog.find("#lstChat");
		lstChat.combogrid({
			delay: 500,
			panelWidth: 550,
			idField:"chat_id",
			textField:"chat_name",
			editable:false,
			pagination:true,
			columns: [[{
				field: 'chat_id',
				title: "ChatID",
				width: 130,
				halign: "center"
			}, {
				field: 'chat_name',
				title: "ChatName",
				width: 280,
				halign: "center",
				formatter: function(value,row,index){
					return HTMLEncode(`(${HTMLEncode(row.chat_type)})${HTMLEncode(row.chat_name)}`); 
				}
			}, {
				field: 'chat_user_name',
				title: "Username",
				width: 120,
				halign: "center",
				formatter: function(value, row, index){
					return `<span>${HTMLEncode(row.first_name)} ${HTMLEncode(row.last_name)}`; 
				}
			}]],
			onShowPanel:onShowChatPanel
		});
		pager = lstChat.combogrid("grid").datagrid("getPager");
		pager.pagination({
			total: 0,
			pageSize: pageSize,
			pageList: [10, 50, 100, 300, 500],
			onChangePageSize: function(newPageSize){
				pageSize = newPageSize;
				recCount = -1;
				queryChatList();
			},
			onSelectPage: function(pageNumber, pageSize){			
				page = pageNumber < 1 ? 1 : pageNumber;				
				queryChatList();
			}
		});
		addHelp(lstChat.combogrid("textbox"),helpPanelId,"EmailForwardRuleConfigDialog.lstChat");

		txtComments = dialog.find("#txtComments");
		txtComments.textbox({
			multiline:true,
			height:100
		});
		addHelp(txtComments.textbox("textbox"),helpPanelId,"EmailForwardRuleConfigDialog.txtComments");

		lstTransformBody = dialog.find("#lstTransformBody");
		lstTransformBody.combobox({
			valueField:"id",
			textField:"name",
			editable:false,
			data:[{
				id:1,
				name:"Plain Text"
			},{
				id:2,
				name:"PDF"
			},{
				id:3,
				name:"PNG Image"
			},{
			}]
		});
		addHelp(lstTransformBody.combobox("textbox"),helpPanelId,"EmailForwardRuleConfigDialog.lstTransformBody");

		let btn = dialog.find("#btnRefreshEmailAcct");
		btn.linkbutton({
			width:25,
			height:22,
			iconCls:"toolbar-button-icon icon-refresh",
			onClick:function(){
				queryMailAcctList();
			}
		});
		btn = dialog.find("#btnClearEmailAcct");
		btn.linkbutton({
			width:25,
			height:22,
			iconCls:"toolbar-button-icon icon-clear20",
			onClick:function(){
				lstEmailAcct.combobox("clear");
			}
		});
		
		btn = dialog.find("#btnRefreshChatList");
		btn.linkbutton({
			width:25,
			height:22,
			iconCls:"toolbar-button-icon icon-refresh",
			onClick:function(){
				recCount = -1;
				page = 1;
				queryChatList(lastBotId);
			}
		});

		btn = dialog.find("#btnClearChatList");
		btn.linkbutton({
			width:25,
			height:22,
			iconCls:"toolbar-button-icon icon-clear20",
			onClick:function(){
				recCount = -1;
				page = 1;
				lstChat.combogrid("clear");
			}
		});
		let btnAddMailAcct = dialog.find("#btnAddMailAcct");
		btnAddMailAcct.linkbutton({
			text:"Add Email Account",
			onClick:function(){
				window.top.addMailAcct({
					dialogId:$(window.frameElement).attr("dialogid"),
					callback:function(acctInfo){
						let rows = lstEmailAcct.combobox("getData");
						rows.push({
							mail_account_id:acctInfo.mailAcctId,
							mail_addr:acctInfo.mailAddr,
							state:acctInfo.state
						});
						lstEmailAcct.combobox("loadData",rows);
						window.setTimeout(function(){
							lstEmailAcct.combobox("showPanel");
						},500);
					}
				});
			}
		});

		lstForwardPart = dialog.find("#lstForwardPart");
		lstForwardPart.combobox(buildCheckboxComboboxOpts({
			valueField:"id",
			textField:"name",
			editable:false,
            multiple:true
		},"EmailForwardRuleConfigDialog"));
		addHelp(lstForwardPart.combobox("textbox"),helpPanelId,"EmailForwardRuleConfigDialog.lstForwardPart");
	})();

	let emailParts = [{
        id:1,
        name:"Email header (includes subject)"
    },{
        id:2,
        name:"Email body"
    },{
        id:3,
        name:"Attachments"
    }];

	let lastBotId;
	function onShowChatPanel(){
		let botId = lstBot.combobox("getValue");
		if(!botId){
			lstChat.combogrid("hidePanel");
			$.messager.alert({
				title:"Note",
				msg:"Please select a bot first",
				icon:"info",
				width:400,
				fn:function(){
					lstBot.combobox("showPanel");
				}
			});
			return;
		}
		if(lastBotId != botId){
			lstChat.combogrid("hidePanel");
			recCount = -1;
			page = 1;
			queryChatList(botId);
		}
	}
	let inputDialog, txtTextBox;
	function editSenderEmail(){		
		if(!inputDialog){
			inputDialog = $("<div style='border-style:none;'><div id='txtTextBox' style='width:100%;'></div></div>");
			dialog.append(inputDialog);
			inputDialog.dialog({
				title:"Edit Sender Email Addresses",
				width:600,
				height:300,
				closed:true,
				inline:true,
				modal:true,
				buttons:[{
					text:"OK",
					width:80,
					handler:function(){
						let text = txtTextBox.textbox("getValue");
						let addrs = [];
						if(text){
							let vs = text.split("\n");						
							$.each(vs,function(index,item){
								item = item.trim();
								if(!item){
									return;
								}
								if(item.indexOf(";") > -1){
									let vs2 = item.split(";");
									$.each(vs2,function(index,item){
										item = item.trim();
										if(item)
											addrs.push(item);
									});
								}
								else{
									addrs.push(item.trim());
								}
							});
						}
						let checked = true;
						text = "";
						$.each(addrs,function(index,item){
							if(!item.match(/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)*$/ig)){
								$.messager.alert({
									title:"Error",
									msg:"Email address is incorrect: " + item,
									icon:"warning",
									fn:function(){
										txtTextBox.textbox("textbox").focus();
									}
								});
								checked = false;
								return false;
							}
							text += item + ";";
						});
						if(!checked){
							return;
						}
						txtSenderEmail.textbox("setValue",text.substring(0,text.length - 1));
						inputDialog.dialog("close");			
					}
				},{
					text:"Cancel",
					width:80,
					handler:function(){
						inputDialog.dialog("close");
					}	
				}]
			});
			txtTextBox = inputDialog.find("#txtTextBox");
			txtTextBox.textbox({
				multiline:true,
				height:"100%",
				prompt:`Enter one email address per line, or separate multiple email addresses in a single line with ";".`
			});
			txtTextBox.parent().prev().css("border-bottom-style","none");
		}
		let text = txtSenderEmail.textbox("getValue");
		if(text){
			let addrs = text.split(";");
			let t = ""; 
			$.each(addrs,function(index,item){
				t += item + "\n";
			}); 
			txtTextBox.textbox("setValue",t);
		}
		else{
			txtTextBox.textbox("setValue","");
		}
		inputDialog.dialog("open");
		txtTextBox.textbox("textbox").focus();
	}

	function queryChatList(botId,callback){
		if(!botId){
			onShowChatPanel();
			return;
		}
		if(recCount < 0){
			page = 1;
		}
		if(botId === undefined){
			botId = lastBotId;
		}
		callService({
			commandName: "QueryBotChatList",
			parameters:{
				recCount:recCount,
				page:page,
				pageSize:pageSize,
				botId:botId
			},
			onSuccess: function(data){
				lstChat.combogrid("grid").datagrid("loadData",data.records);
				if(data.tempVarsForClient && data.tempVarsForClient["record_count"]){
					recCount = parseInt(data.tempVarsForClient["record_count"]);
				}				
				pager.pagination("refresh", {
					pageSize: pageSize,
					total: recCount,
					pageNumber: page
				});
				lastBotId = botId;
				if(showed){
					lstChat.combogrid("showPanel");
				}
				if(callback){
					callback.apply(this,[]);
				}
			},
			onError:function(errorMsg){
				lstChat.combogrid("hidePanel");
				$.messager.alert({
			    	title:'Error2',
			    	msg:errorMsg,
			    	icon:'error',
			    	width:500
			    });
			}
		});
	}
	
	function updateCtrlState(){
		chkSkipSenderAddrChk.prop("disabled",false);
		if(chkSkipSenderAddrChk.prop("checked")){
			dialog.find("#labSenderEmail").css("color","#c0c0c0");
			txtSenderEmail.textbox("disable");
		}
		else{
			dialog.find("#labSenderEmail").css("color","");
			txtSenderEmail.textbox("enable");
		}
	}
	function listToString(list,field){
		let rst = "";
		$.each(list,function(index,item){
			let value = field?item[field]:item;
			rst += value + ";";
		});
		if(rst.length > 0){
			rst = rst.substring(0,rst.length - 1);
		}
		return rst;
	}
	let callback;
	let ruleId;
	let showed;
	let readonly;
	let config;
	this.show = function(params){
		ruleId = params.ruleId;
		callback = params.callback;
		lastBotId = null;
		let botId;
		showed = false;
		readonly = params.readonly === true?true:false;
		
		if(params.config){
			config = params.config;
			dialog.find("#trRuleId").show();					
			dialog.find("#labRuleId").text(config.rule_id);
			chkSkipSenderAddrChk.prop("checked",config.skip_sender_addr_chk == "1");
			lstEmailAcct.combobox("setValues",config.received_by_email_addr.split(";"));
			txtKeywordInSubject.textbox("setValue",config.subject_keyword);
			txtSenderEmail.textbox("setValue",config.from_email_addr);
			lstBot.combobox("setValue",config.send_via_bot_id);
			lstChat.combogrid("setValue",config.send_to_chat_id);
			lstTransformBody.combobox("setValue",config.convert_body_as);
			txtComments.textbox("setValue",config.comments);
			let parts = config.forward_email_parts?typeof(config.forward_email_parts) == "object"?config.forward_email_parts:JSON.parse(config.forward_email_parts):[];
			lstForwardPart.combobox("setValues",parts);
			lstForwardPart.combobox("loadData",emailParts);			
			botId = lstBot.combobox("getValue");
			dialog.find("#trWarn").show();
			queryChatList(botId,function(){
				__f1();
			});
		}
		else if(ruleId){
			dialog.find("#trWarn").hide();
			callService({
				commandName: "QueryEmailFarwardRuleConfig",
				parameters:{
					rule_id:ruleId
				},
				onSuccess: function(data){
					if(data.records.length == 0){
						shoeAlert("No data found");
						return;
					}
					config = data.records[0];					
					dialog.find("#trRuleId").show();					
					dialog.find("#labRuleId").text(ruleId);
					chkSkipSenderAddrChk.prop("checked",config.skip_sender_addr_chk == "1");
					lstEmailAcct.combobox("setValues",config.received_by_email_addr.split(";"));
					txtKeywordInSubject.textbox("setValue",config.subject_keyword);
					txtSenderEmail.textbox("setValue",config.from_email_addr);
					lstBot.combobox("setValue",config.send_via_bot_id);
					lstChat.combogrid("setValue",config.send_to_chat_id);
					lstTransformBody.combobox("setValue",config.convert_body_as);
					txtComments.textbox("setValue",config.comments);
					lstForwardPart.combobox("setValues",config.forward_email_parts?JSON.parse(config.forward_email_parts):[]);
					lstForwardPart.combobox("loadData",emailParts);
					botId = lstBot.combobox("getValue");
					queryChatList(botId,function(){
						__f1();
					});
					
				}
			});			
		}
		else{
			config = null;
			dialog.find("#trWarn").hide();
			dialog.find("#trRuleId").hide();
			dialog.find("#labRuleId").text();
			chkSkipSenderAddrChk.prop("checked",false);
			lstEmailAcct.combobox("clear");
			txtKeywordInSubject.textbox("setValue","");
			txtSenderEmail.textbox("setValue","");
			lstBot.combobox("clear");
			lstChat.combogrid("clear");
			lstTransformBody.combobox("setValue","1");
			txtComments.textbox("setValue","");
			lstForwardPart.combobox("setValues",[1,2]);
			lstForwardPart.combobox("loadData",emailParts);
			botId = "0";
			__f1();
		}
		function __f1(){
			let mailAccts = listToString(lstEmailAcct.combobox("getValues"));		
			updateCtrlState();
			callService({
				commandName: "QuerySystemConfigForForwardCfgDlg",
				parameters:{
					mail_accts:mailAccts,
					bot_id:botId
				},
				onSuccess: function(data){					
					$.each(data.records,function(index,item){
						if(item.data){
							switch(item.row_type){
							case "mail_acct_list":
								lstEmailAcct.combobox("loadData",JSON.parse(item.data));
								break;
							case "bot_list":
								lstBot.combobox("loadData",JSON.parse(item.data));
								break;
							}
						}
					});
					if(lstBot.combobox("getData").length == 0){
						$.messager.alert({
							msg:`Please configure Telegram Bot first`,
							icon:"info",
							title:"Note",
							width:450,
							fn:function(){
								addTab(1,"config");
							}
						});
						return;
					}
					if(readonly){
						lstEmailAcct.combobox("disable");
						txtKeywordInSubject.textbox("disable");
						chkSkipSenderAddrChk.prop("disabled",true);
						txtSenderEmail.textbox("disable");
						lstBot.combobox("disable");
						lstChat.combogrid("disable");
						lstTransformBody.combobox("disable");
						txtComments.textbox("disable");
						txtSenderEmail.textbox("textbox").css("color","");
						lstForwardPart.combobox("disable");						
						dialog.find("#btnRefreshEmailAcct,#btnClearEmailAcct,#btnClearChatList,#btnAddMailAcct,#btnRefreshChatList").linkbutton("disable");
						dialog.dialog("window").find("#btnOK").hide();
					}
					dialog.dialog("open");
					showed = true;
				}			
			});
		}
	}
	function queryMailAcctList(){
		let mailAccts = listToString(lstEmailAcct.combobox("getValues"));
		callService({
			commandName: "QueryEmailAcctListForForwardCfg",
			parameters:{
				mail_accts:mailAccts
			},
			onSuccess: function(data){
				lstEmailAcct.combobox("loadData",data.records);
			}
		});
	}
	
	function onOK(params){
		if(!params){
			params = {};
		}
		if(params.emailAccts === undefined){
			let emailAccts = lstEmailAcct.combobox("getValues");			
			if(emailAccts.length == 0){
				$.messager.alert({
					msg:"Please select target email accounts for this rule",
					title:"Note",
					width:400,
					icon:"info",
					fn:function(){
						lstEmailAcct.combobox("showPanel");
					}
				});
				return;
			}
			params.emailAccts = listToString(emailAccts);
		}

		if(params.botId === undefined){
			let botId = lstBot.combobox("getValue");
			if(!botId){
				$.messager.alert({
					title:"Note",
					icon:"info",
					msg:"Please select a bot to forward emails",
					width:400,
					fn:function(){
						lstBot.combobox("showPanel");
					}
				});
				return;
			}
			params.botId = botId;
		}
		if(params.chatId === undefined){
			let chatId = lstChat.combobox("getValue");
			if(!chatId){
				$.messager.alert({
					title:"Note",
					icon:"info",
					msg:"Please select a chat. The system will forward emails to this chat",
					width:400,
					fn:function(){
						lstChat.combogrid("showPanel");
					}
				});
				return;			
			}
			params.chatId = chatId;
		}
		if(params.forwardEmailParts === undefined){
			let forwardEmailParts = lstForwardPart.combobox("getValues");
			if(forwardEmailParts.length == 0){
				$.messager.alert({
					msg:"Please select which parts of the emails will be forwarded to Telegram",
					title:"Note",
					width:400,
					icon:"info",
					fn:function(){
						lstForwardPart.combobox("showPanel");
					}
				});
				return;
			}
			params.forwardEmailParts = forwardEmailParts;
		}
		
		if(params.keyword === undefined){
			let keyword = params.keyword?params.keyword:txtKeywordInSubject.textbox("getValue");
			if(!keyword){
				$.messager.confirm({
					title:"Note",
					msg:`"Keyword in Subject" is empty. This rule will not work. Continue?`,
					width:450,
					icon:"question",
					fn:function(r){
						if(r){
							params.keyword = keyword;
							window.setTimeout(function(){
								onOK(params);
							},10);
							
						}
					}
				});
				return;
			}
			params.keyword = keyword;
		}
		if(params.skipSenderAddrChk === undefined){
			params.skipSenderAddrChk = chkSkipSenderAddrChk.prop("checked");
		}
		if(params.senderEmail === undefined){
			let senderEmail = txtSenderEmail.textbox("getValue");
			if(!senderEmail && !params.skipSenderAddrChk){
				$.messager.confirm({
					title:"Note",
					msg:`"Sender Email Address" is empty. This rule will not work. Continue?`,
					width:450,
					icon:"question",
					fn:function(r){
						if(r){
							params.senderEmail = senderEmail;
							window.setTimeout(function(){
								onOK(params);
							},10);
							
						}
					}
				});
				return;
			}
			params.senderEmail = senderEmail;
		}
		if(params.convertBody === undefined){
			let convertBody = lstTransformBody.combobox("getValue");
			if(!convertBody){
				convertBody = "1";
			}
			params.convertBody = convertBody;
			if(convertBody != "1"){
				if(!ruleId || config.convert_body_as == "1"){
					let wnd = $.messager.confirm({
						title:"Security Notice",
						width:550,
						msg:`<div><span>When converting email content to an image/PDF, the system will load external images embedded in the message.</span> 
<span style="font-weight:600;">This may pose privacy risks:</span>
</div>
<div>
	<p style="display:list-item;">The sender could track your IP address or device information via these images.</p>
	<p style="display:list-item;">External servers may log your access time/location.</p>
	<p style="height:30px;"></p>
	<p>Proceed with saving?</p>
</div>
`,
						fn:function(r){
							if(r){
								window.setTimeout(function(){
									onOK(params);
								},10);
							}
						}
					});
					wnd.window("window").find(".messager-icon").removeClass("messager-question").addClass("messager-warning");
					return;
				}
			}
			
		}
		let comments = txtComments.textbox("getValue").trim();
		
		let parameters = {
			received_by_email_addr:params.emailAccts,
			subject_keyword:params.keyword,
			skip_sender_addr_chk:params.skipSenderAddrChk?"1":"0",
			from_email_addr:params.senderEmail,
			send_via_bot_id:params.botId,
			send_to_chat_id:params.chatId,
			convert_body_as:params.convertBody,
			comments:comments,
			forward_email_parts:JSON.stringify(params.forwardEmailParts)
		};
		function __fx(){
			let acctTasks = [];
			$.each(lstEmailAcct.combobox("getValues"),function(index,item){
				acctTasks.push({
					mailAcct:item,
					tasks:[{
						"taskName":"Telebot_ForwardEmailToTelegram",
						"oper":1
					}]
				});
			});
			window.top.addMailAcctTask({
				"dialogId":$(window.frameElement).attr("dialogid"),
				acctTasks:acctTasks
			});
		}
		if(ruleId){
			parameters.rule_id = ruleId;
			callService({
				commandName: "UpdateEmailForwardRule",
				parameters:parameters,
				onSuccess: function(data){
					__fx();
					showAlert("Email forward rule saved successfully");
					callback.apply(this,[data.records[0]]);
					dialog.dialog("close");
				}
			});
		}
		else{
			callService({
				commandName: "AddNewEmailForwardRule",
				parameters:parameters,
				onSuccess: function(data){
					__fx();
					showAlert("Email forward rule saved successfully");
					callback.apply(this,[data.records[0]]);
					dialog.dialog("close");
				}
			});
		}
	}
}

const KeyWordTestDialog = function(){
	let dialog = $(`
<div style="padding:5px;overflow-x:hidden;">
	<table class='dialog_ctrl_list' style="width:100%;margin:auto;">	
		<tr><td class="ctrlLabel"><span id="txtSubject" style="width:100%;"></td></tr>
		<tr><td style="white-space:normal;"><span id="labResult"></span></td></tr>
	</table>
</div>
`);
	let txtSubject;
	(function(){
		dialog.dialog({
			title:"Keywords Test",
			width:620,
			height:250,
			closed:true,
			modal:true,
			buttons:[{
				text:"Test",
				width:80,
				handler:test
			},{
				text:"Close",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		txtSubject = dialog.find("#txtSubject");
		txtSubject.textbox({
			multiline:true,
			height:100
		});
	})();

	let typeName, textName;
	let itemList,callback;
	this.show = function(params){
		typeName = "Email Forward Rule";
		textName = `Email Subject`;
		txtSubject.textbox("textbox").prop("placeholder",`Enter an email subject and click "Test".`);
		itemList = params.itemList;
		callback = params.callback;
		dialog.dialog("open");
		txtSubject.textbox("textbox").focus();
	}
	
	function test(){
		let subject = txtSubject.textbox("getValue");
		if(!subject){
			showAlert(`"${textName}" cannot be empty`);
			txtSubject.textbox("textbox").focus();
			return;
		}
		callService({
			commandName: "KeywordsTest",
			parameters: {
				"text": subject,
				"items":JSON.stringify(itemList)
			},
			onSuccess: function(data){
				if(data.records.length > 0){
					let record = data.records[0]; 
					dialog.find("#labResult").html(`<p style="color:#4e4e90;font-weight:600;">Success! The ${textName.toLowerCase()} "<span style="font-weight:bold;">${HTMLEncode(subject)}</span>" was matched to ${typeName.toLowerCase()} "<span style="font-weight:bold;">${HTMLEncode(record.name)}</span>". The keyword is "<span style="font-weight:bold;">${record.keyword}</span>".</p>`);
				}
				else{
					dialog.find("#labResult").html(`<p style="color:red;font-weight:600;">Failed! No matching ${typeName.toLowerCase()} was found for ${textName.toLowerCase()} "${HTMLEncode(subject)}".</p>`);
				}
				txtSubject.textbox("textbox").focus();				
			}
		});	
	}
}


const setEmailForwardRulePriority = function(callback){
	let priorityDialog = $(
`<div>
<div id="grid"></div>
</div>`);
	let keywordsEditor;
	priorityDialog.dialog({
		title:"Email Forward Rules Priority Setting",
		width:900,
		height:500,
		closed:true,
		modal:true,
		onClose:function(){
			window.setTimeout(function(){
				if(keywordsEditor){
					keywordsEditor.close();
					keywordsEditor = null;
				}
				priorityDialog.dialog("destroy");
			},10);
		},
		buttons:[{
			text:"OK",
			width:80,
			handler:savePrioritySetting
		},{
			id:"btnCancel",
			text:"Cancel",
			width:80,
			handler:function(){
				priorityDialog.dialog("close");
			}	
		}]
	});
	createHelpButton20(priorityDialog,"https://www.sqlmessenger.com/manual/plugin-1-mail-type-config.htm#priority");
	let grid = priorityDialog.find("#grid");
	let gridStatusMgr;
	grid.datagrid({
		border: false,
		fit: true,
		singleSelect: false,
		loadMsg: false,
		pagination:false,
		ctrlSelect:true,
		toolbar: [{
			text:"Move Up",
			iconCls:"arrow-up",
			handler:function(){
				let rows = grid.datagrid("getRows");
				let selected = grid.datagrid("getSelections");
				if(rows.length == 0)
					return;
				gridStatusMgr.beforeQuery();
				grid.datagrid("loadData",moveRecordUpInArray(rows,selected,"rule_id"));
				gridStatusMgr.afterQuery();
			}
		},{
			text:"Move Down",
			iconCls:"arrow-down",
			handler:function(){
				let rows = grid.datagrid("getRows");
				let selected = grid.datagrid("getSelections");
				if(rows.length == 0)
					return;
				gridStatusMgr.beforeQuery();
				grid.datagrid("loadData",moveRecordDownInArray(rows,selected,"rule_id"));
				gridStatusMgr.afterQuery();
			}
		},{
			text:"Keyword Test",
			handler:function(){
				let rows = grid.datagrid("getRows");
				let rs = [];
				$.each(rows,function(index,item){
					if(item.state == "A"){
						rs.push({
							id:item.mail_type_id,
							keyword:item.keywords_in_subject,
							name:item.mail_type_name
						});
					}
				});
				if(rs.length == 0){
					showAlert(`The list is empty`);
					return;
				}
				if(!keywordsEditor){
					keywordsEditor = new KeywordsEditor();
				}
				keywordsEditor.show({
					type:1,
					itemList:rs,
					testOnly:true
				});
			}
		}],
		rownumbers:true,
		rowStyler:rowStyler,
		columns:[[{
			field:"rule_id",
			title:"RuleID",
			width:100,
			halign:"center"
		},{
			field:"from_email_addr",
			title:"Sender",
			width:100,
			halign:"center"
		},{
			field:"received_by_email_addr",
			title:"ApplyTo",
			width:150,
			halign:"center"
		},{
			field:"subject_keyword",
			title:"Keyword in Subject",
			width:150,
			halign:"center"
		},{
			field:"bot_user_name",
			title:"Forward Via Bot",
			width:110,
			halign:"center"
		},{
			field:"chat_title",
			title:"Forward To Chat",
			width:110,
			halign:"center",
			formatter: function(value, row, index){
				if(!value){
					value = row.chat_user_name;
				}
				return HTMLEncode(value);
			}
		}]]
	});
	gridStatusMgr = new GridStatusMgr({
		grid:grid,
		idField:"rule_id"
	});
	let oldPriority;
	function savePrioritySetting(){
		let rows = grid.datagrid("getRows");
		let newPriority = [];
		$.each(rows,function(index,item){
			newPriority.push(item.rule_id);
		});
		let newPriorityStr = JSON.stringify(newPriority);
		if(JSON.stringify(oldPriority) == newPriorityStr){
			priorityDialog.dialog("close");
			return;
		}
		callService({
			commandName: "UpdateEmailForwardRulePriority",
			msg:"Saving configuration...",
			parameters: {
				rule_id_list:newPriorityStr
			},
			onSuccess: function(data){
				priorityDialog.dialog("close");
				callback.apply(this,[]);
			}
		});
	}
	callService({
		commandName: "QueryEmailForwardRuleList",
		onSuccess: function(data){
			grid.datagrid("loadData",data.records);
			oldPriority = [];
			$.each(data.records,function(index,item){
				oldPriority.push(item.rule_id);
			});
			if(data.records.length > 0){
				grid.datagrid("selectRow",0);
			}
			priorityDialog.dialog("open");
		}
	});
}

const EmailForwardRuleManager = function(){
	let panel = $(`
		<div data-options="region:'north'" style="height:35px;line-height:35px;border-style:none none solid none;broder-color:#c0c0c0;padding-left:5px;overflow:hidden;">
			<table>
				<tr><td class="ctrlLabel" style="font-weight:600;">Forward emails to Telegram chat: </td><td><span id='btnForward'></span></td></tr>
			</table>
		</div>
		<div data-options="region:'center',border:false">
			<div id="grid"></div>
		</div>`);
	$("#panelEmailForwardRulesManager").append(panel);
	let keyWordTestDialog;
	function close(){
		if(keyWordTestDialog){
			keyWordTestDialog.close();
			keyWordTestDialog = null;
		}
		if(forwardRuleConfigDialog){
			forwardRuleConfigDialog.close();
			forwardRuleConfigDialog = null;
		}		
	}
	this.close = close;
	
	let forwardRuleConfigDialog;
	let btnForward,grid;
	let girdStatusMgr;
	(function(){
		$("#panelEmailForwardRulesManager").layout({
			fit:true
		});

		btnForward = panel.find("#btnForward");
		let btnForwardBusy;
		btnForward.switchbutton({
			onChange:function(checked){
				if(btnForwardBusy)
					return;
				if(checked != forwardEmails){
					if(checked){
						$.messager.confirm({
							msg:`<span style="font-weight:600;">Important Notice:</span> <span>Once enabling email forwarding, the system will automatically forward received emails to your specified chat based on configured rules. Confirm to proceed?</span>`,
							title:"Important Notice",
							icon:"warn",
							width:450,
							fn:function(r){
								if(r){
									callService({
										commandName: "EnableEmailForwardFeature",
										onSuccess: function(data){
											showAlert("Email forwarding feature has been enabled");
											forwardEmails = checked;
										}
									});
								}
								else{
									btnForwardBusy = true;
									btnForward.switchbutton("uncheck");
									btnForwardBusy = false;
									return;
								}
							}							
						});
					}
					else{
						callService({
							commandName: "DisableEmailForwardFeature",
							onSuccess: function(data){
								showAlert("Email forwarding feature has been disabled");
								forwardEmails = checked;
							}
						});
					}
				}
			}
		});
		grid = panel.find("#grid");
		grid.datagrid({
			border: false,
			fit: true,
			singleSelect: true,
			loadMsg: false,
			pagination:false,
			toolbar: [{
				text:"Add Rule",
				handler:function(){
					if(!forwardRuleConfigDialog){
						forwardRuleConfigDialog = new EmailForwardRuleConfigDialog();
					}
					forwardRuleConfigDialog.show({
						callback:function(ruleInfo){
							grid.datagrid("appendRow",ruleInfo);
							onLoadSuccess();
							grid.datagrid("selectRow",grid.datagrid("getRows").length - 1);
						}
					});
				}
			},{
				text:"Priority Setting",
				handler:function(){
					setEmailForwardRulePriority(function(){
						query();
					});
				}
			},{
				text:"Keywords Test",
				handler:function(){
					let rows = grid.datagrid("getRows");
					let rs = [];
					$.each(rows,function(index,item){
						if(item.state == "A"){
							rs.push({
								id:item.rule_id,
								keyword:item.subject_keyword,
								name:item.rule_id
							});
						}
					});
					if(rs.length == 0){
						showAlert(`The mail type list is empty`);
						return;
					}
					
					if(!keyWordTestDialog){
						keyWordTestDialog = new KeyWordTestDialog();
					}
					keyWordTestDialog.show({
						type:1,
						itemList:rs
					});
				}
			},{
				text:"Email Account Manager",
				handler:function(){
					window.top.openEmailAccountManager();
				}
			},"-",{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					query();
				}	
			},{
				text:"Help",
				iconCls:"toolbar-button-icon icon-help-20",
				handler:function(){
					window.open("https://www.sqlmessenger.com/manual/plugin-2-email-forwarding-config.htm");
				}
			},{
				text:"Exit",
				iconCls:"toolbar-button-icon icon-exit-20",
				handler:function(){
					mainTabs.tabs("close",emailForwardRuleManagerPanel.title);
				}	
			}],
			rownumbers:true,
			rowStyler:rowStyler,
			columns:[[{
				field:"rule_id",
				title:"RuleID",
				width:100,
				halign:"center",
				formatter: function(value, row, index){
					if(row.state == "X"){
						return value;
					}
					else{
						return `<span class="link btnEdit" ruleid="${value}">${value}</span>`;
					}
				}
			},{
				field:"from_email_addr",
				title:"Sender",
				width:180,
				halign:"center",
				formatter: function(value, row, index){
					if(row.skip_sender_addr_chk == "1"){
						return "Any Sender";
					}
					else{
						return HTMLEncode(value);
					}
				}
			},{
				field:"received_by_email_addr",
				title:"ApplyTo",
				width:150,
				halign:"center"
			},{
				field:"subject_keyword",
				title:"Keyword in Subject",
				width:150,
				halign:"center"
			},{
				field:"bot_user_name",
				title:"Forward Via Bot",
				width:110,
				halign:"center"
			},{
				field:"chat_title",
				title:"Forward To Chat",
				width:110,
				halign:"center",
				formatter: function(value, row, index){
					if(!value){
						value = row.chat_user_name;
					}
					return HTMLEncode(value);
				}
			},{
				field:"create_time",
				title:"CreatedTime",
				width:140,
				align:"center"
			},{
				field:"state",
				title:"State",
				width:80,
				align:"center",
				formatter: function(value, row, index){
					let rst = "";
					switch(value){
					case "A":
						rst = "<span class='status-icon icon-useable' title='Enabled'></span>";
						break;
					case "D":
						rst = "<span class='status-icon icon-disabled' title='Disabled'></span>";
						break;
					case "X":
						rst = "<span class='status-icon icon-deleted' title='Deleted'></span>";
						break;
					default:
						rst = value;
						break;
					}
					return rst;
				}
			},{
				field:"state_time",
				title:"StateTime",
				width:140,
				align:"center"
			},{
				field:"priority",
				title:"Priority",
				width:60,
				halign:"center"
			},{
				field:"actions",
				title:"Actions",
				width:130,
				align:"center",
				formatter: function(value, row, index){
					if(row.state == "X"){
						return `<span class='grid-menu-icon btnUndelete' title='Undelete' ruleid='${row.rule_id}'><span class='menu-button-icon btn-undelete'></span></span>`;
					}
					else{
						let rst;
						rst = `<span class='grid-menu-icon btnEdit' title='Edit' ruleid='${row.rule_id}'><span class='menu-button-icon btn-edit'></span></span>`;
						if(row.state == "A"){
							rst += `<span class='grid-menu-icon btnDisable' title='Disable this rule' ruleid='${row.rule_id}'><span class='menu-button-icon btn-stop'></span></span>`;
						}
						else{
							rst += `<span class='grid-menu-icon btnEnable' title='Enable this rule' ruleid='${row.rule_id}'><span class='menu-button-icon btn-enable'></span></span>`;
						}
						rst += `<span class='btnDelete grid-menu-icon' title='Delete this rule' ruleid='${row.rule_id}'><span class='menu-button-icon btn-delete'></span></span>`;
						return rst;
					}
				}
			}]],
			onLoadSuccess:onLoadSuccess
		});
		girdStatusMgr = GridStatusMgr({
			grid:grid,
			idField:"rule_id"
		});
	})();
	function onLoadSuccess(){
		let parent = grid.parent();
		let objs = parent.find(".btnEdit").not(".bound");
		objs.click(editRule);
		objs.addClass("bound");

		objs = parent.find(".btnDelete").not(".bound");
		objs.click(deleteRule);
		objs.addClass("bound");

		objs = parent.find(".btnUndelete").not(".bound");
		objs.click(deleteRule);
		objs.addClass("bound");

		objs = parent.find(".btnEnable,.btnDisable").not(".bound");
		objs.click(updateRuleState);
		objs.addClass("bound");
	}

	function updateRuleState(){
		let ruleId = $(this).attr("ruleid");
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"rule_id",ruleId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];
		let state,newState;
		state = row.state;
		if(state == "A"){
			newState = "D";
		}
		else if(state == "D"){
			newState = "A";
		}
		else{
			return;
		}
		callService({
			commandName: "UpdateEmailForwardRuleState",
			parameters:{
				rule_id:ruleId,
				new_state:newState
			},
			onSuccess: function(data){
				let row = data.records[0];						
				grid.datagrid("updateRow",{
					index:rowIndex,
					row:row
				});
				onLoadSuccess();
			}
		});
	}

	function deleteRule(){
		let ruleId = $(this).attr("ruleid");
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"rule_id",ruleId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];
		let state,newState;
		state = row.state;
		let msg;
		if(state == "X"){
			newState = row.oldState;
			msg = "Do you want to undelete this rule?";
		}
		else {
			newState = "X";
			msg = "Do you want to delete this rule?";
		}
		$.messager.confirm({
			msg:msg,
			title:"Question",
			icon:"warn",
			width:450,
			fn:function(r){
				if(r){
					callService({
						commandName: newState == "X"?"DeleteEmailForwardRule":"UndeleteEmailForwardRule",
						parameters:{
							rule_id:ruleId,
							new_state:newState
						},
						onSuccess: function(data){
							let row = data.records[0];
							if(newState == "X")
								row.oldState = rows[rowIndex].state;							
							grid.datagrid("updateRow",{
								index:rowIndex,
								row:row
							});
							onLoadSuccess();
						}
					});
				}
			}
		});
	}

	function editRule(){
		let ruleId = $(this).attr("ruleid");
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"rule_id",ruleId);
		if(rowIndex < 0){
			return;
		}
		if(rows[rowIndex] == "X"){
			return;
		}
		if(!forwardRuleConfigDialog){
			forwardRuleConfigDialog = new EmailForwardRuleConfigDialog();
		}
		forwardRuleConfigDialog.show({
			ruleId:ruleId,
			callback:function(ruleInfo){
				grid.datagrid("updateRow",{
					index:rowIndex,
					row:ruleInfo
				});
				onLoadSuccess();
			}
		});
	}
	function query(){
		girdStatusMgr.beforeQuery();
		callService({
			commandName: "QueryEmailForwardRuleList",
			onSuccess: function(data){
				grid.datagrid("loadData",data.records);
				girdStatusMgr.afterQuery();
			}
		});
	}
	let forwardEmails;
	(function(){
		btnForwardBusy = false;
		callService({
			commandName: "QueryGlobalConfig",
			parameters:{
				ids:"1002"
			},
			onSuccess: function(data){
				if(data.records.length > 0){
					let config = JSON.parse(data.records[0].config);
					forwardEmails = config && config["1002"] == "1"?true:false;
				}
				else{
					forwardEmails = false;
				}
				btnForward.switchbutton(forwardEmails?"check":"uncheck");
				query();			
			}
		});
	})();
}

let emailInfoDialog;
const showEmailInfo = (inboxMailId) => {
	if(!emailInfoDialog){
		emailInfoDialog = new EmailInfoDialog();
	}
	emailInfoDialog.show({
		inboxMailId:inboxMailId
	});	
}

const MessageListDialog = function(){
	let dialog = $(`<div><div id="grid"></div></div>`);
	this.close = function(){
		if(messageList != null){
			messageList.close();
			messageList = null;
		}
		dialog.dialog("destroy");
	}
	let messageList;
	(function(){
		dialog.dialog({
			title:"Message List",
			width:document.body.clientWidth * 0.99,
			height:document.body.clientHeight * 0.98,
			closed:true,
			modal:true,
			maximizable: true,
            resizable: true,
			buttons:[{
				text:"Close",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		messageList = new MessageQueueManager({
			container:dialog.find("#grid"),
			inDialog:true,
			parentDialog:dialog
		});
	})();

	this.show = function(params){
		messageList.setIds(params.ids);
		messageList.setOrder(params.order);
		messageList.requery();
		dialog.dialog("open");
	}
}

const EmailInfoDialog = function(){
	let dialog = $(`<div>
<div id="tabs1">
	<div title="Email Info" style="padding:5px;">
		<table class="dialog_ctrl_list list-table" style="width:100%;">
		<tr>
			<td class="label">Inbox Mail ID</td><td class="cell"><span id="inbox_mail_id"></span></td>
			<td class="label">Mail UUID</td><td class="cell"><span id="mail_uuid"></span></td>
			<td colspan=4></td>
		</tr>
		<tr>
			<td class="label">Message ID</td><td class="cell" colspan="5"><span id="message_id"></span></td>
		</tr>
		<tr>
			<td class="label">Subject</td><td class="cell" colspan="5"><span id="subject"></span></td>
		</tr>
		<tr>
			<td class="label">Sent Time</td><td class="cell"><span id="sent_date"></span></td>
			<td class="label">Received Time(Mail Server)</td><td class="cell"><span id="received_time"></span></td>
			<td class="label">Received Time(SQLMessenger)</td><td class="cell"><span id="received_time_local"></span></td>
		</tr>
		<tr>
			<td class="label">From Addr</td><td class="cell"><span id="from_addr"></span></td>
			<td class="label">Reply Addr</td><td class="cell"><span id="reply_to"></span></td>
			<td class="label">Sender</td><td class="cell"><span id="sender"></span></td>
		</tr>
		<tr>
			<td class="label">Send To</td><td class="cell" colspan="5"><span id="send_to"></span></td>
		</tr>
		<tr>
			<td class="label">Copy To</td><td class="cell" colspan="5"><span id="copy_to"></span></td>
		</tr>
		<tr>
			<td class="label">BCC</td><td class="cell" colspan="5"><span id="bcc_to"></span></td>
		</tr>
		<tr>
			<td class="label">Forward Rule ID</td><td class="cell"><span id="last_rule_id"></span></td>
			<td class="label">Processed Time</td><td class="cell"><span id="last_processed_time"></span></td>
			<td class="label">Processing Status</td><td class="cell"><span id="last_processing_status"></span></td>
		</tr>
		<tr>
			<td class="label">Processing Result</td><td class="cell" colspan="5"><span id="result_comments"></span></td>
		</tr>
		</table>
	</div>
	<div title="Attachments">
		<div id="gridAttachments"></div>
	</div>
	<div title="Forwarding Logs">
		<div id="gridForwardLog"></div>
	</div>
</div>
</div>`);
	let messageListDialog;
	function close(){
		if(ruleConfigDialog){
			ruleConfigDialog.close();
			ruleConfigDialog = null;
		}
		if(messageListDialog){
			messageListDialog.close();
			messageListDialog = null;
		}
		dialog.dialog("destroy");
		emailInfoDialog = null;
	}
	this.close = close;
	let closed;
	let tabs, gridAttachments;
	let girdStatusMgr, gridForwardLog, gridForwardLogMgr;
	(function(){
		dialog.dialog({
			title:"Email Details",
			width:document.body.clientWidth * 0.8,
			height:document.body.clientHeight * 0.95,
			closed:true,
			modal:true,
			maximizable: true,
            resizable: true,
			buttons:[{
				text:"Close",
				width:80,
				handler:function(){
					closed = true;
					dialog.dialog("close");
				}	
			}]
		});
		tabs = dialog.find("#tabs1");
		tabs.tabs({
			fit:true,
			border:false,
			onSelect:function(title,index){
				if(index == 1 && !attachListQueried){
					window.setTimeout(function(){
						queryAttachments();
					},10);
					return;
				}
				if(index == 2 && !forwardLogQueried){
					window.setTimeout(function(){
						queryForwardLog();
					},10);
					return;
				}
			}
		});
		gridAttachments = dialog.find("#gridAttachments");
		gridAttachments.datagrid({
			border: false,
			fit: true,
			singleSelect: true,
			loadMsg: false,
			pagination:false,
			toolbar: [{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					queryAttachments();
				}	
			}],
			rownumbers:true,
			columns:[[{
				field:"mail_content_id",
				title:"Attachment ID",
				width:150,
				halign:"center"
			},{
				field:"file_name",
				title:"FileName",
				width:400,
				halign:"center",
				formatter: function(value, row, index){
					value = HTMLEncode(value);
					if(row.file_id)
						return `<span class="link btnQueryFileInfo" fileid=${row.file_id}>${value}</span>`;
					else
						return value;
				}
			},{
				field:"file_size",
				title:"FileSize",
				width:90,
				halign:"center",
				align:"right",
				formatter: function(value, row, index){
					return (parseInt(value) / 1024.00).toFixed(2) + "KB";
				}
			}]],
			onLoadSuccess:onLoadSuccess
		});
		girdStatusMgr = GridStatusMgr({
			grid:gridAttachments,
			idField:"mail_content_id"
		});

		gridForwardLog = dialog.find("#gridForwardLog");
		gridForwardLog.datagrid({
			border: false,
			fit: true,
			singleSelect: true,
			loadMsg: false,
			pagination:false,
			toolbar: [{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					queryForwardLog();
				}	
			}],
			rownumbers:true,
			columns:[[{
				field:"processed_time",
				title:"ProcessedTime",
				width:140,
				align:"center"
			},{
				field:"processing_status",
				title:"ProcessingStatus",
				width:120,
				align:"center",
				formatter: function(value, row, index){
					let rst;
					if(row.sending_status == "R"){
						rst = `<span title='${row.last_processing_comments}'><img src="images/waiting.gif"></span>`;
					}					
					else if(row.sending_status == "E"){
						rst = `<span class='status-icon warning-icon-20' title='Some messages failed to send'></span>`;
					}					
					else if(row.rule_id == -2){
						rst = `<span class='status-icon clock-20' title='Pending'></span>`;
					}
					else if(value == "E"){
						rst = `<span class='status-icon error-icon-20' title='${row.result_comments}'></span>`;
					}
					else if(row.rule_id == -1){
						rst = `<span class='status-icon disable-icon' title='${row.result_comments}'></span>`;
					}
					else if(value == "F"){
						rst = `<span class='status-icon disable-icon' title='${row.result_comments}'></span>`;
					}
					else if(value == "C"){
						rst = `<span class='status-icon tick-20' title='${row.result_comments}'></span>`;
					}
					else{
						rst = value;
					}
					return rst;
				}
			},{
				field:"result_comments",
				title:"ProcessingResult",
				width:360,
				halign:"center"
			},{
				field:"rule_id",
				title:"RuleID",
				width:150,
				halign:"center",
				formatter: function(value, row, index){
					return `<span class="link btnViewRuleConfig" logid="${row.forward_log_id}">${value}</span>`;
				}
			},{
				field:"message_count",
				title:"MessageCount",
				width:250,
				halign:"center",
				formatter: function(value, row, index){
					if(value)
						return `<span class="link btnViewMessageList" logid="${row.forward_log_id}">${value} message(s) were generated</span>`;
				}
			},{
				field:"task_inst_id",
				title:"TaskInstanceID",
				width:120,
				halign:"center"
			}]],
			onLoadSuccess:onForwardLogLoadSuccess
		});
		gridForwardLogMgr = new GridStatusMgr({
			grid:gridForwardLog,
			idField:"forward_log_id"
		});

		dialog.find("#last_rule_id").addClass("link").click(function(){
			viewRuleConfig($(this).attr("ruleuuid"));
		});
	})();
	function onForwardLogLoadSuccess(){
		let parent = gridForwardLog.parent();
		let objs = parent.find(".btnViewRuleConfig").not(".bound");
		objs.click(onViewRuleConfigClick);
		objs.addClass("bound");

		objs = parent.find(".btnViewMessageList").not(".bound");
		objs.click(viewMessageList);
		objs.addClass("bound");
	}

	function viewMessageList(){
		let logId = $(this).attr("logid");
		let rows = gridForwardLog.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"forward_log_id",logId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];
		if(row.local_message_ids.length == 0){
			return;
		}
		let ids = [];
		$.each(JSON.parse(row.local_message_ids),function(index,item){
			ids.push(item.local_message_id);
		});
		if(!messageListDialog){
			messageListDialog = new MessageListDialog();
		}
		messageListDialog.show({
			ids:ids,
			order:"asc"
		});
	}

	let ruleConfigDialog;
	function onViewRuleConfigClick(){
		let logId = $(this).attr("logid");
		let rows = gridForwardLog.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"forward_log_id",logId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];
		let ruleUUID = row.rule_uuid;
		viewRuleConfig(ruleUUID);
	}

	function viewRuleConfig(ruleUUID){
		if(!ruleUUID)
			return;
		callService({
			commandName: "QueryForwardRuleConfigVer",
			parameters:{
				"rule_uuid":ruleUUID
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					return;
				}				
				let config = JSON.parse(data.records[0].rule_config);
				if(!ruleConfigDialog){
					ruleConfigDialog = new EmailForwardRuleConfigDialog();
				}
				ruleConfigDialog.show({
					config:config,
					readonly:true
				});
			}
		});
	}

	let locked,refreshStatus;
	function queryForwardLog(){
		if(locked){
			return;
		}
		locked = true;
		gridForwardLogMgr.beforeQuery();
		callService({
			commandName: "QueryEmailForwardLog",
			parameters:{
				"inbox_mail_id":inboxMailId
			},
			msg:refreshStatus?false:undefined,
			onSuccess: function(data){
				gridForwardLog.datagrid("loadData",data.records);
				gridForwardLogMgr.afterQuery();
				if(!forwardLogQueried)
					forwardLogQueried = true;				
				if(!closed){
					let hasRunning = false;
					$.each(data.records,function(index,item){
						if(item.sending_status == "R"){
							hasRunning = true;
							return false;
						}
					});
					if(hasRunning){
						refreshStatus = true;
						window.setTimeout(function(){
							queryForwardLog();
						},500);
					}
					else{
						refreshStatus = false;
					}
				}
				locked = false;
			},
			onError:function(error){
				locked = false;
			}
		});
	}
	
	function onLoadSuccess(){
		let parent = gridAttachments.parent();
		let objs = parent.find(".btnQueryFileInfo").not(".bound");
		objs.click(queryFileInfo);
		objs.addClass("bound");
	}
	function queryFileInfo(){
		let fileId = $(this).attr("fileid");
		if(!fileId){
			return;
		}
		showFileInfo(fileId);
	}
	function queryAttachments(){
		girdStatusMgr.beforeQuery();
		callService({
			commandName: "QueryEmailAttachList",
			parameters:{
				"inbox_mail_id":inboxMailId
			},
			onSuccess: function(data){
				gridAttachments.datagrid("loadData",data.records);				
				if(!attachListQueried){
					attachListQueried = true;
				}
				girdStatusMgr.afterQuery();
			}
		});
	}
	let inboxMailId, attachListQueried, forwardLogQueried;
	this.show = function(params){
		closed = false;
		locked = false;
		refreshStatus = false;
		attachListQueried = false;
		forwardLogQueried = false;
		inboxMailId = params.inboxMailId;
		gridAttachments.datagrid("loadData",[]);
		gridForwardLog.datagrid("loadData",[]);		
		callService({
			commandName: "QueryEmailInfo",
			parameters:{
				"inbox_mail_id":inboxMailId
			},
			onSuccess: function(data){
				if(data.recCount == 0){
					$.messager.alert({
						msg:"The specified email ID was not found",
						icon:"warning"
					});
					return;
				}				
				let mailInfo = data.records[0];
				$.each(mailInfo,function(key,value){
					dialog.find("#" + key).text(value?value:"");
				});
				dialog.find("#last_rule_id").attr("ruleuuid",mailInfo.last_rule_uuid);
				dialog.dialog("open");
				tabs.tabs("select",0);
			}
		});	
	}
}

const EmailForwardManager = function(){
	let grid = $("#panelEmailForwardManager");
	function close(){
		closed = true;
	}
	this.close = close;

	let girdStatusMgr;
	let pager;
	let page = 1,pageSize = 50,recCount = -1;
	(function(){
		grid.datagrid({
			border: false,
			fit: true,
			singleSelect: false,
			ctrlSelect:true,
			loadMsg: false,
			pagination:true,
			toolbar: [{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					query();
				}	
			},{
				text:"Help",
				iconCls:"toolbar-button-icon icon-help-20",
				handler:function(){
					window.open("https://www.sqlmessenger.com/manual/plugin-2-email-forwarding-config.htm#part4");
				}
			},{
				text:"Exit",
				iconCls:"toolbar-button-icon icon-exit-20",
				handler:function(){
					mainTabs.tabs("close",emailForwardManagerPanel.title);
				}	
			}],
			rownumbers:true,
			rowStyler:rowStyler,
			columns:[[{
				field:"inbox_mail_id",
				title:"MailID",
				width:80,
				halign:"center"
			},{
				field:"subject",
				title:"Subject",
				width:300,
				halign:"center",
				formatter: function(value, row, index){
					return `<span class="link btnDetail" emailid="${row.inbox_mail_id}">${HTMLEncode(value)}</span>`;
				}
			},{
				field:"from_addr",
				title:"From",
				width:200,
				halign:"center"
			},{
				field:"last_processed_time",
				title:"Processed Time",
				width:140,
				halign:"center"
			},{
				field:"last_processing_status",
				title:"Processing Status",
				width:120,
				align:"center",
				formatter: function(value, row, index){
					let rst; 
					if(row.sending_status == "E"){
						rst = `<span class='status-icon warning-icon-20' title='Some messages failed to send'></span>`;
					}
					else if(row.sending_status == "R"){
						rst = `<span title='${row.last_processing_comments}'><img src="images/waiting.gif"></span>`;
					}					
					else if(row.last_rule_id == -2){
						rst = `<span class='status-icon clock-20' title='Pending'></span>`;
					}
					else if(value == "R"){
						rst = `<span title='${row.last_processing_comments}'><img src="images/waiting.gif"></span>`;
					}
					else if(value == "F"){
						rst = `<span class='status-icon disable-icon' title='${row.last_processing_comments}'></span>`;
					}
					else if(value == "E"){
						rst = `<span class='status-icon error-icon-20' title='${row.last_processing_comments}'></span>`;
					}
					else if(row.last_rule_id == -1){
						rst = `<span class='status-icon disable-icon' title='${row.last_processing_comments}'></span>`;
					}
					else if(value == "C"){
						rst = `<span class='status-icon tick-20' title='${row.last_processing_comments}'></span>`;
					}
					else{
						rst = value;
					}
					return rst;
				}
			},{
				field:"last_processing_comments",
				title:"Processing Result",
				width:450,
				halign:"center",
				formatter: function(value, row, index){
					if(row.sending_status == "R")
						return "Processing";
					else
						return HTMLEncode(value);
				}
			},{
				field:"actions",
				title:"Actions",
				width:60,
				align:"center",
				formatter: function(value, row, index){
					return `
<span class='grid-menu-icon btnDetail' title='View email details' emailid='${row.inbox_mail_id}'><span class='menu-button-icon info-information-icon'></span></span>
<span class='grid-menu-icon btnReprocess' title='Reprocess this email' emailid='${row.inbox_mail_id}'><span class='menu-button-icon btn-undelete'></span></span>
					`;
				}
			}]],
			onLoadSuccess:onLoadSuccess
		});
		girdStatusMgr = GridStatusMgr({
			grid:grid,
			idField:"inbox_mail_id"
		});
		pager = grid.datagrid("getPager");
		pager.pagination({
			total: 0,
			pageSize: pageSize,
			pageList: [10, 50, 100, 300, 500],
			onChangePageSize: function(newPageSize){
				pageSize = newPageSize;
				recCount = -1;
				query();
			},
			onSelectPage: function(pageNumber, pageSize){			
				page = pageNumber < 1 ? 1 : pageNumber;				
				query();
			}
		});	
	})();

	function configEmailForwardRule(){
		if(!configDialog){
			configDialog = new EmailForwardConfigDialog();
		}
		configDialog.show();
	}

	function onLoadSuccess(){
		let parent = grid.parent();
		let objs = parent.find(".btnDetail").not(".bound");
		objs.click(queryDetailInfo);
		objs.addClass("bound");

		objs = parent.find(".btnReprocess").not(".bound");
		objs.click(reprocessEmail);
		objs.addClass("bound");
	}
	function reprocessEmail(){
		let inboxMailId = $(this).attr("emailid");		
		if(!inboxMailId){
			return;
		}
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"inbox_mail_id",inboxMailId);
		if(rowIndex < 0){
			return;
		}
		function __f1(){
			let row = rows[rowIndex];
			callService({
				commandName: "QueryTaskInfo_Telebot_ForwardEmailToTelegram",
				onSuccess: function(data){
					if(data.records.length == 0){
						$.messager.alert({
							msg:`Task 'Telebot_ForwardEmailToTelegram' not found. It may have been deleted.`,
							title:`Error`,
							icon:`error`,
							width:450
						});
						return;
					}
					let taskInfo = data.records[0];
					if(taskInfo.state == "D"){
						$.messager.alert({
							msg:`Task "Telebot_ForwardEmailToTelegram" is disabled. Please enable it first.`,
							title:`Error`,
							icon:`error`,
							width:450
						});
						return;
					}
					let opts = [{
						k:115,
						v:true
					},{
				        "k": 644,
				        "v": {}
				    },
				    {
				        "k": 900,
				        "v": [
				          {
				            "varType": 2,
				            "varValue": "",
				            "taskVarId": taskInfo.task_var_id,
				            "varName": "MailUUID",
				            "newVal": row.mail_uuid
				          }
				        ]
				    }];
					let callParams = {
					   	"ids": [parseInt(taskInfo.task_id)],
					   	"opts":opts
					};
					window.top.startTask({
						"dialogId":$(window.frameElement).attr("dialogid"),
				    	callParams:callParams,
				    	callback:function(taskInsts){			    		
				    		if(taskInsts.length == 0){
					    		$.messager.alert({
						    		msg:"No task instance generated",
						    		icon:"error",
						    		title:"Error"
					    		});
					    		return;
				    		}
				    		let taskInstInfo = taskInsts[0];			    		
				    		if(taskInstInfo.errorCode != 0){
					    		$.messager.alert({
						    		msg:taskInstInfo.resultText,
						    		icon:"error",
						    		width:450,
						    		title:"Error"
					    		});
					    		return;
				    		}
				    		let taskInstId = JSON.parse(taskInstInfo.resultText).taskInstId;
				    		grid.datagrid("updateRow",{
					    		index:rowIndex,
					    		row:{
					    			"last_processing_status":"R"
				    			}
				    		});
				    		onLoadSuccess();
				    		showAlert("Process started");
				    		callService({
				    			commandName: "UpdateEmailForwardingStatus",
				    			parameters:{
				    				inbox_mail_id:row.inbox_mail_id,
				    				task_inst_id:taskInstId,
				    				last_task_inst_id:row.last_task_inst_id
				    			},
				    			onSuccess: function(data){
						    		window.setTimeout(function(){
						    			queryEmailProcessingStatus();
						    		},1000);
				    			}
				    		});			    		
				    	}
					});
				}
			});
		}
		$.messager.confirm({
			msg:"Telebot will reprocess this email according to your current forwarding rules. Continue?",
			icon:"question",
			title:"Question",
			width:450,
			fn:function(r){
				if(r){
					__f1();
				}
			}
		});
	}
	
	function queryDetailInfo(){
		let inboxMailId = $(this).attr("emailid");		
		if(!inboxMailId){
			return;
		}
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"inbox_mail_id",inboxMailId);
		if(rowIndex < 0){
			return;
		}
		showEmailInfo(inboxMailId);
	}
	
	let queryOpts = {};
	function query(){		
		girdStatusMgr.beforeQuery();
		if(recCount < 0){
			page = 1;
		}
		callService({
			commandName: "QueryEmailList",
			parameters:{
				recCount:recCount,
				page:page,
				pageSize:pageSize,
				queryOpts:JSON.stringify(queryOpts)
			},
			onSuccess: function(data){
				grid.datagrid("loadData",data.records);
				if(data.tempVarsForClient && data.tempVarsForClient["record_count"]){
					recCount = parseInt(data.tempVarsForClient["record_count"]);
				}
				pager.pagination("refresh", {
					pageSize: pageSize,
					total: recCount,
					pageNumber: page
				});
				girdStatusMgr.afterQuery();
				window.setTimeout(function(){
					queryEmailProcessingStatus();
				},300);
			}
		});
	}
	let closed,timerId,locked;
	function queryEmailProcessingStatus(){
		if(closed || locked){
			return;
		}
		locked = true;
		let ids = [];
		let rows = grid.datagrid("getRows");
		$.each(rows,function(index,item){
			if(item.last_processing_status == "R" || item.sending_status == "R" || item.last_processing_status == "W" || item.sending_status == "W"){
				ids.push(item.inbox_mail_id);
			}
		});
		if(ids.length == 0){
			locked = false;
			return;
		}		
		timerId = 0;
		sqlmessenger.helper.runSqlCommand({
			commandName: "QueryEmailForwardingStatus",
			parameters:{
				ids:JSON.stringify(ids)
			},
			onSuccess: function(data){
				if(data.records.length > 0){
					let rows = grid.datagrid("getRows");
					$.each(data.records,function(index,item){
						let rowIndex = findItemIndexInArray(rows,"inbox_mail_id",item.inbox_mail_id);						
						if(rowIndex > -1){
							grid.datagrid("updateRow",{
								index:rowIndex,
								row:item
							});
						}
					});
					onLoadSuccess();
				}
				if(!closed && !timerId){
					timerId = window.setTimeout(function(){
						queryEmailProcessingStatus();
					},300);					
				}
				locked = false;
			},
			onError:function(error){
				if(!closed && !timerId){
					timerId = window.setTimeout(function(){
						queryEmailProcessingStatus();
					},300);					
				}
				locked = false;
			}
		});		
	}
	(function(){
		query();
	})();
}

const DataSourceMonitorLogDialog = function(){
	let dialog = $(`<div>
	<div id="grid"></div>
</div>`);
	let closed;
	this.close = function(){
		closed = true;
		dialog.dialog("destroy");
	}
	let recCount = -1;
	let page = 1;
	let pageSize = 50;
	let grid, pager;
	(function(){
		dialog.dialog({
			title:"DataSource Monitor Log",
			width:document.body.clientWidth * 0.85,
			height:document.body.clientHeight * 0.95,
			maximizable: true,
            resizable: true,
			closed:true,
			modal:true,
			buttons:[{
				id:"btnCancel",
				text:"Close",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		grid = dialog.find("#grid");
		grid.datagrid({
			border: false,
			fit: true,
			singleSelect: true,
			loadMsg: false,
			pagination:true,
			toolbar: [{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					recCount = -1;
					page = 1;
					query();
				}	
			},{
				text:"Exit",
				iconCls:"toolbar-button-icon icon-exit-20",
				handler:function(){
					dialog.dialog("close");
				}
			}],
			rownumbers:false,
			rowStyler:rowStyler,
			columns:[[{
				field:"log_type",
				title:"",
				width:30,
				align:"center",
				formatter: function(value, row, index){
					if(value == "1"){
						return `<img class="icon-in-grid-row" src="images/error.png">`;
					}
					else{
						return `<img class="icon-in-grid-row" src="images/information.png">`;
					}
				}
			},{
				field:"task_inst_id",
				title:"TaskInstanceId",
				width:150,
				halign:"center",
				formatter: function(value, row, index){
					return `<span class="link btnTaskInst" taskinstid="${value}">${value}</span>`;
				}
			},{
				field:"task_inst_status",
				title:"Status",
				width:60,
				align:"center",
				formatter: function(value, row, index){					
					let rst = "";
					switch(value){
					case "W":
						rst = `<span class="link btnTaskInst" taskinstid='${row.task_inst_id}'>Pending</span>`;
						break;
					case "C":
						rst = `<span class='status-icon tick-20 link btnTaskInst' title='Succeed' taskinstid='${row.task_inst_id}'></span>`;
						break;
					case "E":
						rst = `<span class="link btnTaskInst" style='color:red;' taskinstid='${row.task_inst_id}'>Error</span>`;
						break;
					case "F":
						rst = `<span class="link btnTaskInst" style='color:red;' taskinstid='${row.task_inst_id}'>Falied</span>`;
						break;
					case "R":
						rst = `<span class="link btnTaskInst" title="Running" taskinstid='${row.task_inst_id}'><img src="images/waiting.gif"></span>`;
						break;
					default:
						rst = value;
						break;
					}
					return rst;
				}
			},{
				field:"log_msg",
				title:"ProcessingResult",
				width:700,
				halign:"center"
			},{
				field:"new_record_count",
				title:"NewRecordCount",
				width:120,
				halign:"center",
				align:"right"
			},{
				field:"log_time",
				title:"Time",
				width:140,
				align:"center"
			}]],
			onLoadSuccess:onLoadSuccess			
		});
		pager = grid.datagrid("getPager");
		pager.pagination({
			total: 0,
			pageSize: pageSize,
			pageList: [10, 50, 100, 300, 500],
			onChangePageSize: function(newPageSize){
				pageSize = newPageSize;
				recCount = -1;
				query();
			},
			onSelectPage: function(pageNumber, pageSize){			
				page = pageNumber < 1 ? 1 : pageNumber;				
				query();
			}
		});
	})();
	function onLoadSuccess(){
		let parent = grid.parent();
		let objs = parent.find(".btnTaskInst").not(".bound");
		objs.click(viewTaskInstLog);
		objs.addClass("bound");
	}
	function viewTaskInstLog(){
		let taskInstId = $(this).attr("taskinstid");
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"task_inst_id",taskInstId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];
		let state = row.task_inst_status;
		window.top.showTaskInstLog({
			taskInstId:parseInt(taskInstId),
			dialogId:$(window.frameElement).attr("dialogid"),
			autoRefresh: state == "W" || state == "R"
		});
	}

	let dataSourceId;
	let showed;
	this.show = function(params){		
		recCount = -1;
		page = 1;
		dataSourceId = params.dataSourceId;
		showed = false;
		locked = false;
		closed = false;
		query();
	}

	let locked;
	function query(showMsg){
		if(locked){
			return;
		}
		locked = true;
		callService({
			msg:showMsg === false?false:undefined,
			commandName: "QueryDataSourceMonitorLog",
			parameters:{
				data_source_id:dataSourceId,
				recCount:recCount,
				page:page,
				pageSize:showMsg === false?5:pageSize,
			},
			onSuccess: function(data){
				if(closed){
					return;
				}				
				if(showMsg === false){
					let rows = grid.datagrid("getRows");
					$.each(data.records,function(index,item){
						let rowIndex = findItemIndexInArray(rows,"log_id",item.log_id);
						if(rowIndex > -1){
							grid.datagrid("updateRow",{
								index:rowIndex,
								row:item
							});
						}
						else{
							if(rows.length >= pageSize){
								grid.datagrid("deleteRow",pageSize - 1);
							}
							grid.datagrid("insertRow",{
								index:0,
								row:item
							});
							++recCount;
						}
					});
					onLoadSuccess();
				}
				else{
					grid.datagrid("loadData",data.records);
					grid.datagrid("selectRow",0);
					if(data.tempVarsForClient && data.tempVarsForClient["record_count"]){
						recCount = parseInt(data.tempVarsForClient["record_count"]);
					}
				}				
				pager.pagination("refresh", {
					pageSize: pageSize,
					total: recCount,
					pageNumber: page
				});					
				if(!showed){
					dialog.dialog("open");
					showed = true;
				}
				if(page == 1 && !closed){
					window.setTimeout(function(){
						query(false);
					},300);
				}
				locked = false;
			},
			onError:function(error){
				if(page == 1 && !closed){
					window.setTimeout(function(){
						query(false);
					},300);
				}
				locked = false;
			}
		});
	}
}
const DSMonitorManager = function(){
	let closed = false;
	function close(){
		closed = true;
		if(configDialog){
			configDialog.dialog("destroy");
			configDialog = null;
		}
		if(logDialog){
			logDialog.close();
			logDialog = null;
		}
	}
	this.close = close;
	
	let grid, girdStatusMgr, configDialog;
	(function(){
		grid = $("#panelDSMonitorManager");
		grid.datagrid({
			border: false,
			fit: true,
			singleSelect: true,
			loadMsg: false,
			pagination:false,
			toolbar: [{
				text:"Add Data Source Monitoring",
				handler:addDataSourceMonitoring
			},"-",{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					query();
				}	
			},{
				text:"Help",
				iconCls:"toolbar-button-icon icon-help-20",
				handler:function(){
					window.open("https://www.sqlmessenger.com/manual/plugin-2-interface-table-config.htm");
				}
			},{
				text:"Exit",
				iconCls:"toolbar-button-icon icon-exit-20",
				handler:function(){
					mainTabs.tabs("close",dsMonitorManagerPanel.title);
				}
			}],
			rownumbers:true,
			rowStyler:rowStyler,
			columns:[[{
				field:"data_source_id",
				title:"DataSourceID",
				width:100,
				halign:"center"
			},{
				field:"data_source_name",
				title:"DataSourceName",
				width:150,
				halign:"center",
				formatter: function(value, row, index){
					let name = HTMLEncode(value); 
					if(row.state == "X"){
						return name;
					}
					else{
						return `<span class="link btnEdit" configid="${row.config_id}">${name}</span>`;
					}
				}
			},{
				field:"polling_interval",
				title:"PollingInterval",
				width:110,
				halign:"center",
				align:"right",
				formatter: function(value, row, index){
					return value + " second(s)";
				}
			},{
				field:"create_time",
				title:"CreatedTime",
				width:140,
				align:"center"
			},{
				field:"state",
				title:"State",
				width:50,
				align:"center",
				formatter: function(value, row, index){
					let rst = "";
					switch(value){
					case "A":
						rst = "<span class='status-icon icon-useable' title='Enabled'></span>";
						break;
					case "D":
						rst = "<span class='status-icon icon-disabled' title='Disabled'></span>";
						break;
					case "X":
						rst = "<span class='status-icon icon-deleted' title='Deleted'></span>";
						break;
					default:
						rst = value;
						break;
					}
					return rst;
				}
			},{
				field:"state_time",
				title:"StateTime",
				width:140,
				align:"center"
			},{
				field:"last_polling_time",
				title:"LastPollingTime",
				width:140,
				align:"center"
			},{
				field:"last_polling_state",
				title:"PollingState",
				width:80,
				align:"center",
				formatter: function(value, row, index){					
					let rst = "";
					switch(value){
					case "W":
						rst = `<span class="link btnViewTaskInstLog" configid='${row.config_id}'>Pending</span>`;
						break;
					case "C":
						rst = `<span class='status-icon tick-20 link btnViewTaskInstLog' title='Succeed' configid='${row.config_id}'></span>`;
						break;
					case "E":
						rst = `<span class="link btnViewTaskInstLog" style='color:red;' configid='${row.config_id}'>Error</span>`;
						break;
					case "F":
						rst = `<span class="link btnViewTaskInstLog" style='color:red;' configid='${row.config_id}'>Falied</span>`;
						break;
					case "R":
						rst = `<span class="link btnViewTaskInstLog" title="Running" configid='${row.config_id}'><img src="images/waiting.gif"></span>`;
						break;
					default:
						rst = value;
						break;
					}
					return rst;
				}
			},{
				field:"last_polling_message_count",
				title:"LastPollingCount",
				width:130,
				halign:"center",
				align:"right"
			},{
				field:"last_polling_result",
				title:"LastPollingResult",
				width:250,
				halign:"center",
				formatter: function(value, row, index){
					return `<span class="link btnViewResultText" configid='${row.config_id}'>${HTMLEncode(value)}</span>`;
				}
			},{
				field:"actions",
				title:"Actions",
				width:130,
				align:"center",
				formatter: function(value, row, index){
					if(row.state == "X"){
						return `<span class='btnLog grid-menu-icon' title="View log" dsid='${row.data_source_id}'><span class='menu-button-icon btn-log'></span></span><span class='grid-menu-icon btnUndelete' title='Undelete' configid='${row.config_id}'><span class='menu-button-icon btn-undelete'></span></span>`;
					}
					else{
						let rst = `<span class='btnLog grid-menu-icon' title="View log" dsid='${row.data_source_id}'><span class='menu-button-icon btn-log'></span></span><span class='grid-menu-icon btnEdit' title='Edit' configid='${row.config_id}'><span class='menu-button-icon btn-edit'></span></span>`;
						if(row.state == "A"){
							rst += `<span class='grid-menu-icon btnDisable' title='Disable this bot' configid='${row.config_id}'><span class='menu-button-icon btn-stop'></span></span>`;
						}
						else{
							rst += `<span class='grid-menu-icon btnEnable' title='Enable this bot' configid='${row.config_id}'><span class='menu-button-icon btn-enable'></span></span>`;
						}
						rst += `<span class='btnDelete grid-menu-icon' title='Delete this bot' configid='${row.config_id}'><span class='menu-button-icon btn-delete'></span></span>`;
						return rst;
					}
				}
			}]],
			onLoadSuccess:onLoadSuccess
		});
		girdStatusMgr = GridStatusMgr({
			grid:grid,
			idField:"data_source_id"
		});				
	})();

	function onLoadSuccess(){
		let parent = grid.parent();
		let objs = parent.find(".btnEdit").not(".bound");
		objs.click(editDataSourceMonitoring);
		objs.addClass("bound");

		objs = parent.find(".btnDisable,.btnEnable").not(".bound");
		objs.click(updateConfigState);
		objs.addClass("bound");

		objs = parent.find(".btnDelete,.btnUndelete").not(".bound");
		objs.click(deleteConfig);
		objs.addClass("bound");

		objs = parent.find(".btnViewTaskInstLog").not(".bound");
		objs.click(viewTaskInstLog);
		objs.addClass("bound");

		objs = parent.find(".btnViewResultText").not(".bound");
		objs.click(viewResultText);
		objs.addClass("bound");

		objs = parent.find(".btnLog").not(".bound");
		objs.click(viewLog);
		objs.addClass("bound");
	}
	let logDialog;
	function viewLog(){
		let dataSourceId = $(this).attr("dsid");
		if(!logDialog){
			logDialog = new DataSourceMonitorLogDialog();
		}
		logDialog.show({
			dataSourceId:dataSourceId
		});
	}

	function viewResultText(){
		let configId = $(this).attr("configid");
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"config_id",configId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];
		$.messager.alert({
			msg:HTMLEncode(row.last_polling_result),
			width:500,
			icon:row.last_polling_state == "F"?"warn":"info",
			title:"Last Polling Result"
		});
	}

	function viewTaskInstLog(){
		let configId = $(this).attr("configid");		
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"config_id",configId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];		
		let taskInstId = row.last_polling_task_inst_id;		
		if(!taskInstId || taskInstId == "0"){
			return;
		}
		let pollingState = row.last_polling_state;		
		window.top.showTaskInstLog({
			taskInstId:parseInt(taskInstId),
			dialogId:$(window.frameElement).attr("dialogid"),
			autoRefresh: pollingState == "W" || pollingState == "R"
		});
	}
		

	function deleteConfig(){
		let configId = $(this).attr("configid");
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"config_id",configId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];
		let newState;
		if(row.state == "X"){
			newState = row.oldState;
		}
		else{
			newState = "X";
			row.oldState = row.state;
		}
		callService({
			commandName: "UpdateMonitoringDataSourceState",
			parameters:{
				"config_id":configId,
				"new_state":newState
			},
			onSuccess: function(data){
				grid.datagrid("updateRow",{
					index:rowIndex,
					row:data.records[0]
				});
				onLoadSuccess();
				UpdateTaskStateForDataSourceMonitor(data);
			}
		});
	}

	function updateConfigState(){
		let configId = $(this).attr("configid");
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"config_id",configId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];
		if(row.state == "X"){
			return;
		}
		let newState;
		if(row.state == "A"){
			newState = "D";
		}
		else{
			newState = "A";
		}
		callService({
			commandName: "UpdateMonitoringDataSourceState",
			parameters:{
				"config_id":configId,
				"new_state":newState
			},
			onSuccess: function(data){
				grid.datagrid("updateRow",{
					index:rowIndex,
					row:data.records[0]
				});
				onLoadSuccess();
				UpdateTaskStateForDataSourceMonitor(data);
			}
		});
	}

	let lstDataSource, txtPollingInterval;
	function createConfigDialog(){
		if(!configDialog){
			configDialog = $(`
<div style="padding:5px;">
	<table class='dialog_ctrl_list'>
	<tr><td class="ctrlLabel">DataSource</td><td><span id='lstDataSource' style="width:400px;"></span>&nbsp;<span id="btnRefreshDS"></span></td></tr>
	<tr><td class="ctrlLabel">Polling Interval</td><td><span id='txtPollingInterval' style="width:400px;"></span>&nbsp;Seconds</td></tr>
	</table>
</div>`);
			configDialog.dialog({
				title:"Data Sources Monitoring Configuration",
				width:650,
				height:300,
				closed:true,
				modal:true,
				buttons:[{
					text:"OK",
					width:80,
					handler:onOK
				},{
					text:"Cancel",
					width:80,
					handler:function(){
						configDialog.dialog("close");
					}	
				}]
			});
			createHelpButton20(configDialog,"https://www.sqlmessenger.com/manual/plugin-2-interface-table-config.htm#part2");
			lstDataSource = configDialog.find("#lstDataSource");
			lstDataSource.combobox({
				textField:"data_source_name",
				valueField:"data_source_id",
				editable:false
			});
			txtPollingInterval = configDialog.find("#txtPollingInterval");
			txtPollingInterval.textbox({
				prompt:"30"
			});
			txtPollingInterval.textbox("textbox").prop("maxlength",5);
			configDialog.find("#btnRefreshDS").linkbutton({
				width:25,
				height:22,
				iconCls:"toolbar-button-icon icon-refresh",
				onClick:function(){
					quertDataSourceList(1);
				}
			});
			quertDataSourceList();
		}
	}

	function quertDataSourceList(p){
		callService({
			commandName: "QueryDataSourceList",
			onSuccess: function(data){
				lstDataSource.combobox("loadData",data.records);
				if(p){
					showAlert("Data source list refreshed");
				}
			}
		});
	}
	let editingConfigId;
	function addDataSourceMonitoring(){
		editingConfigId = 0;
		if(!configDialog){
			createConfigDialog();
		}
		lstDataSource.combobox("clear");
		txtPollingInterval.textbox("setValue","");
		configDialog.dialog("open");		
	}

	function editDataSourceMonitoring(){
		let configId = $(this).attr("configid");
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"config_id",configId);
		if(rowIndex < 0){
			return;
		}
		let row = rows[rowIndex];
		if(rows[rowIndex] == "X"){
			return;
		}
		if(!configDialog){
			createConfigDialog();
		}
		editingConfigId = parseInt(configId);
		lstDataSource.combobox("setValue",row.data_source_id);
		txtPollingInterval.textbox("setValue",row.polling_interval);
		configDialog.dialog("open");		
	}

	function query(){
		girdStatusMgr.beforeQuery();
		callService({
			commandName: "QueryMonitoringDataSourceList",
			onSuccess: function(data){			
				grid.datagrid("loadData",data.records);
				girdStatusMgr.afterQuery();
				queryDSMonitorStatus();
			}
		});		
	}

	function onOK(){
		let dataSourceId = lstDataSource.combobox("getValue");
		if(!dataSourceId){
			showAlert("Please select a data source");
			lstDataSource.combobox("showPanel");
			return;
		}
		let pollingInterval = txtPollingInterval.textbox("getValue");
		if(pollingInterval){
			pollingInterval = parseInt(pollingInterval);
			if(isNaN(pollingInterval) || pollingInterval < 5){
				$.messager.alert({
					title:"Note",
					msg:"Polling Interval must be a number greater than or equal to 5",
					icon:"info",
					width:400,
					fn:function(){
						txtPollingInterval.textbox("textbox").focus();
					}
				});
				return;
			}
		}
		else{
			pollingInterval = 30;
		}
		if(editingConfigId){
			callService({
				commandName: "UpdateMonitoringDataSource",
				parameters:{
					"config_id":editingConfigId,
					"data_source_id":dataSourceId,
					"polling_interval":pollingInterval
				},
				onSuccess: function(data){
					let rowIndex = findItemIndexInArray(grid.datagrid("getRows"),"config_id",editingConfigId + "");					
					grid.datagrid("updateRow",{
						index:rowIndex,
						row:data.records[0]
					});
					onLoadSuccess();
					configDialog.dialog("close");
					UpdateTaskStateForDataSourceMonitor(data);
				}
			});
		}
		else{
			callService({
				commandName: "AddMonitoringDataSource",
				parameters:{
					"data_source_id":dataSourceId,
					"polling_interval":pollingInterval
				},
				onSuccess: function(data){
					grid.datagrid("appendRow",data.records[0]);
					grid.datagrid("selectRow",grid.datagrid("getRows").length - 1);
					onLoadSuccess();
					configDialog.dialog("close");
					UpdateTaskStateForDataSourceMonitor(data);
				}
			});
		}
	}
	let timerId;
	let locked;
	function queryDSMonitorStatus(){
		if(closed || locked){
			return;
		}
		locked = true;
		timerId = 0;
		let hasActiveDS = false;
		let rows = grid.datagrid("getRows");
		$.each(rows,function(index,item){
			if(item.state == "A"){
				hasActiveDS = true;
				return false;
			}
		});
		if(!hasActiveDS){
			if(!timerId){
				timerId = window.setTimeout(function(){
					queryDSMonitorStatus();
				},300);
			}
			locked = false;
			return;
		}
		sqlmessenger.helper.runSqlCommand({
			commandName: "QueryDataSourceMonitoringStatus",
			onSuccess: function(data){
				if(data.records.length > 0){
					let rows = grid.datagrid("getRows");
					$.each(data.records,function(index,item){
						let rowIndex = findItemIndexInArray(rows,"data_source_id",item.data_source_id);
						if(rowIndex > -1){
							grid.datagrid("updateRow",{
								index:rowIndex,
								row:item
							});
						}
					});
					onLoadSuccess();
				}
				if(!closed && !timerId){
					timerId = window.setTimeout(function(){
						queryDSMonitorStatus();
					},300);					
				}
				locked = false;
			},
			onError:function(error){
				if(!closed && !timerId){
					timerId = window.setTimeout(function(){
						queryDSMonitorStatus();
					},300);					
				}
				locked = false;
			}
		});
	}
	
	(function(){
		query();
	})();
}

const TelebotConfigDialog = function(){	
	let dialog = $(`<div style="padding:5px;">
	<table class='dialog_ctrl_list'>
		<tr><td class="ctrlLabel">Keep Sent Messages for </td><td><span id='txtKeepSentMessages' style="width:300px;"></span> Days</td></tr>
		<tr><td class="ctrlLabel">Keep Received Messages for </td><td><span id='txtKeepReceivedMessages' style="width:300px;"></span> Days</td></tr>
		<tr><td class="ctrlLabel">Connect to Telegram API via HTTP Proxy</td><td><span id='txtProxyServer' style="width:300px;"></span></td></tr>
	</table>
</div>`);
	function close(){
		dialog.dialog("destroy");
	}
	let txtKeepSentMessages, txtKeepReceivedMessages, txtProxyServer;
	(function(){
		dialog.dialog({
			title:"Telebot - Global Config",
			width:700,
			height:300,
			closed:true,
			modal:true,
            onClose:function(){
            	window.setTimeout(function(){
            		close();
            	},10);
			},
			buttons:[{
				text:"OK",
				width:80,
				handler:onOK
			},{
				text:"Cancel",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		txtKeepSentMessages = dialog.find("#txtKeepSentMessages");
		txtKeepSentMessages.textbox({
			prompt:"Keep Forever"
		});
		txtKeepSentMessages.textbox("textbox").prop("maxlength",5);

		txtKeepReceivedMessages = dialog.find("#txtKeepReceivedMessages");
		txtKeepReceivedMessages.textbox({
			prompt:"Keep Forever"
		});
		txtKeepReceivedMessages.textbox("textbox").prop("maxlength",5);

		txtProxyServer = dialog.find("#txtProxyServer");
		txtProxyServer.textbox({
			prompt:"Connect Without Proxy",
			buttonText:"...",
			onClickButton:function(){
				window.top.selectProxy({
					proxyServerId:proxyServerId?parseInt(proxyServerId):0,
					dialogId:$(window.frameElement).attr("dialogid"),
					callback:function(server){
						proxyServerId = server.serverId;
						if(proxyServerId == 0){
							txtProxyServer.textbox("setValue","");
						}
						else{ 
							txtProxyServer.textbox("setValue",server.ipAddr + ":" + server.port);
						}
					}
				});
			}
		});
		txtProxyServer.textbox("textbox").prop("readonly",true).css("color","blue");
	})();
	let proxyServerId;
	this.show = function(){
		callService({
			commandName: "QueryGlobalConfig",
			parameters:{
				ids:"1001,1003,1004"
			},
			onSuccess: function(data){
				let config = data.records.length > 0 && data.records[0]?data.records[0].config:null;
				if(!config){
					config = {};
				}
				else{
					config = JSON.parse(config);
				}
				txtKeepSentMessages.textbox("setValue",config["1001"]);
				txtKeepReceivedMessages.textbox("setValue",config["1003"]);
				proxyServerId = config["1004"];
				if(proxyServerId && proxyServerId != "0"){
					callService({
						commandName: "QueryProxyServerName",
						parameters:{
							proxy_server_id:proxyServerId
						},
						onSuccess: function(data){
							if(data.records.length > 0){
								txtProxyServer.textbox("setValue",data.records[0].server_name);
							}
							dialog.dialog("open");
							txtKeepSentMessages.textbox("textbox").focus();
						}
					});
				}
				else{
					dialog.dialog("open");
					txtKeepSentMessages.textbox("textbox").focus();
				}
			}
		});
	}
	function onOK(){
		let keepSentMessages = txtKeepSentMessages.textbox("getValue");
		if(keepSentMessages){
			keepSentMessages = parseInt(keepSentMessages);
			if(isNaN(keepSentMessages) || keepSentMessages <= 0){
				$.messager.alert({
					icon:"warn",
					title:"Note",
					width:450,
					msg:`The value of "Keep Sent Messages" must be a number greater than 0.`,
					fn:function(){
						txtKeepSentMessages.textbox("textbox").focus().select();
					}
				});
				return;
			}
			keepSentMessages = "" + keepSentMessages;
		}
		let keepReceivedMessages = txtKeepReceivedMessages.textbox("getValue");
		if(keepReceivedMessages){
			keepReceivedMessages = parseInt(keepReceivedMessages);
			if(isNaN(keepReceivedMessages) || keepReceivedMessages <= 0){
				$.messager.alert({
					icon:"warn",
					title:"Note",
					width:450,
					msg:`The value of "Keep Received Message " value must be a number greater than 0.`,
					fn:function(){
						txtKeepReceivedMessages.textbox("textbox").focus().select();
					}
				});
				return;
			}
			keepReceivedMessages = "" + keepReceivedMessages;
		}
		if(!proxyServerId){
			proxyServerId = "0";
		}
		
		let config = [{
			"1001":keepSentMessages,
			"1003":keepReceivedMessages,
			"1004":proxyServerId
		}];
		callService({
			commandName: "SaveGlobalConfig",
			parameters:{
				config:JSON.stringify(config)
			},
			onSuccess: function(data){
				showAlert("Global settings saved successfully");
				dialog.dialog("close");
			}
		});
	}
}

const configTelebot = function(){
	let dialog = new TelebotConfigDialog();
	dialog.show();
}

let botConfigManager, botConfigManagerPanel;
let messageQueueManager, messageQueueManagerPanel;
let fetchedMessagesManager,fetchedMessagesManagerPanel;
let chatListMessagesManager,chatListMessagesManagerPanel;
let emailForwardManager,emailForwardManagerPanel;
let emailForwardRuleManager,emailForwardRuleManagerPanel;
let dsMonitorManager,dsMonitorManagerPanel;
let batchSendTelegramMessage,batchSendTelegramMessagePanel;
const addTab = function(type,action){
	switch(type){
	case 1:
		if(botConfigManagerPanel){
			mainTabs.tabs("select",botConfigManagerPanel.title);
		}
		else{
			botConfigManagerPanel = {
				selected:true,
				title:"Bot Configuration",
				fit: true,
				content:`<div id="panelBotConfigManager"></div>`,
				closable:true,
				close:function(){
					botConfigManager.close();
					botConfigManager = null;
					botConfigManagerPanel = null;
				}
			};
			tabPanels[botConfigManagerPanel.title] = botConfigManagerPanel;	
			mainTabs.tabs("add",botConfigManagerPanel);
			botConfigManager = new BotConfigManager();
			if(action){
				botConfigManager.doAction(action);
			}
		}
		break;
	case 2:
		if(messageQueueManagerPanel){
			mainTabs.tabs("select",messageQueueManagerPanel.title);
		}
		else{
			messageQueueManagerPanel = {
				selected:true,
				title:"Message Queue",
				fit: true,
				content:`<div id="panelMessageQueueManager"></div>`,
				closable:true,
				close:function(){
					messageQueueManager.close();
					messageQueueManager = null;
					messageQueueManagerPanel = null;
				}
			};
			tabPanels[messageQueueManagerPanel.title] = messageQueueManagerPanel;	
			mainTabs.tabs("add",messageQueueManagerPanel);
			messageQueueManager = new MessageQueueManager({
				container:$("#panelMessageQueueManager"),
				showFindBtn:true
			});
		}
		break;
	case 3:
		if(fetchedMessagesManagerPanel){
			mainTabs.tabs("select",fetchedMessagesManagerPanel.title);
		}
		else{
			fetchedMessagesManagerPanel = {
				selected:true,
				title:"Received Messages",
				fit: true,
				content:`<div id="panelFetchedMessagesManager"></div>`,
				closable:true,
				close:function(){
					fetchedMessagesManager.close();
					fetchedMessagesManager = null;
					fetchedMessagesManagerPanel = null;
				}
			};
			tabPanels[fetchedMessagesManagerPanel.title] = fetchedMessagesManagerPanel;	
			mainTabs.tabs("add",fetchedMessagesManagerPanel);
			fetchedMessagesManager = new FetchedMessagesManager({
				container:$("#panelFetchedMessagesManager")
			});
		}
		break;
	case 4:
		if(chatListMessagesManagerPanel){
			mainTabs.tabs("select",chatListMessagesManagerPanel.title);
		}
		else{
			chatListMessagesManagerPanel = {
				selected:true,
				title:"Chat List Manager",
				fit: true,
				content:`<div id="panelChatListManager"></div>`,
				closable:true,
				close:function(){
					chatListMessagesManager.close();
					chatListMessagesManager = null;
					chatListMessagesManagerPanel = null;
				}
			};
			tabPanels[chatListMessagesManagerPanel.title] = chatListMessagesManagerPanel;	
			mainTabs.tabs("add",chatListMessagesManagerPanel);
			chatListMessagesManager = new ChatListMessagesManager();
		}
		break;
	case 5:
		if(emailForwardManagerPanel){
			mainTabs.tabs("select",emailForwardManagerPanel.title);
		}
		else{
			emailForwardManagerPanel = {
				selected:true,
				title:"Email Manager",
				fit: true,
				content:`<div id="panelEmailForwardManager"></div>`,
				closable:true,
				close:function(){
					emailForwardManager.close();
					emailForwardManager = null;
					emailForwardManagerPanel = null;
				}
			};
			tabPanels[emailForwardManagerPanel.title] = emailForwardManagerPanel;	
			mainTabs.tabs("add",emailForwardManagerPanel);
			emailForwardManager = new EmailForwardManager();
		}
		break;

	case 6:
		if(emailForwardRuleManagerPanel){
			mainTabs.tabs("select",emailForwardRuleManagerPanel.title);
		}
		else{
			emailForwardRuleManagerPanel = {
				selected:true,
				title:"Email Forwarding Settings",
				fit: true,
				content:`<div id="panelEmailForwardRulesManager"></div>`,
				closable:true,
				close:function(){
					emailForwardRuleManager.close();
					emailForwardRuleManager = null;
					emailForwardRuleManagerPanel = null;
				}
			};
			tabPanels[emailForwardRuleManagerPanel.title] = emailForwardRuleManagerPanel;	
			mainTabs.tabs("add",emailForwardRuleManagerPanel);
			emailForwardRuleManager = new EmailForwardRuleManager();
		}
		break;
	case 7:
		if(dsMonitorManagerPanel){
			mainTabs.tabs("select",dsMonitorManagerPanel.title);
		}
		else{
			dsMonitorManagerPanel = {
				selected:true,
				title:"Interface Table Feature Configuration",
				fit: true,
				content:`<div id="panelDSMonitorManager"></div>`,
				closable:true,
				close:function(){
					dsMonitorManager.close();
					dsMonitorManager = null;
					dsMonitorManagerPanel = null;
				}
			};
			tabPanels[dsMonitorManagerPanel.title] = dsMonitorManagerPanel;	
			mainTabs.tabs("add",dsMonitorManagerPanel);
			dsMonitorManager = new DSMonitorManager();
		}
		break;
	case 8:
		if(batchSendTelegramMessagePanel){
			mainTabs.tabs("select",batchSendTelegramMessagePanel.title);
		}
		else{
			batchSendTelegramMessagePanel = {
				selected:true,
				title:"Send Telegram Messages in Bulk",
				fit: true,
				content:`<div id="panelBatchSendTelegramMessage"></div>`,
				closable:true,
				close:function(){
					batchSendTelegramMessage.close();
					batchSendTelegramMessage = null;
					batchSendTelegramMessagePanel = null;
				}
			};
			tabPanels[batchSendTelegramMessagePanel.title] = batchSendTelegramMessagePanel;	
			mainTabs.tabs("add",batchSendTelegramMessagePanel);
			batchSendTelegramMessage = new BatchSendTelegramMessage();
		}
		break;
	}
}

const exit = function(){
	let message = {
		"command":"closePlugin",
		"dialogId":$(window.frameElement).attr("dialogid")
	};
	window.parent.postMessage("command:" + JSON.stringify(message));
}
let mainTabs;
let tabPanels = [];
const init = function(){
	mainTabs = $("#tabs");
	mainTabs.tabs({
		fit:true,
		border:false,
		onClose:function(title,index){
			let panel = tabPanels[title];
			if(panel.close)
				panel.close();
			tabPanels[title] = undefined;
		}
	});
	callService({
		commandName: "IsMessageSendingPaused",
		onSuccess: function(data){
			if(data.records[0].config_value == "1"){
				$.messager.alert({
					msg:`Message sending is currently paused in Telebot. To resume, open the "Message Queue" and click the "Resume Sending" button.`,
					title:"Note",
					icon:"warning",
					width:450
				});
			}
		}
	});
}

const rowStyler = function(index,row){
	if(row.state == "X"){
		return "color:#7d7b7b;";
	}
}
</script>

<script type="text/javascript">

const NewBatchMessageTask = function(){	
	this.close = function(){
		if(window.top.onImportFileOk){
			window.top.onImportFileOk = undefined;
		}
		dialog.dialog("destroy");
	}
	let dialog = $(`<div>
	<div id="panel1">
		<div data-options="region:'north'" style="height:40px;padding-top:0px;padding:5px;border-style:none none solid none;overflow:hidden;">
			<table class='dialog_ctrl_list'>
				<tr><td class="ctrlLabel">Excel File Name</td><td><span id='txtFileName' style="width:500px;"></span></td></tr>
			</table>
		</div>
		<div data-options="region:'center',border:false">
			<div id="grid"></div>
		</div>
	</div>
</div>`);
	let txtFileName;
	let girdStatusMgr,grid, pager;
	let page = 1;
	let pageSize = 50;
	
	(function(){
		dialog.dialog({
			title:"Send Messages in Bulk",
			width:getWindowWidth() * 0.85,
			height:getWindowHeight() * 0.95,
			closed:true,
			modal:true,
			maximizable: true,
            resizable: true,
            onClose:function(){
            	window.setTimeout(function(){
            		close();
            	},10);
			},
			buttons:[{
				id:"btnOK",
				text:"OK, Start to Send the Messages",
				handler:onOK
			},{
				text:"Cancel",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		dialog.dialog("window").find("#btnOK").find(".l-btn-text").css({
			"color":"#3b140b",
			"font-weight":"bold"
		});
		dialog.find("#panel1").layout({
			fit:true
		});
		txtFileName = dialog.find("#txtFileName");
		txtFileName.textbox({
			buttonText:"Choose Message List File",
			onClickButton:importFile
		});
		txtFileName.textbox("textbox").css("color","blue").prop("readonly",true);
		
		grid = dialog.find("#grid");
		grid.datagrid({
			border: false,
			fit: true,
			singleSelect: true,
			loadMsg: false,
			pagination:true,
			toolbar: [{
				text:"Refresh",
				iconCls:"toolbar-button-icon icon-refresh",
				handler:function(){
					queryMessageList();
				}	
			},{
				text:"Help",
				iconCls:"toolbar-button-icon icon-help-20",
				handler:function(){
					window.open("https://www.sqlmessenger.com/manual/plugin-2-send-messages-in-bulk.htm");
				}
			}],
			rownumbers:false,
			rowStyler:rowStyler,
			columns:[[{
				field:"row_index",
				title:"RowIndex",
				width:100,
				halign:"center"
			},{
				field:"bot_id",
				title:"BotID",
				width:100,
				halign:"center"
			},{
				field:"bot_user_name",
				title:"BotUsername",
				width:150,
				halign:"center"
			},{
				field:"to_chat_id",
				title:"ToChatID",
				width:150,
				halign:"center"
			},{
				field:"to_user_name",
				title:"ToUsername",
				width:110,
				halign:"center"
			},{
				field:"message_type",
				title:"MessageType",
				width:110,
				halign:"center"
			},{
				field:"message_text",
				title:"MessageText",
				width:200,
				halign:"center",
				formatter: function(value, row, index){
					return `<span class="link btnViewMessage" batch_message_id=${row.batch_message_id}>${HTMLEncode(value)}</span>`;
				}					
			},{
				field:"attach_file_name",
				title:"AttachFileName",
				width:200,
				halign:"center"
			},{
				field:"parse_mode",
				title:"ParseMode",
				width:90,
				halign:"center"
			}]],
			onLoadSuccess:onLoadSuccess
		});
		girdStatusMgr = GridStatusMgr({
			grid:grid,
			idField:"rule_id"
		});
		pager = grid.datagrid("getPager");
		pager.pagination({
			total: 0,
			pageSize: pageSize,
			pageList: [10, 50, 100, 300, 500],
			onChangePageSize: function(newPageSize){
				pageSize = newPageSize;
				recCount = -1;
				queryMessageList();
			},
			onSelectPage: function(pageNumber, pageSize){			
				page = pageNumber < 1 ? 1 : pageNumber;				
				queryMessageList();
			}
		});	
	})();
	
	function onLoadSuccess(){
		let parent = grid.parent();
		let objs = parent.find(".btnViewMessage").not(".bound");
		objs.click(viewMessage);
		objs.addClass("bound");
	}
	function viewMessage(){
		let batchMessageId = $(this).attr("batch_message_id");
		callService({
			commandName: "QueryBatchMessageDetails",
			parameters:{
				message_id:batchMessageId
			},
			onSuccess: function(data){
				if(data.records.length > 0){
					showObjectDetails({
						title:"Message Details",
						data:data.records[0]
					});
				}
			}
		});
		
	}
	window.top["onImportFileOk"] = function(taskDialog){
		callService({
			commandName: "QueryBatchMessageRequest",
			parameters:{
				oper_uuid:tempUUID
			},
			onSuccess: function(data){
				if(data.records.length == 0){
					window.top.MessageBox({
						parentWindow:dialog,
						message:`No file selected. Please choose a message list file and click the "Import" button`,
						icon:"info"
					});
				}
				else{
					let requestInfo = data.records[0];					
					if(requestInfo.rec_count == "0"){
						window.top.MessageBox({
							parentWindow:dialog,
							message:`The message list in the selected file is empty. Please check.`,
							icon:"warn"
						});
						return;
					}
					txtFileName.textbox("setValue",requestInfo.file_name);
					operUUID = tempUUID;
					requestId = requestInfo.request_id;
					window.top.showDlg(taskDialog,false);
					recCount = parseInt(requestInfo.rec_count);
					page = 1;
					if(!showed){
						dialog.dialog("open");
						showed = true;
					}
					queryMessageList();
				}
			},
			onError:function(errorMsg){
				window.top.MessageBox({
					parentWindow:taskDialog,
					message:errorMsg,
					icon:"error"
				});
			}
		});
		return false;
	}
	function queryMessageList(){
		girdStatusMgr.beforeQuery();
		callService({
			commandName: "QueryBatchMessageList",
			parameters:{
				request_id:requestId,
				recCount:recCount,
				page:page,
				pageSize:pageSize,
			},
			onSuccess: function(data){
				grid.datagrid("loadData",data.records);
				if(data.tempVarsForClient && data.tempVarsForClient["record_count"]){
					recCount = parseInt(data.tempVarsForClient["record_count"]);
				}
				pager.pagination("refresh", {
					pageSize: pageSize,
					total: recCount,
					pageNumber: page
				});
				girdStatusMgr.afterQuery();
				if(!bulkMessageTipShowed){
					$.messager.alert({
						msg:`The message list has been imported. Please verify the contents and initiate delivery by clicking "OK, Start to Send the Messages".`,
						width:450,
						title:"Tip",
						icon:"info"
					});
					bulkMessageTipShowed = true;
				}
			}
		});
	}
	
	let operUUID,tempUUID, requestId;
	function importFile(){		
		tempUUID = generateUUID();
		let welcomeCode = `
		<div style=""height: 100%;display: flex;align-items: center;justify-content: center;font-size: 22px;line-height:25px;"">
		<div style=""width:90%;"">
		<div style=""font-weight:bold;text-align:center;"">Welcome!</div>
		<div>&nbsp;</div>
		<div style=""display:list-item;"">Please select the message list file (right side of the dialog) and click 'OK'.</div>
		<div style=""text-align: center;padding-top: 10px;""><img src=""https://www.sqlmessenger.com/manual/images/plugin-2/p2-13.png"" style=""width:70%;""></div>
		<div>&nbsp;</div>
		<div style=""display:list-item;"">If this is your first time using this feature, <a href=""https://www.sqlmessenger.com/resource/MessageListTemplate.xlsx"" target=""_blank"">click here to download the Excel template</a>.</div>
		<div>&nbsp;</div>
		<div style=""display:list-item;"">If you're unsure how to use Telebot's bulk messaging feature, <a href=""https://www.sqlmessenger.com/manual/plugin-2-send-messages-in-bulk.htm"" target=""_blank"">click here to view the help documentation.</a></div>
		</div>
	</div>`;
		let message = {
			"command":"runTask",
			"taskName":"Telebot_ImportMessagesList",
			"dialogId":$(window.frameElement).attr("dialogid"),
			"values":`operUUID:"${tempUUID}"`,
			"options":`buttonRunCaption:"OK",btnOKCancel:false,showToolbar:false,
onOk:onImportFileOk,doOKOnFinsih:true,queryPanelCaption:"Import Message List",hideFields:["OperUUID"],welcomeCode:"${welcomeCode}"`
		};
		window.parent.postMessage("command:" + JSON.stringify(message));
	}
	let callback, showed;
	this.show = function(params){
		requestId = null;
		operUUID = null;
		tempUUID = null;
		callback = params.callback;
		grid.datagrid("loadData",[]);
		txtFileName.textbox("setValue","");
		showed = false;
		importFile();
	}
	
	function onOK(){
		if(!operUUID){
			$.messager.alert({
				msg:`Please click the "Select File" button to import the message list to be sent.`,
				title:"Note",
				icon:"info",
				width:450
			});
			return;
		}
		$.messager.confirm({
			msg:`Do you want to start sending these messages? (Total: ${recCount} message(s))`,
			icon:"question",
			title:"Question",
			width:450,
			fn:function(r){
				if(r){
					callService({
						commandName: "StartBatchMessageJob",
						parameters:{
							request_id:requestId
						},
						onSuccess: function(data){
							showAlert("The messages in the list have been added to the sending queue.");
							dialog.dialog("close");
							callback.apply(this,[requestId]);													
						}
					});
				}
			}
		});
	}
}

const MessageQueueDialog = function(){
	let dialog = $(`<div>
	<div id="grid"></div>
</div>`);
	
	this.close = function(){
		if(messageQueueManager){
			messageQueueManager.close();
			messageQueueManager = null;
		}
	}
	let messageQueueManager;
	(function(){
		dialog.dialog({
			title:"Message List",
			width:getWindowWidth(),
			height:getWindowHeight() * 0.98,
			closed:true,
			modal:true,
			maximizable: true,
			maximized:false,
            resizable: true,
			buttons:[{
				text:"Close",
				width:80,
				handler:function(){
					dialog.dialog("close");
				}	
			}]
		});
		messageQueueManager = new MessageQueueManager({
			container:dialog.find("#grid"),
			inDialog:true,
			parentDialog:dialog
		});
	})();
	
	this.show = function(params){
		messageQueueManager.setRequestId(params.requestId);
		messageQueueManager.setStatusType(params.statusType);
		messageQueueManager.setShowDeleted(params.showDeleted === true?params.showDeleted:false);
		messageQueueManager.setOrder(params.order);		
		messageQueueManager.requery();
		dialog.dialog("open");
	}
}

const BatchSendTelegramMessage = function(){
	let panel = $(`
	    <div class="header" style="padding-top:100px;">
	        <h1>Send Telegram Messages in Bulk</h1>
	    </div>
	    <div class="dashboard" style="grid-template-columns:repeat(3, 1fr);">
	        <!-- New Message -->
	        <div class="card new-message" id="btnNewMessage">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
		                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
	                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/>
	                </svg>
	            </div>
	            <h3>Send Messages in Bulk</h3>
	            <p>Create a new job to send messages in bulk</p>
	        </div>
	        
	        <div class="card history" id="btnJobList">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
	                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
	                </svg>
	            </div>
	            <h3>Job List</h3>
	            <p>View bulk jobs</p>
	        </div>
	        <!-- Exit -->
	        <div class="card exit" onclick="mainTabs.tabs('close',batchSendTelegramMessagePanel.title);">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
	                    <path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
	                </svg>
	            </div>
	            <h3>Exit</h3>
	            <p>Exit the bulk message sending interface</p>
	        </div>
	 `);
	let container = $("#panelBatchSendTelegramMessage");
	container.append(panel);
	let newBatchMessageTask;
	let messageQueueDialog;
	this.close = function(){
		closed = true;
		if(newBatchMessageTask){
			newBatchMessageTask.close();
			newBatchMessageTask = null;
		}
		if(messageQueueDialog){
			messageQueueDialog.close();
			messageQueueDialog = null;
		}
	};
	
	(function(){
		let btn = panel.find("#btnNewMessage");
		btn.click(newTask);
		btn = panel.find("#btnJobList");
		btn.click(openJobList);
		
	})();
	let mode = 1;
	let girdStatusMgr,grid, pager;
	let recCount = -1;
	let page = 1;
	let pageSize = 50;
	let activeRequestId;
	function openJobList(params){
		activeRequestId = params && params.curRequestId?params.curRequestId:null;
		if(mode == 1){
			panel.detach();
			container.append(`
					<div data-options="region:'center'" style="border-style:none none none solid;">
						<div id="requestGrid"></div>
					</div>
					<div data-options="region:'west',border:false" style="width:200px;">						
					</div>
				`);
			container.layout({
				fit:true
			});
			container.layout("panel","west").append(panel);
			container.find(".dashboard").css({
				"grid-template-columns":"auto",
				"padding-top":"30px"
			});
			container.find(".header").hide();
			grid = container.find("#requestGrid");
			grid.datagrid({
				border: false,
				fit: true,
				singleSelect: false,
				ctrlSelect:true,
				loadMsg: false,
				pagination:true,
				toolbar: [{
					text:"Refresh",
					iconCls:"toolbar-button-icon icon-refresh",
					handler:function(){
						recCount = -1;
						page = 1;
						queryRequestList();
					}	
				},"-",{
					text:"Delete",
					iconCls:"toolbar-button-icon delete-message",
					handler:function(){
						deleteSelectedJobs();
					}	
				},"-",{
					text:"Help",
					iconCls:"toolbar-button-icon icon-help-20",
					handler:function(){
						window.open("https://www.sqlmessenger.com/manual/plugin-2-send-messages-in-bulk.htm");
					}
				},{
					text:"Exit",
					iconCls:"toolbar-button-icon icon-exit-20",
					handler:function(){
						mainTabs.tabs("close",batchSendTelegramMessagePanel.title);
					}
				}],
				rownumbers:true,
				rowStyler:rowStyler,
				columns:[[{
					field:"X",					
					checkbox:true
				},{
					field:"request_id",
					title:"JobID",
					width:60,
					halign:"center"
				},{
					field:"file_name",
					title:"FileName",
					width:200,
					halign:"center"
				},{
					field:"rec_count",
					title:"RecordCount",
					width:100,
					halign:"center",
					formatter: function(value, row, index){
						return `<div class="link btnQueryMessageList" title="Click to view message list" requestid="${row.request_id}" statustype="1">${value}</div>`;
					}
				},{
					field:"succ_rec_count",
					title:"Sent",
					width:100,
					halign:"center",
					formatter: function(value, row, index){
						return `<div class="link btnQueryMessageList" title="Click to view message list" requestid="${row.request_id}" statustype="2">${value}</div>`;
					}
				},{
					field:"fail_rec_count",
					title:"Failed",
					width:100,
					halign:"center",
					formatter: function(value, row, index){
						let style = "";
						if(value != "0")
							style = `style="color:red;"`;
						return `<div class="link btnQueryMessageList" ${style} title="Click to view message list" requestid="${row.request_id}" statustype="3">${value}</div>`;
					}
				},{
					field:"dele_rec_count",
					title:"Cancelled",
					width:100,
					halign:"center",
					formatter: function(value, row, index){
						let style = "";
						if(value != "0")
							style = `style="color:red;"`;
						return `<div class="link btnQueryMessageList" ${style} title="Click to view message list" requestid="${row.request_id}" statustype="4">${value}</div>`;
					}
				},{
					field:"create_time",
					title:"CreatedTime",
					width:140,
					align:"center"
				},{
					field:"state",
					title:"Status",
					width:80,
					align:"center",
					formatter: function(value, row, index){
						let rst = "";
						switch(value){
						case "C":
							if(row.fail_rec_count != "0" || row.dele_rec_count != "0")
								rst = `<span class='status-icon icon-warn-20 link btnQueryMessageList' requestid="${row.request_id}" statustype="5" title='Job completed, but not all messages were sent successfully'></span>`;
							else
								rst = `<span class='status-icon tick-20' title='${messageStatusDefine[value]}'></span>`;
							break;
						case "R":
							rst = `<span title="Sending"><img src="images/waiting.gif"></span>`;
							break;
						case "X":
							rst = "<span class='status-icon icon-deleted' title='Deleted'></span>";
							break;
						default:
							rst = value;
							break;
						}
						return rst;
					}
				},{
					field:"state_time",
					title:"StatusTime",
					width:140,
					align:"center"
				}]],
				onLoadSuccess:onLoadSuccess
			});
			girdStatusMgr = GridStatusMgr({
				grid:grid,
				idField:"request_id"
			});
			pager = grid.datagrid("getPager");
			pager.pagination({
				total: 0,
				pageSize: pageSize,
				pageList: [10, 50, 100, 300, 500],
				onChangePageSize: function(newPageSize){
					pageSize = newPageSize;
					recCount = -1;
					queryRequestList();
				},
				onSelectPage: function(pageNumber, pageSize){			
					page = pageNumber < 1 ? 1 : pageNumber;				
					queryRequestList();
				}
			});
			queryRequestList();
			mode = 2;
		}
		else{
			queryRequestList();
		}
	}
	function onLoadSuccess(){
		let parent = grid.parent();
		let objs = parent.find(".btnQueryMessageList").not(".bound");
		objs.click(showMessageList);
		objs.addClass("bound");
	}
	function deleteSelectedJobs(){		
		let rows = grid.datagrid("getSelections");
		if(rows.length == 0){
			return;
		}
		let ids = [];
		$.each(rows,function(index,item){
			if(item.state != "X")
				ids.push(item.request_id);
		});
		if(ids.length == 0)
			return;
		$.messager.confirm({
			msg:`<div>Are you sure you want to delete the ${ids.length} selected job(s)?</div>
			<div>(Note: Any unsent messages in these jobs will be canceled.)</div>
			`,
			icon:"warn",
			title:"Question",
			width:450,
			fn:function(r){
				if(!r){
					return;
				}				
				callService({
					commandName: "DeleteBatchMessageRequests",
					parameters:{
						ids:JSON.stringify(ids)
					},
					onSuccess: function(data){
						let rows = grid.datagrid("getRows");
						$.each(data.records,function(index,item){
							let rowIndex = findItemIndexInArray(rows,"request_id",item.request_id);
							if(rowIndex > -1){
								grid.datagrid("updateRow",{
									index:rowIndex,
									row:item
								});
							}
						});
						onLoadSuccess();
						showAlert("Job(s) deleted");						
					}
				});
			}
		});
	}
	let showingRequestId;
	function showMessageList(id){
		let requestId,statusType;		
		if(typeof(id) == "string"){
			requestId = id;
			statusType = 1;
		}
		else{
			let obj = $(this);
			requestId = obj.attr("requestid");
			statusType = parseInt(obj.attr("statustype"));
		}
		let rows = grid.datagrid("getRows");
		let rowIndex = findItemIndexInArray(rows,"request_id",requestId);
		if(rowIndex < 0){
			return;
		}
		//1:All Records
		//2:Succeed Records
		//3:Failed Records
		//4:Deleted Records
		//4:Both Failed and Deleted
		let statusList;
		let showDeleted = false;
		switch(statusType){
		case 2:
			statusList = ["C"];
			break;
		case 3:
			statusList = ["F","P"];
			break;
		case 4:
			statusList = ["FX"];	//state <> 'C' AND record_state = 'X'
			showDeleted = true;
			break;
		case 5:
			statusList = ["F","P","FX"];
			showDeleted = true;
			break;
		}
		if(!messageQueueDialog){
			messageQueueDialog = new MessageQueueDialog();
		}
		showingRequestId = requestId;
		messageQueueDialog.show({
			requestId:requestId,
			statusType:statusList,
			showDeleted:showDeleted
		});
	}
	
	let closed = false,locked = false,timerId = 0;
	function queryJobStatus(){
		if(closed || locked){
			return;
		}
		locked = true;
		timerId = 0;
		let rows = grid.datagrid("getRows");
		let jobs = [];
		$.each(rows,function(index,item){
			if(item.state == "R"){
				jobs.push({
					request_id:item.request_id,
					send_status_time:item.send_status_time
				});
			}
		});
		if(jobs.length == 0){
			locked = false;
			return;
		}
		sqlmessenger.helper.runSqlCommand({
			commandName: "QueryBatchMessageRequestStatus",
			parameters:{
				jobs:JSON.stringify(jobs)
			},
			onSuccess: function(data){
				if(data.records.length > 0){
					let rows = grid.datagrid("getRows");
					$.each(data.records,function(index,item){
						let rowIndex = findItemIndexInArray(rows,"request_id",item.request_id);
						if(rowIndex > -1){
							grid.datagrid("updateRow",{
								index:rowIndex,
								row:item
							});
						}
					});
					onLoadSuccess();
				}
				if(!closed && !timerId){
					timerId = window.setTimeout(function(){
						queryJobStatus();
					},300);					
				}
				locked = false;
			},
			onError:function(error){
				if(!closed && !timerId){
					timerId = window.setTimeout(function(){
						queryJobStatus();
					},300);					
				}
				locked = false;
			}
		});
	}
	
	function queryRequestList(){
		girdStatusMgr.beforeQuery();
		callService({
			commandName: "QueryBatchMessageRequestList",
			parameters:{
				recCount:recCount,
				page:page,
				pageSize:pageSize,
			},
			onSuccess: function(data){
				grid.datagrid("loadData",data.records);
				if(data.tempVarsForClient && data.tempVarsForClient["record_count"]){
					recCount = parseInt(data.tempVarsForClient["record_count"]);
				}
				pager.pagination("refresh", {
					pageSize: pageSize,
					total: recCount,
					pageNumber: page
				});
				if(curRequestId){					
					let rows = grid.datagrid("getRows");
					let rowIndex = findItemIndexInArray(rows,"request_id",curRequestId);
					if(rowIndex > -1){
						grid.datagrid("selectRow",rowIndex);
					}
					curRequestId = null;
				}
				else{
					girdStatusMgr.afterQuery();
				}
				if(activeRequestId){
					showMessageList(activeRequestId);
					activeRequestId = null;
				}
				timerId = window.setTimeout(function(){
					queryJobStatus();
				},300);
			}
		});
	}
	let curRequestId;
	function newTask(){
		if(!newBatchMessageTask){
			newBatchMessageTask = new NewBatchMessageTask();
		}
		newBatchMessageTask.show({
			callback:function(requestId){				
				curRequestId = requestId;
				recCount = -1;
				page = 1;
				openJobList({
					curRequestId:curRequestId
				});				
			}
		});
	}
}
</script>
</head>
<body onload="init();">
	<div id="tabs">		
		<div title="Telebot Manager">
			<div style="height:20px;"></div>
	    <div class="header">
	        <h1>Telebot Manager</h1>
	    </div>    
	    <div class="dashboard">
	        <!-- Bot Configuration -->
	        <div class="card bot-config" onclick="addTab(1);">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
	                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-3.5l6-4.5-6-4.5z"/>
	                </svg>
	            </div>
	            <h3>Bot Configuration</h3>
	            <p>Configure your Telegram bots</p>
	        </div>
	        <div class="card db-config" onclick="addTab(7);">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
	                    <path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4zm0 6c-3.87 0-7-1.34-7-3s3.13-3 7-3 7 1.34 7 3-3.13 3-7 3zm0 1c3.87 0 7 1.34 7 3v1c0 1.66-3.13 3-7 3s-7-1.34-7-3v-1c0-1.66 3.13-3 7-3zm0-5c4.42 0 8 1.79 8 4v6c0 2.21-3.58 4-8 4s-8-1.79-8-4V7c0-2.21 3.58-4 8-4z"/>
	                </svg>
	            </div>
	            <h3>Interface Table Feature Configuration</h3>
	            <p>Configure interface table feature</p>
	        </div>        
	        <!-- Email to Telegram -->
	        <div class="card email-to-telegram" onclick="addTab(6);">
	            <div class="icon" style="background-color:#fff8e1;">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
		                <path d="M20 8l-8 5-8-5v10h16zm0-2H4l8 4.99z" opacity=".3"></path>
		                <path d="M4 20h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2zM20 6l-8 4.99L4 6h16zM4 8l8 5 8-5v10H4V8z"></path>
		            </svg>
	            </div>
	            <h3>Email Forwarding Settings</h3>
	            <p>Configure email forwarding rules</p>
	        </div>	        
	        <!-- Chat Management -->
	        <div class="card chat-manage" onclick="addTab(4);">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
	                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
	                    <path d="M7 9h10v2H7zm0 3h7v2H7z"/>
	                </svg>
	            </div>
	            <h3>Chat List Manager</h3>
	            <p>Manage chats and channels</p>
	        </div>	        
	        <!-- Send Message Management -->
	        <div class="card send-msg" onclick="addTab(2);">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
	                    <path d="M4 4h16v12H5.17L4 17.17V4m0-2c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4zm2 10h12v2H6v-2zm0-3h12v2H6V9zm0-3h12v2H6V6z"/>
	                </svg>
	            </div>
	            <h3>Message Queue</h3>
	            <p>Manage outgoing messages</p>
	        </div>
	        
	        <!-- Receive Message Management -->
	        <div class="card receive-msg" onclick="addTab(3);">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
	                    <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"/>
	                </svg>
	            </div>
	            <h3>Received Messages</h3>
	            <p>View and manage received messages</p>
	        </div>
	        
	        

	

	        
	         <div class="card email-to-telegram" onclick="addTab(5);">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
	                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"></path>
	                </svg>
	            </div>
	            <h3>Email Manager</h3>
	            <p>Manage processed emails in Telebot</p>
	        </div>
	        <div class="card batch-send" onclick="addTab(8);">
	            <div class="icon">
	                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
	                    <path d="M4 4h16v12H5.17L4 17.17V4m0-2c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4zm2 10h12v2H6v-2zm0-3h12v2H6V9zm0-3h12v2H6V6z"/>
	                </svg>
	            </div>
	            <h3>Send Messages in Bulk</h3>
	            <p>Send telegram messages in bulk</p>
	        </div>
	    </div>
		<div class="footer-buttons">
	        <div class="footer-button global-options" title="Global Config" onclick="configTelebot();" style="background-color:#e3f7ff;">
	            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
	                <path fill="#00BCD4" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
	            </svg>
	        </div>
	        <a href="https://www.sqlmessenger.com/manual/plugin-2-index.htm" target="_blank">
	        <div class="footer-button help-button" title="Help">	        	
	            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
	                <path fill="#00BCD4" d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/>
	            </svg>
	        </div>
			</a>
			<div class="footer-button exit" title="Exit" onclick="exit();" style="background-color: #ffebee;">
	            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
	                <path fill="#F44336" d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"></path>
	            </svg>
	        </div>
   		</div>	    
		</div>
	</div>
</body>
</html>
